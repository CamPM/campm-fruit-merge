<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Fruit Merge â€“ High-Fidelity Web Edition</title>

<!-- Matter.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<style>
:root {
  --bg:#121212;
  --ui:#1f1f1f;
  --gold:#ffcc33;
}

html,body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:#fff;
  font-family:system-ui, -apple-system, BlinkMacSystemFont;
  overscroll-behavior:none;
  touch-action:none;
}

canvas{
  display:block;
}

#topBar{
  height:115px;
  background:#181818;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px;
  box-sizing:border-box;
}

#bottomBar{
  height:100px;
  background:#181818;
  display:flex;
  align-items:center;
  justify-content:space-around;
}

.btn{
  background:#333;
  border-radius:14px;
  padding:10px 14px;
  font-size:18px;
  user-select:none;
}

.btn:active{
  background:#555;
}

.power{
  font-size:22px;
}

#game{
  background:#000;
}

.goldPulse{
  animation:pulse 0.8s infinite alternate;
  stroke:var(--gold);
  stroke-width:6;
}

@keyframes pulse{
  from{opacity:0.6}
  to{opacity:1}
}
</style>
</head>

<body>

<div id="topBar">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
  <div>ğŸ’° <span id="wallet">0</span></div>
  <div id="nextFruit">ğŸ’</div>
</div>

<canvas id="game"></canvas>

<div id="bottomBar">
  <div class="btn power" id="bomb">ğŸ’£</div>
  <div class="btn power" id="broom">ğŸ§¹</div>
  <div class="btn power" id="wand">âœ¨</div>
  <div class="btn" id="mute">ğŸ”Š</div>
  <div class="btn" id="help">â”</div>
  <div class="btn" id="fs">â›¶</div>
  <div class="btn" id="shop">ğŸ›’</div>
</div>

<script>
/* =========================
   CORE CONSTANTS
========================= */
const TIERS = 12;
const DROP_COOLDOWN = 500;
const DEATH_Y = 195;
const DEATH_TIME = 2000;
const BORDER = 15;

/* =========================
   SKINS (8)
========================= */
const skins = [
  ["ğŸ’","ğŸ“","ğŸ","ğŸŠ","ğŸ‹","ğŸ","ğŸ¥­","ğŸ‰","ğŸ‘","ğŸ¥¥","ğŸˆ","ğŸ‡"],
  ["ğŸŒ±","ğŸŒ¿","ğŸƒ","ğŸ€","ğŸŒµ","ğŸŒ´","ğŸŒ³","ğŸŒ²","ğŸŒ¾","ğŸŒ·","ğŸŒ¹","ğŸŒ»"],
  ["â˜ï¸","ğŸŒ§ï¸","â›ˆï¸","â„ï¸","ğŸŒªï¸","ğŸŒˆ","ğŸ”¥","ğŸŒŠ","ğŸŒ¬ï¸","â˜€ï¸","ğŸŒ™","â­"],
  ["ğŸ­","ğŸ±","ğŸ¶","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¦","ğŸ¯","ğŸµ","ğŸ¦„","ğŸ²"],
  ["ğŸ”´","ğŸŸ ","ğŸŸ¡","ğŸŸ¢","ğŸ”µ","ğŸŸ£","â¬›","â¬œ","ğŸ”¶","ğŸ”·","ğŸ”º","â­"],
  ["ğŸµ","ğŸ¶","ğŸ¼","ğŸ¹","ğŸ¥","ğŸ¸","ğŸ»","ğŸº","ğŸ·","ğŸª•","ğŸ“»","ğŸ§"],
  ["ğŸª","ğŸŒ","ğŸŒ•","â˜„ï¸","ğŸš€","ğŸ›°ï¸","ğŸ‘½","ğŸŒŒ","â­","ğŸ›¸","ğŸ§‘â€ğŸš€","ğŸ’«"],
  ["ğŸ¬","ğŸ­","ğŸ«","ğŸ©","ğŸ§","ğŸª","ğŸ°","ğŸ¦","ğŸ¨","ğŸ¡","ğŸ®","ğŸ¯"]
];

let skinIndex = 0;

/* =========================
   CANVAS + ENGINE
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight - 215;
}
resize();
addEventListener("resize", resize);

const Engine = Matter.Engine,
      World = Matter.World,
      Bodies = Matter.Bodies;

const engine = Engine.create();
engine.gravity.y = 1.1;

/* Floor */
let floor = Bodies.rectangle(
  canvas.width/2,
  canvas.height-100,
  canvas.width,
  20,
  { isStatic:true }
);

/* Walls */
let leftWall = Bodies.rectangle(BORDER/2, canvas.height/2, BORDER, canvas.height, {isStatic:true});
let rightWall = Bodies.rectangle(canvas.width-BORDER/2, canvas.height/2, BORDER, canvas.height, {isStatic:true});

World.add(engine.world,[floor,leftWall,rightWall]);

/* =========================
   AUDIO ENGINE
========================= */
let audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let muted=false;

function popSound(){
  if(muted)return;
  let o=audioCtx.createOscillator();
  let g=audioCtx.createGain();
  o.type="sine";
  o.frequency.setValueAtTime(800,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(200,audioCtx.currentTime+0.15);
  g.gain.value=0.15;
  o.connect(g).connect(audioCtx.destination);
  o.start();o.stop(audioCtx.currentTime+0.15);
}

function thudSound(){
  if(muted)return;
  let o=audioCtx.createOscillator();
  let g=audioCtx.createGain();
  o.type="triangle";
  o.frequency.value=120+(skinIndex*15);
  g.gain.value=0.2;
  o.connect(g).connect(audioCtx.destination);
  o.start();o.stop(audioCtx.currentTime+0.1);
}

/* =========================
   GAME STATE
========================= */
let fruits=[];
let lastDrop=0;
let score=0;
let best=+localStorage.best||0;
let wallet=+localStorage.wallet||0;
let nextTier=0;

/* =========================
   SPAWN
========================= */
function spawn(x){
  if(Date.now()-lastDrop<DROP_COOLDOWN)return;
  lastDrop=Date.now();

  let body=Bodies.circle(x,80,22+nextTier*2,{
    restitution:0.1,
    label:"fruit",
    tier:nextTier,
    sleepThreshold:60
  });
  body.spawnTime=Date.now();
  fruits.push(body);
  World.add(engine.world,body);

  nextTier=Math.floor(Math.random()*4);
}

/* =========================
   MERGE LOGIC
========================= */
Matter.Events.on(engine,"collisionStart",e=>{
  e.pairs.forEach(p=>{
    let a=p.bodyA,b=p.bodyB;
    if(a.label==="fruit"&&b.label==="fruit"&&a.tier===b.tier&&a.tier<TIERS-1){
      World.remove(engine.world,[a,b]);
      fruits=fruits.filter(f=>f!==a&&f!==b);
      let m=Bodies.circle(
        (a.position.x+b.position.x)/2,
        (a.position.y+b.position.y)/2,
        24+(a.tier+1)*2,
        {label:"fruit",tier:a.tier+1}
      );
      fruits.push(m);
      World.add(engine.world,m);
      score+=Math.pow(2,a.tier+1);
      wallet+=5;
      popSound();
    }
  });
});

/* =========================
   DEATH RULE
========================= */
function checkDeath(){
  fruits.forEach(f=>{
    if(f.position.y<DEATH_Y){
      if(!f.deathStart)f.deathStart=Date.now();
      if(Date.now()-f.deathStart>DEATH_TIME){
        reset();
      }
    }else f.deathStart=null;
  });
}

/* =========================
   RESET
========================= */
function reset(){
  fruits.forEach(f=>World.remove(engine.world,f));
  fruits=[];
  best=Math.max(best,score);
  score=0;
}

/* =========================
   DRAW
========================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* Death line */
  ctx.setLineDash([8,8]);
  ctx.strokeStyle="red";
  ctx.beginPath();
  ctx.moveTo(0,DEATH_Y);
  ctx.lineTo(canvas.width,DEATH_Y);
  ctx.stroke();
  ctx.setLineDash([]);

  fruits.forEach(f=>{
    ctx.beginPath();
    ctx.arc(f.position.x,f.position.y,f.circleRadius,0,Math.PI*2);
    ctx.shadowColor="rgba(255,255,255,0.5)";
    ctx.shadowBlur=10;
    ctx.fillStyle="#222";
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.font=`${f.circleRadius}px serif`;
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(skins[skinIndex][f.tier],f.position.x,f.position.y+2);
  });
}

/* =========================
   LOOP
========================= */
function loop(){
  Engine.update(engine,1000/60);
  draw();
  checkDeath();
  scoreEl.textContent=score;
  walletEl.textContent=wallet;
  bestEl.textContent=best;
  requestAnimationFrame(loop);
}
loop();

/* =========================
   INPUT
========================= */
canvas.addEventListener("touchend",e=>{
  spawn(e.changedTouches[0].clientX);
});

/* =========================
   UI
========================= */
const scoreEl=score;
const walletEl=wallet;
const bestEl=best;

document.getElementById("mute").onclick=()=>muted=!muted;
document.getElementById("fs").onclick=()=>{
  if(!document.fullscreenElement)document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};

/* =========================
   SAVE
========================= */
setInterval(()=>{
  localStorage.wallet=wallet;
  localStorage.best=best;
},1000);
</script>

</body>
</html>
