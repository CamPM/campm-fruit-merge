<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fruit Merge v1.4.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --accent: #2ecc71; --ui-bg: rgba(255,255,255,0.9); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin:0; padding:0; }
        body { overflow: hidden; font-family: 'Arial Black', sans-serif; height: 100vh; background: #f0f0f0; touch-action: none; position: fixed; }
        canvas { display: block; width: 100%; height: 100%; }
        .safe-top { position: absolute; top: env(safe-area-inset-top); width: 100%; padding: 10px 20px; z-index: 1000; pointer-events: none; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: var(--ui-bg); border: 3px solid #333; border-radius: 15px; padding: 10px; pointer-events: auto; }
        .float-util { position: absolute; top: calc(env(safe-area-inset-top) + 80px); width: 100%; display: flex; justify-content: space-between; padding: 0 20px; pointer-events: none; }
        .circ-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--ui-bg); border: 2px solid #333; display: grid; place-items: center; pointer-events: auto; font-size: 20px; }
        .bot-bar { position: absolute; bottom: 0; width: 100%; height: 100px; padding: 0 20px 20px; display: flex; justify-content: space-between; align-items: flex-end; z-index: 1000; pointer-events: none; }
        .btn-grp { display: flex; gap: 10px; pointer-events: auto; }
        .pwr-btn { width: 55px; height: 55px; border-radius: 15px; border: 3px solid #333; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; position: relative; }
        .shop-btn { width: 100px; height: 55px; background: #3498db; color: white; border-radius: 15px; border: 3px solid #333; display: grid; place-items: center; pointer-events: auto; }
        .modal { display: none; position: absolute; inset: 20px; background: white; z-index: 2000; border-radius: 20px; border: 4px solid #333; flex-direction: column; overflow: hidden; pointer-events: auto; }
        .modal.open { display: flex; }
        .modal-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 3px solid #333; }
        .modal-body { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cat-head { grid-column: 1 / -1; background: #333; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 10px; position: sticky; top: 0; z-index: 5; }
        .card { border: 2px solid #ddd; border-radius: 12px; padding: 10px; text-align: center; font-size: 12px; }
        .card.eq { border-color: var(--accent); background: #eaffea; }
        .swatch { width: 35px; height: 35px; border-radius: 50%; margin: 0 auto 5px; border: 2px solid #333; }
        .bouncy-txt { position: absolute; font-size: 32px; color: #f1c40f; text-shadow: 3px 3px #000; animation: bounceUp 0.8s ease-out forwards; pointer-events: none; z-index: 1500; font-family: 'Arial Black'; }
        @keyframes bounceUp { 0% { transform: scale(0.5) translateY(0); opacity:1; } 50% { transform: scale(1.2) translateY(-40px); } 100% { transform: scale(1) translateY(-80px); opacity:0; } }
    </style>
</head>
<body>
<div id="ui-layer">
    <div class="safe-top"><div class="top-bar"><div>SCORE<br><span id="cur-s">0</span></div><div id="next-box" style="font-size:30px"></div><div>BEST<br><span id="best-s">0</span></div></div></div>
    <div class="float-util">
        <div class="circ-btn" onclick="toggleMute()" id="m-btn">ðŸ”Š</div>
        <div style="text-align:center; pointer-events:auto;"><div id="p-bar" style="background:white; border:2px solid #333; padding:5px; border-radius:10px; font-size:12px;"></div><div id="wallet" style="color:#2ecc71; text-shadow:1px 1px #000;">$0</div></div>
        <div class="circ-btn" onclick="toggleF()">â›¶</div>
    </div>
    <div class="bot-bar">
        <div class="btn-grp">
            <div class="pwr-btn" data-t="bomb" style="background:#e67e22">ðŸ’£<small>$50</small></div>
            <div class="pwr-btn" data-t="wipe" style="background:#9b59b6">ðŸ§¹<small>$75</small></div>
            <div class="pwr-btn" data-t="evo" style="background:#f1c40f">ðŸª„<small>$150</small></div>
        </div>
        <div class="shop-btn" onclick="toggleM('shop-mod')">SHOP</div>
    </div>
</div>
<div id="shop-mod" class="modal">
    <div class="modal-header"><span>STORE ($<span id="cash">0</span>)</span><span onclick="toggleM('shop-mod')">âœ•</span></div>
    <div class="modal-body" id="shop-content"></div>
</div>
<canvas id="c"></canvas>
<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, R=M.Render;
const T_COLORS = ["#add8e6","#87cefa","#00bfff","#1e90ff","#4169e1","#0000ff","#4b0082","#8b00ff","#9400d3","#9932cc","#ba55d3","#ff00ff"];
const SKINS = { Space:["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"], Weather:["â˜ï¸","ðŸŒ¦ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒªï¸","ðŸŒ«ï¸","ðŸŒˆ","â˜€ï¸"], Ocean:["ðŸŸ","ðŸ™","ðŸ¦","ðŸ¦‘","ðŸ¡","ðŸ ","ðŸ¦ˆ","ðŸ‹","ðŸ¬","ðŸ³","ðŸš","ðŸŒŠ"], Nature:["ðŸŒ±","ðŸŒ¿","â˜˜ï¸","ðŸ„","ðŸ€","ðŸƒ","ðŸ‚","ðŸ","ðŸŒµ","ðŸŒ´","ðŸŒ²","ðŸŒ³"], Music:["ðŸª•","ðŸª—","ðŸŽ¸","ðŸŽ¹","ðŸŽº","ðŸŽ»","ðŸ¥","ðŸŽ·","ðŸŽ™ï¸","ðŸ“»","ðŸŽ§","ðŸŽµ"], Animals:["ðŸž","ðŸ¸","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","ðŸ˜","ðŸ‹"], Fruit:["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"], Dessert:["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"] };
const HARDNESS = { Space:[0.2,0.1], Weather:[0.3,0.08], Ocean:[0.4,0.05], Nature:[0.5,0.04], Music:[0.6,0.03], Animals:[0.7,0.02], Fruit:[0.5,0.02], Dessert:[0.8,0.01] };
let st = { score:0, best:0, wallet:200, muted:false, eq:{sk:'Fruit', th:'#f0f0f0', bd:'#333', ot:'#000', hb:'Tiered'}, owned:['sk_Fruit','th_#f0f0f0','bd_#333','ot_#000','hb_Tiered'], found:[0] };
let engine, canvas, ctx, W, H, nextIdx=0, curIdx=0, canDrop=true, lastX=150, activeP=null, dragP={x:0,y:0}, combo=1, lastM=0;

function init() {
    load(); canvas=document.getElementById('c'); ctx=canvas.getContext('2d');
    engine=E.create({gravity:{y:1.2}}); resize();
    M.Events.on(engine, 'collisionStart', e => {
        e.pairs.forEach(p => {
            const a=p.bodyA, b=p.bodyB;
            if(a.plugin?.t!==undefined && a.plugin.t===b.plugin.t && a.plugin.t<11) {
                const t=a.plugin.t, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
                C.remove(engine.world, [a,b]); const nf=spawnF(pos.x, pos.y, t+1, false);
                nf.sq = 1.5; combo=(Date.now()-lastM<1500)?Math.min(5, combo+1):1; lastM=Date.now();
                if(combo>1) floatT(pos.x, pos.y, combo); st.score+=(t+1)*10*combo; st.wallet+=(t+1)*20*combo;
                if(st.score>st.best) st.best=st.score; if(!st.found.includes(t+1)) st.found.push(t+1);
                updUI(); save(); playS(600);
            }
        });
    });
    setupIn(); loop(); nextIdx=Math.floor(Math.random()*5); updUI();
}

function spawnF(x,y,t,isD) {
    const h = HARDNESS[st.eq.sk];
    const b=B.circle(x,y,[18,24,30,38,46,55,65,76,88,102,118,135][t],{restitution:h[0], friction:h[1], plugin:{t:t}});
    b.sq = 1.5; C.add(engine.world, b);
    if(isD){ curIdx=nextIdx; nextIdx=Math.floor(Math.random()*5); canDrop=false; setTimeout(()=>canDrop=true, 600); updUI(); }
    return b;
}

function setupIn() {
    const getX=e=>(e.touches?e.touches[0].clientX:e.clientX), getY=e=>(e.touches?e.touches[0].clientY:e.clientY);
    window.addEventListener('touchstart', e=>{ if(e.target.dataset.t) activeP=e.target.dataset.t; });
    window.addEventListener('mousedown', e=>{ if(e.target.dataset.t) activeP=e.target.dataset.t; });
    window.addEventListener('touchmove', e=>{ if(activeP) dragP={x:getX(e),y:getY(e)}; else lastX=getX(e); });
    window.addEventListener('mousemove', e=>{ if(activeP) dragP={x:getX(e),y:getY(e)}; else lastX=getX(e); });
    window.addEventListener('touchend', e=>{ if(activeP) releaseP(dragP.x,dragP.y); else if(canDrop&&!e.target.closest('.modal')) spawnF(Math.max(40,Math.min(W-40,lastX)), 150, curIdx, true); });
    window.addEventListener('mouseup', e=>{ if(activeP) releaseP(dragP.x,dragP.y); else if(canDrop&&!e.target.closest('.modal')) spawnF(Math.max(40,Math.min(W-40,lastX)), 150, curIdx, true); });
}

function releaseP(x,y){
    const cost = activeP==='bomb'?50:activeP==='wipe'?75:150;
    if(st.wallet<cost){ activeP=null; return; }
    const bodies = C.allBodies(engine.world).filter(b=>b.plugin); let used=false;
    if(activeP==='bomb'){ bodies.forEach(b=>{ if(M.Vector.magnitude(M.Vector.sub(b.position,{x,y}))<80){ C.remove(engine.world,b); used=true; } }); }
    else { const t = bodies.find(b=>M.Bounds.contains(b.bounds,{x,y})); if(t){
        bodies.forEach(b=>{ if(b.plugin.t===t.plugin.t){ 
            if(activeP==='evo' && b.plugin.t<11) spawnF(b.position.x, b.position.y, b.plugin.t+1, false);
            C.remove(engine.world, b); used=true; 
        }});
    }}
    if(used){ st.wallet-=cost; save(); updUI(); playS(300); } activeP=null;
}

function loop() {
    E.update(engine, 16); ctx.clearRect(0,0,W,H); document.body.style.background=st.eq.th;
    ctx.fillStyle=st.eq.bd; ctx.fillRect(0,0,15,H); ctx.fillRect(W-15,0,15,H);
    C.allBodies(engine.world).forEach(b => {
        if(!b.plugin) return; ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        if(b.sq>1) b.sq -= 0.02; ctx.scale(b.sq, b.sq);
        let hb = st.eq.hb==='Tiered'?T_COLORS[b.plugin.t]+'88':st.eq.hb==='White'?'#ffffff88':st.eq.hb==='Rainbow'?`hsla(${Date.now()/10%360},70%,70%,0.5)`:'transparent';
        ctx.fillStyle=hb; ctx.beginPath(); ctx.arc(0,0,b.circleRadius,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle=st.eq.ot; ctx.lineWidth=3;
        if(activeP && (activeP==='bomb'?M.Vector.magnitude(M.Vector.sub(b.position, dragP))<80 : M.Bounds.contains(b.bounds, dragP))){
            ctx.strokeStyle=`rgba(255,215,0,${0.5+0.5*Math.sin(Date.now()/100)})`; ctx.lineWidth=6;
        }
        ctx.stroke(); ctx.font=`${b.circleRadius*1.2}px serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk][b.plugin.t], 0, 0); ctx.restore();
    });
    if(activeP){ ctx.beginPath(); ctx.setLineDash([5,5]); ctx.strokeStyle="#333";
        if(activeP==='bomb') ctx.arc(dragP.x, dragP.y, 80, 0, Math.PI*2);
        else { ctx.moveTo(dragP.x-20, dragP.y); ctx.lineTo(dragP.x+20, dragP.y); ctx.moveTo(dragP.x, dragP.y-20); ctx.lineTo(dragP.x, dragP.y+20); }
        ctx.stroke(); ctx.setLineDash([]);
    }
    requestAnimationFrame(loop);
}

function floatT(x,y,c){ const e=document.createElement('div'); e.className='bouncy-txt'; e.style.left=x+'px'; e.style.top=y+'px'; e.innerText=`X${c}`; document.body.appendChild(e); setTimeout(()=>e.remove(), 800); }
function toggleM(id){ const m=document.getElementById(id); m.classList.toggle('open'); if(id==='shop-mod') renderS(); }
function updUI(){ document.getElementById('cur-s').innerText=st.score; document.getElementById('best-s').innerText=st.best; document.getElementById('wallet').innerText='$'+st.wallet; document.getElementById('next-box').innerText=SKINS[st.eq.sk][nextIdx]; const pb=document.getElementById('p-bar'); pb.innerHTML=''; for(let i=0; i<12; i++) pb.innerHTML+=`<span style="opacity:${st.found.includes(i)?1:0.1}">${SKINS[st.eq.sk][i]}</span>`; }
function renderS(){
    const c=document.getElementById('shop-content'); c.innerHTML=''; document.getElementById('cash').innerText=st.wallet;
    const cats=[{n:'Skins',k:'sk',d:SKINS,p:1500},{n:'Hitboxes',k:'hb',d:{Tiered:1,White:1,Transparent:1,Rainbow:1},p:1000},{n:'Outlines',k:'ot',d:{Black:'#000',Gold:'#ffd700',Neon:'#0f0',White:'#fff'},p:500},{n:'Backgrounds',k:'th',d:{Gray:'#f0f0f0',Midnight:'#1a1a2e',Forest:'#1b4332',Rose:'#fff0f5'},p:750},{n:'Borders',k:'bd',d:{Dark:'#333',Gold:'#daa520',Ruby:'#900',Steel:'#777'},p:500}];
    cats.forEach(cat=>{
        const h=document.createElement('div'); h.className='cat-head'; h.innerText=cat.n; c.appendChild(h);
        Object.keys(cat.d).forEach(k=>{
            const id=cat.k+'_'+(cat.k==='th'||cat.k==='bd'||cat.k==='ot'?cat.d[k]:k), isO=st.owned.includes(id), isE=st.eq[cat.k]===(cat.k==='th'||cat.k==='bd'||cat.k==='ot'?cat.d[k]:k);
            const card=document.createElement('div'); card.className=`card ${isE?'eq':''}`;
            card.innerHTML=`<div class="swatch" style="background:${cat.k==='th'?cat.d[k]:cat.k==='bd'?cat.d[k]:'#fff'}; border:2px solid ${cat.k==='ot'?cat.d[k]:'#333'}"></div>${k}<br>${isE?'EQ':isO?'OWN':'$'+cat.p}`;
            card.onclick=()=>{ if(isO)st.eq[cat.k]=(cat.k==='th'||cat.k==='bd'||cat.k==='ot'?cat.d[k]:k); else if(st.wallet>=cat.p){ st.wallet-=cat.p; st.owned.push(id); st.eq[cat.k]=(cat.k==='th'||cat.k==='bd'||cat.k==='ot'?cat.d[k]:k); } save(); renderS(); updUI(); };
            c.appendChild(card);
        });
    });
}
function resize(){ W=window.innerWidth; H=window.innerHeight; canvas.width=W; canvas.height=H; C.clear(engine.world, false); C.add(engine.world,[B.rectangle(W/2,H+240,W,500,{isStatic:true}),B.rectangle(-7,H/2,15,H,{isStatic:true}),B.rectangle(W+7,H/2,15,H,{isStatic:true})]); }
function playS(f){ if(st.muted)return; const a=new (window.AudioContext||window.webkitAudioContext)(); const o=a.createOscillator(); const g=a.createGain(); o.frequency.setValueAtTime(f,a.currentTime); o.frequency.exponentialRampToValueAtTime(10,a.currentTime+0.1); g.gain.setValueAtTime(0.05,a.currentTime); o.connect(g); g.connect(a.destination); o.start(); o.stop(a.currentTime+0.1); }
function toggleMute(){ st.muted=!st.muted; document.getElementById('m-btn').innerText=st.muted?'ðŸ”‡':'ðŸ”Š'; save(); }
function toggleF(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
function save(){ localStorage.setItem('fm_142', JSON.stringify(st)); }
function load(){ const d=localStorage.getItem('fm_142'); if(d) Object.assign(st, JSON.parse(d)); }
window.onload=init;
</script>
</body>
</html>
