<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Merge v93</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #fdfbf7; --ui-border: #e8e6e1; --accent: #c2b9ac; --text: #5c554a;
            --border-width: 15px; --outline-color: transparent;
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Avenir', sans-serif;
            background: var(--bg-color); color: var(--text); touch-action: none;
        }

        /* UI Structure */
        #top-ui { height: 175px; position: absolute; top: 0; width: 100%; border-bottom: var(--border-width) solid var(--ui-border); z-index: 50; background: inherit; padding: 10px; box-sizing: border-box; }
        #bottom-ui { height: 100px; position: absolute; bottom: 0; width: 100%; border-top: var(--border-width) solid var(--ui-border); display: flex; justify-content: space-around; align-items: center; z-index: 50; background: inherit; }
        
        #game-container { position: absolute; top: 175px; bottom: 100px; left: 0; right: 0; border-left: var(--border-width) solid var(--ui-border); border-right: var(--border-width) solid var(--ui-border); overflow: hidden; background: #fff; z-index: 5; }
        
        /* Progress & Store */
        #progress-list { display: flex; justify-content: space-between; padding: 5px 10px; margin-top: 15px; }
        .tier-icon { filter: grayscale(1); opacity: 0.2; font-size: 1.1rem; transition: 0.4s; }
        .tier-icon.unlocked { filter: grayscale(0); opacity: 1; transform: scale(1.2); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; flex-direction: column; }
        .modal-content { flex: 1; overflow-y: auto; padding: 30px; touch-action: pan-y; }
        .item-card { border: 1px solid var(--ui-border); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        .btn { padding: 12px; border-radius: 12px; border: 1px solid var(--ui-border); background: #fff; font-size: 0.9rem; cursor: pointer; }
        .power-btn.active { background: #ffeaa7; border-color: #fdcb6e; }
        
        .danger-line { position: absolute; top: 195px; width: 100%; border-top: 3px dashed #ff7675; opacity: 0.4; z-index: 1; pointer-events: none; }
        #drop-preview { position: absolute; top: 20px; font-size: 2.5rem; pointer-events: none; transform: translateX(-50%); opacity: 0.7; }
    </style>
</head>
<body>

<div id="top-ui">
    <div style="display:flex; justify-content: space-between;">
        <div><b>Score:</b> <span id="score">0</span><br><small>High: <span id="best">0</span></small></div>
        <div style="text-align: center;"><b>Next</b><div id="next-preview"></div></div>
        <div><button class="btn" onclick="toggleFullscreen()">‚õ∂</button> <button class="btn" onclick="showModal('help')">?</button></div>
    </div>
    <div id="progress-list"></div>
    <div style="text-align:center; font-weight:bold; margin-top:5px;">$ <span id="wallet">500</span></div>
</div>

<div class="danger-line"></div>
<div id="game-container">
    <div id="drop-preview"></div>
</div>

<div id="bottom-ui">
    <button id="btn-bomb" class="btn power-btn" onclick="setPowerUp('bomb')">üí£</button>
    <button id="btn-broom" class="btn power-btn" onclick="setPowerUp('broom')">üßπ</button>
    <button id="btn-wand" class="btn power-btn" onclick="setPowerUp('wand')">ü™Ñ</button>
    <button class="btn" onclick="showModal('store')">üè™ Store</button>
</div>

<div id="help-modal" class="modal">
    <div class="modal-content">
        <h2>How to Play</h2>
        <p>1. <b>Drop:</b> Tap the screen to drop items.</p>
        <p>2. <b>Merge:</b> Combine identical items to reach the 12th tier (The Pumpkin üéÉ/Cake üéÇ).</p>
        <p>3. <b>Game Over:</b> Don't let items sit above the red line for 2 seconds!</p>
        <hr>
        <h3>Power-ups</h3>
        <p>üí£ <b>Bomb:</b> Tap a fruit to explode it and nearby small items.</p>
        <p>üßπ <b>Broom:</b> Clears all items below Tier 3 to free up space.</p>
        <p>ü™Ñ <b>Wand:</b> Tap a fruit to instantly upgrade it to the next tier.</p>
        <button class="btn" style="width:100%" onclick="closeModals()">Close</button>
    </div>
</div>

<div id="store-modal" class="modal">
    <div class="modal-content">
        <h2>Store (44 Items)</h2>
        <div id="store-sections"></div>
        <button class="btn" style="width:100%; margin-top:20px" onclick="closeModals()">Close</button>
    </div>
</div>

<script>
/** * CONSTANTS & DATA
 */
const DATA = {
    skins: {
        Fruit: ['üçí','üçì','üçá','üçä','üçé','üçê','üçë','üçç','üçà','üçâ','ü••','üéÉ'],
        Plants: ['üå±','üåµ','ü™¥','üå≤','üå≥','üå¥','üéã','üåø','üçÄ','üçÑ','üåª','üåπ'],
        Weather: ['‚òÅÔ∏è','üå§Ô∏è','‚ö°','‚òÄÔ∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','‚õàÔ∏è','‚ùÑÔ∏è','üå¨Ô∏è','üåà','üå™Ô∏è'],
        Animals: ['üê≠','üê∞','ü¶ä','üêª','üêº','ü¶Å','üêØ','üê∑','üê∏','üêô','üê≥','ü¶Ñ'],
        Shapes: ['‚ñ≤','‚ñ†','‚¨ì','‚¨¢','‚¨¶','‚¨ó','‚òÖ','‚óÜ','‚úö','‚¨ô','‚¨£','‚¨§'],
        Music: ['üéµ','üé∂','üé∑','üé∏','üéπ','üéª','ü•Å','üìª','üé§','üéß','ü™ï','üìª'],
        Space: ['‚òÑÔ∏è','üõ∞Ô∏è','ü™ê','üåô','‚òÄÔ∏è','üî≠','üöÄ','üëΩ','üõ∏','üåå','üå†','üë©‚ÄçüöÄ'],
        Dessert: ['üç™','üç©','üßÅ','üç¶','üç∞','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üéÇ']
    },
    themes: ["Mellow", "Dusk", "Forest", "Sea", "Cloud", "Midnight", "Rose", "Matcha", "Slate", "Sand", "Lilac", "Olive", "Peach", "Storm", "Zest", "Mint"],
    borders: ["Steel", "Gold", "Neon Blue", "Crimson", "Mint", "Lavender", "Coal", "Ivory", "Emerald", "Sky", "Amber", "Plum", "Clay", "Silver", "Coffee", "Coral"],
    outlines: ["None", "White", "Black", "Neon"]
};

let state = {
    score: 0, wallet: parseInt(localStorage.getItem('wallet')) || 1000,
    skin: 'Fruit', unlocked: new Set([0]), next: 0,
    activePower: null, gameOverTimer: null
};

/** * AUDIO
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSoftNote(freq) {
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0.08, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.8);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.8);
}

/** * ENGINE
 */
const { Engine, Render, Runner, Bodies, Composite, Events, Vector } = Matter;
const container = document.getElementById('game-container');
const engine = Engine.create({ gravity: { y: 1.2 } });
const render = Render.create({
    element: container, engine: engine,
    options: { width: container.clientWidth, height: container.clientHeight, wireframes: false, background: 'transparent' }
});

const wallProps = { isStatic: true, friction: 0.1, render: { visible: false } };
const floor = Bodies.rectangle(container.clientWidth/2, container.clientHeight + 10, container.clientWidth, 25, wallProps);
const leftW = Bodies.rectangle(-10, container.clientHeight/2, 20, container.clientHeight, wallProps);
const rightW = Bodies.rectangle(container.clientWidth + 10, container.clientHeight/2, 20, container.clientHeight, wallProps);
Composite.add(engine.world, [floor, leftW, rightW]);

function spawnItem(x, y, tier, velocity = {x:0, y:0}) {
    const r = 14 + (tier * 7);
    const b = Bodies.circle(x, y, r, {
        restitution: 0.4, friction: 0.2,
        plugin: { tier: tier }
    });
    Matter.Body.setVelocity(b, velocity);
    Composite.add(engine.world, b);
    return b;
}

/** * INTERACTIONS
 */
container.addEventListener('pointermove', (e) => {
    const x = e.clientX - container.getBoundingClientRect().left;
    document.getElementById('drop-preview').style.left = `${x}px`;
    document.getElementById('drop-preview').innerText = DATA.skins[state.skin][state.next];
});

container.addEventListener('pointerdown', (e) => {
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (state.activePower) {
        handlePowerUpAction(x, y);
    } else {
        spawnItem(x, 40, state.next);
        state.next = Math.floor(Math.random() * 4);
        playSoftNote(200);
        updateUI();
    }
});

function handlePowerUpAction(x, y) {
    const clicked = Matter.Query.point(Composite.allBodies(engine.world), { x, y })[0];
    if (clicked && clicked.plugin.tier !== undefined) {
        if (state.activePower === 'bomb') {
            const nearby = Composite.allBodies(engine.world).filter(b => 
                Vector.magnitude(Vector.sub(b.position, clicked.position)) < 100
            );
            Composite.remove(engine.world, nearby);
            playSoftNote(100);
        } else if (state.activePower === 'wand') {
            const tier = clicked.plugin.tier;
            if (tier < 11) {
                const pos = { ...clicked.position };
                Composite.remove(engine.world, clicked);
                spawnItem(pos.x, pos.y, tier + 1);
                playSoftNote(600);
            }
        }
    }
    setPowerUp(null); // Reset after use
}

function setPowerUp(type) {
    document.querySelectorAll('.power-btn').forEach(b => b.classList.remove('active'));
    if (state.activePower === type || !type) {
        state.activePower = null;
    } else {
        state.activePower = type;
        document.getElementById(`btn-${type}`).classList.add('active');
        if (type === 'broom') {
            const smalls = Composite.allBodies(engine.world).filter(b => b.plugin.tier < 3);
            Composite.remove(engine.world, smalls);
            playSoftNote(150);
            setPowerUp(null);
        }
    }
}

// Collisions
Events.on(engine, 'collisionStart', (e) => {
    e.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        if (bodyA.plugin?.tier === bodyB.plugin?.tier && bodyA.plugin.tier < 11) {
            const pos = Vector.div(Vector.add(bodyA.position, bodyB.position), 2);
            const nextTier = bodyA.plugin.tier + 1;
            Composite.remove(engine.world, [bodyA, bodyB]);
            spawnItem(pos.x, pos.y, nextTier);
            state.score += nextTier * 15;
            state.wallet += nextTier;
            state.unlocked.add(nextTier);
            playSoftNote(300 + (nextTier * 30));
            updateUI();
        }
    });
});

// Main Loop: Rendering & Game Over
Events.on(render, 'afterRender', () => {
    const ctx = render.context;
    let anyAbove = false;
    
    Composite.allBodies(engine.world).forEach(body => {
        if (body.plugin.tier !== undefined) {
            const tier = body.plugin.tier;
            const emoji = DATA.skins[state.skin][tier];
            const r = 14 + (tier * 7);
            
            ctx.save();
            ctx.translate(body.position.x, body.position.y);
            ctx.rotate(body.angle);
            ctx.font = `${r * 1.8}px Arial`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            
            // Draw Outline if prestige item is active
            if (document.documentElement.style.getPropertyValue('--outline-color')) {
                ctx.strokeStyle = document.documentElement.style.getPropertyValue('--outline-color');
                ctx.lineWidth = 3; ctx.strokeText(emoji, 0, 0);
            }
            
            ctx.fillText(emoji, 0, 0);
            ctx.restore();

            if (body.position.y < 20 && !body.isStatic) anyAbove = true;
        }
    });

    handleGameOver(anyAbove);
});

function handleGameOver(isViolation) {
    if (isViolation) {
        if (!state.gameOverTimer) state.gameOverTimer = Date.now();
        else if (Date.now() - state.gameOverTimer > 2000) {
            alert("Board Reset! Don't worry, your wallet is safe.");
            Composite.clear(engine.world, true);
            state.score = 0; state.gameOverTimer = null;
            updateUI();
        }
    } else {
        state.gameOverTimer = null;
    }
}

/** * UI & STORE
 */
function updateUI() {
    document.getElementById('score').innerText = state.score;
    document.getElementById('wallet').innerText = state.wallet;
    document.getElementById('next-preview').innerText = DATA.skins[state.skin][state.next];
    
    const list = document.getElementById('progress-list');
    list.innerHTML = '';
    DATA.skins[state.skin].forEach((s, i) => {
        const span = document.createElement('span');
        span.className = `tier-icon ${state.unlocked.has(i) ? 'unlocked' : ''}`;
        span.innerText = s;
        list.appendChild(span);
    });
}

function populateStore() {
    const area = document.getElementById('store-sections');
    area.innerHTML = '';
    
    // Skins Section
    appendSection(area, "Skins", Object.keys(DATA.skins), 500, (key) => state.skin = key);
    // Themes Section
    appendSection(area, "Themes", DATA.themes, 300, (val) => {
        document.documentElement.style.setProperty('--bg-color', '#f0f0f0'); // Simplified
    });
    // Borders
    appendSection(area, "Borders", DATA.borders, 200, (val) => {
        document.documentElement.style.setProperty('--ui-border', '#333');
    });
    // Outlines
    appendSection(area, "Prestige Outlines", DATA.outlines, 2000, (val) => {
        document.documentElement.style.setProperty('--outline-color', val.toLowerCase());
    });
}

function appendSection(target, title, items, price, onSelect) {
    const h3 = document.createElement('h3'); h3.innerText = title;
    target.appendChild(h3);
    items.forEach(name => {
        const div = document.createElement('div');
        div.className = 'item-card';
        div.innerHTML = `<span>${name}</span> <button class="btn">$${price}</button>`;
        div.onclick = () => {
            if(state.wallet >= price) {
                state.wallet -= price;
                onSelect(name);
                updateUI();
                closeModals();
            } else alert("Not enough cash!");
        };
        target.appendChild(div);
    });
}

function showModal(id) { 
    if(id === 'store') populateStore();
    document.getElementById(id + '-modal').style.display = 'flex'; 
}
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
function toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>alert("Err"));
    else document.exitFullscreen();
}

// Kickoff
updateUI();
Render.run(render);
Runner.run(Runner.create(), engine);
</script>
</body>
</html>
