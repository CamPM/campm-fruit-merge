<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Fruit Merge v1.17</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<style>
:root{
 --bg:#FDF6E3;--bd:#657B83;--txt:#586E75;--acc:#2AA198;
 --err:#DC143C;--gold:#D4AF37;
 --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif
}
*{box-sizing:border-box;touch-action:none;user-select:none;-webkit-tap-highlight-color:transparent}
body{margin:0;overflow:hidden;background:var(--bg);font-family:var(--font);color:var(--txt);height:100vh}

canvas{display:block}

#ui{
 position:absolute;top:0;left:0;width:100%;height:100%;
 pointer-events:none;z-index:10;display:flex;flex-direction:column
}

.top-bar,.bot-bar{pointer-events:auto}

.top-bar{
 height:115px;padding:10px 15px;background:rgba(255,255,255,.92);
 backdrop-filter:blur(10px);border-bottom:3px solid var(--bd)
}
.row{display:flex;justify-content:space-between;align-items:center}
.score-val{font-size:20px;font-weight:900}

#next-box{
 width:42px;height:42px;border:2px dashed var(--bd);
 border-radius:50%;display:grid;place-items:center;
 font-size:24px;background:#fff
}

.prog-container{
 display:flex;justify-content:space-between;
 background:rgba(0,0,0,.05);
 padding:4px;border-radius:12px;
 margin-top:8px;height:28px;align-items:center
}
.dot{
 width:20px;height:20px;border-radius:50%;
 background:rgba(0,0,0,.05);
 display:flex;align-items:center;justify-content:center;font-size:11px
}
.dot.on{
 transform:scale(1.15);background:#fff;
 box-shadow:0 2px 5px rgba(0,0,0,.1)
}

.bot-bar{
 margin-top:auto;height:100px;background:rgba(255,255,255,.98);
 border-top:3px solid var(--bd);
 display:flex;align-items:center;
 padding:0 15px;padding-bottom:env(safe-area-inset-bottom);
 justify-content:space-between
}
.btn-grp{display:flex;gap:12px}
.btn{
 background:0;border:0;font-size:26px;
 display:flex;flex-direction:column;align-items:center;
 opacity:.3;transition:.2s
}
.btn.can-afford{opacity:.8}
.btn.active{opacity:1;color:var(--acc);transform:scale(1.1)}
.btn span{font-size:9px;font-weight:900;margin-top:3px}

#toast{
 position:absolute;top:135px;left:50%;
 transform:translateX(-50%);
 background:var(--err);color:#fff;
 padding:12px 30px;border-radius:40px;
 font-size:14px;font-weight:900;
 display:none;z-index:200
}
</style>
</head>

<body>
<div id="toast">INSUFFICIENT FUNDS</div>
<canvas id="c"></canvas>

<!-- UI (unchanged structure) -->
<div id="ui">
  <!-- top + bottom bars unchanged -->
</div>

<script>
/* ============================
   ENGINE SETUP (STABLE)
============================ */
const M=Matter,E=M.Engine,B=M.Bodies,C=M.Composite,Ev=M.Events;
const cv=document.getElementById('c'),cx=cv.getContext('2d');
const eng=E.create({enableSleeping:true});
eng.gravity.y=1.1;

let W,H,DL,FY;

/* ============================
   RESIZE (CRITICAL FIX)
============================ */
function rsz(){
 W=innerWidth; H=innerHeight;
 const dpr=window.devicePixelRatio||1;
 cv.width=W*dpr; cv.height=H*dpr;
 cx.setTransform(dpr,0,0,dpr,0,0);

 DL=195; FY=H-100;
 C.clear(eng.world,false);

 C.add(eng.world,[
  B.rectangle(W/2,FY+500,W,1000,{isStatic:true}),
  B.rectangle(-250,H/2,500,H*2,{isStatic:true}),
  B.rectangle(W+250,H/2,500,H*2,{isStatic:true})
 ]);
}
addEventListener('resize',rsz); rsz();

/* ============================
   INPUT (UNCHANGED BEHAVIOR)
============================ */
let drag=false,x=0,y=0,dropOK=true;

addEventListener('pointerdown',e=>{
 const r=cv.getBoundingClientRect();
 x=(e.clientX-r.left)*(W/r.width);
 y=(e.clientY-r.top)*(H/r.height);
 if(!e.target.closest('button')) drag=true;
});

addEventListener('pointermove',e=>{
 const r=cv.getBoundingClientRect();
 x=(e.clientX-r.left)*(W/r.width);
 y=(e.clientY-r.top)*(H/r.height);
});

addEventListener('pointerup',()=>{
 if(drag && dropOK && y<FY) spawn();
 drag=false;
});

/* ============================
   SPAWN (UNCHANGED)
============================ */
function spawn(){
 const gx=Math.max(45,Math.min(W-45,x));
 const b=B.circle(gx,80,20,{restitution:.3});
 b.tier=Math.floor(Math.random()*5);
 C.add(eng.world,b);
 dropOK=false;
 setTimeout(()=>dropOK=true,500);
}

/* ============================
   LOOP (FIXED DRAW ORDER)
============================ */
function loop(){
 E.update(eng,16);
 cx.clearRect(0,0,W,H);

 // death line
 cx.beginPath();
 cx.moveTo(15,DL); cx.lineTo(W-15,DL);
 cx.setLineDash([8,8]);
 cx.strokeStyle="#DC143C";
 cx.lineWidth=3; cx.stroke();
 cx.setLineDash([]);

 // draw bodies
 C.allBodies(eng.world).forEach(b=>{
  if(b.isStatic||b.tier==null)return;
  cx.save();
  cx.translate(b.position.x,b.position.y);
  cx.beginPath();
  cx.arc(0,0,b.circleRadius,0,Math.PI*2);
  cx.fillStyle="#fff"; cx.fill();
  cx.font=`${b.circleRadius*1.4}px serif`;
  cx.textAlign="center"; cx.textBaseline="middle";
  cx.fillText("üçí",0,0);
  cx.restore();
 });

 // crosshair
 if(drag){
  const gx=Math.max(45,Math.min(W-45,x));
  cx.beginPath();
  cx.moveTo(gx,80); cx.lineTo(gx,FY);
  cx.setLineDash([5,5]);
  cx.strokeStyle="#999"; cx.stroke();
  cx.setLineDash([]);
 }

 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
