<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Fruit Merge v1.40</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --accent: #2ecc71; --bg: #f0f0f0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin:0; padding:0; }
        body { overflow: hidden; font-family: 'Arial Black', sans-serif; height: 100vh; width: 100vw; position: fixed; touch-action: none; background: var(--bg); }
        canvas { display: block; width: 100%; height: 100%; }
        
        .ui { position: absolute; width: 100%; z-index: 1000; pointer-events: none; }
        .top-ui { top: 0; background: rgba(255,255,255,0.9); border-bottom: 3px solid #333; pointer-events: auto; padding: 10px 20px; padding-top: env(safe-area-inset-top); text-align: center; }
        .bot-ui { bottom: 0; height: 90px; background: rgba(255,255,255,0.9); border-top: 3px solid #333; pointer-events: auto; display: flex; align-items: center; justify-content: space-evenly; padding-bottom: env(safe-area-inset-bottom); }
        
        #next-box { width: 60px; height: 60px; border: 3px solid #333; border-radius: 50%; background: #fff; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 0 #333; }
        .pwr-btn { width: 45px; height: 45px; border-radius: 12px; border: 2px solid #333; background: #fff; display: flex; align-items: center; justify-content: center; pointer-events: auto; font-size: 20px; position: relative; }
        .pwr-btn::after { content: attr(data-p); position: absolute; top: -15px; font-size: 10px; color: #444; }
        
        .modal { display: none; position: absolute; inset: 15px; background: white; z-index: 5000; border: 4px solid #333; border-radius: 20px; flex-direction: column; pointer-events: auto; }
        .modal.open { display: flex; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; }
        .cat-h { grid-column: 1 / -1; margin-top: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .card { border: 2px solid #eee; border-radius: 12px; padding: 10px; text-align: center; background: #fafafa; }
        .card.eq { border-color: var(--accent); background: #eafff0; }
        .swatch { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; animation: bounce 2s infinite ease-in-out; background: #fff; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        
        .float-txt { position: absolute; pointer-events: none; font-family: 'Impact', sans-serif; font-size: 24px; color: #e74c3c; text-shadow: 2px 2px 0 #fff; animation: rise 0.8s forwards; z-index: 2000; }
        @keyframes rise { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
    </style>
</head>
<body>

<div id="game-over" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:9000; color:white; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto;">
    <h1 style="font-size:3rem">GAME OVER</h1>
    <p>Score: <span id="go-score">0</span> | Best: <span id="go-best">0</span></p>
    <button onclick="restart()" style="margin-top:20px; padding:15px 40px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold">PLAY AGAIN</button>
</div>

<div class="ui top-ui">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <div style="font-size:12px">SCORE<div id="score">0</div></div>
        <div id="next-box"></div>
        <div style="font-size:12px">BEST<div id="best">0</div></div>
    </div>
    <div id="prog-bar" style="display:flex; justify-content:space-around; background:rgba(0,0,0,0.05); padding:4px; border-radius:10px;"></div>
    <div id="wallet" style="color:var(--accent); font-size:18px; margin-top:4px">$0</div>
</div>

<div class="ui bot-ui">
    <div class="pwr-btn" data-type="bomb" data-p="$50">ðŸ’£</div>
    <div class="pwr-btn" data-type="wipe" data-p="$75">ðŸ§¹</div>
    <div class="pwr-btn" data-type="evo" data-p="$150">ðŸª„</div>
    <div class="pwr-btn" style="width:40px" onclick="toggleM('help-modal')">?</div>
    <div id="fs-btn" class="pwr-btn" style="display:none" onclick="toggleFS()">â›¶</div>
    <div class="pwr-btn" style="width:70px; background:var(--accent); color:white" onclick="toggleM('shop-modal')">SHOP</div>
</div>

<div id="shop-modal" class="modal">
    <div style="padding:15px; display:flex; justify-content:space-between; border-bottom:2px solid #eee"><b>THE MARKET</b><b onclick="toggleM('shop-modal')">âœ•</b></div>
    <div class="modal-body" id="shop-content"></div>
</div>

<div id="help-modal" class="modal">
    <div style="padding:15px; border-bottom:2px solid #eee"><b>HELP & INFO</b></div>
    <div class="modal-body" style="grid-template-columns: 1fr; font-size: 14px; line-height: 1.4;">
        <p><b>Combos:</b> Merge quickly for 5x multipliers.</p>
        <p><b>Vibe-Logic:</b> Different skins change physics! Space is heavy, Desserts are bouncy.</p>
        <p><b>Power-ups:</b> Drag ðŸ’£/ðŸ§¹/ðŸª„ onto the field.</p>
        <p style="opacity:0.3; margin-top:20px">v1.40 Obsidian Edition</p>
        <button onclick="toggleM('help-modal')" style="background:#333; color:white; padding:10px; border-radius:8px;">CLOSE</button>
    </div>
</div>

<canvas id="c"></canvas>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite;
const SKINS = { Fruit: ["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"], Animals: ["ðŸž","ðŸ¸","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","ðŸ˜","ðŸ‹"], Music: ["ðŸª•","ðŸª—","ðŸŽ¸","ðŸŽ¹","ðŸŽº","ðŸŽ»","ðŸ¥","ðŸŽ·","ðŸŽ™ï¸","ðŸ“»","ðŸŽ§","ðŸŽµ"], Weather: ["â˜ï¸","ðŸŒ¦ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒªï¸","ðŸŒ«ï¸","ðŸŒˆ","â˜€ï¸"], Space: ["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"], Nature: ["ðŸŒ±","ðŸŒ¿","â˜˜ï¸","ðŸ€","ðŸƒ","ðŸ‚","ðŸ","ðŸ„","ðŸŒµ","ðŸŒ´","ðŸŒ²","ðŸŒ³"], Dessert: ["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"], Shapes: ["ðŸ”º","ðŸŸ¡","ðŸŸ©","ðŸ”·","â­","ðŸ›‘","ðŸ’Ž","ðŸŒ™","ðŸŒ€","ðŸ’ ","â¬›","âšª"] };
const PHRASES = { Space: ["SUPERNOVA!","GALACTIC!","VACUUM!","VOID!","ORBIT!"], Fruit: ["JUICY!","FRESH!","SWEET!","ZESTY!","RIPE!"], Animals: ["WILD!","BEAST!","ROAR!","PURE!","APEX!"], Music: ["GROOVY!","BEAT!","TEMPO!","HARMONY!","LOUD!"], Weather: ["STORM!","BOLT!","GALE!","FROST!","SUNNY!"], Nature: ["ROOTS!","FLORA!","EARTHY!","WILD!","BLOOM!"], Dessert: ["SUGAR!","TASTY!","GLAZED!","YUMMY!","TREAT!"], Shapes: ["ANGULAR!","SHARP!","FLAT!","SOLID!","GEO!"] };
const THEMES = { Mellow:"#FDF6E3", Midnight:"#1a1b26", Matcha:"#E8F5E9", Lavender:"#F3E5F5", Rose:"#FFF1F0", Sunset:"#FFF5E6", Charcoal:"#212121", Sky:"#E1F5FE" };
const BORDERS = { Slate:"#657B83", Gold:"#DAA520", Neon:"#B026FF", Red:"#DC143C", Black:"#000000", Silver:"#C0C0C0" };
const OUTLINES = { Default:"def", Rainbow:"rbw", White:"#fff", Black:"#000" };
const SIZES = [18, 24, 30, 38, 46, 55, 65, 76, 88, 102, 118, 135];

let st = { score:0, best:0, wallet:100, eq:{sk:'Fruit', th:'Mellow', bd:'Slate', ot:'def'}, owned:['sk_Fruit', 'th_Mellow', 'bd_Slate', 'ot_Default'], found:[0] };
let engine, canvas, ctx, W, H, floor, wallL, wallR, nextIdx=1, curIdx=0, canDrop=true, lastX=150, isDead=false, activeDrag=null, dragPos={x:0,y:0}, isPaused=false, skinCycle=0;

function init() {
    load(); canvas=document.getElementById('c'); ctx=canvas.getContext('2d');
    if(!/iPad|iPhone|iPod/.test(navigator.userAgent)) document.getElementById('fs-btn').style.display='flex';
    engine=E.create({gravity:{y:1.2}}); resize();
    M.Events.on(engine, 'collisionStart', e => {
        e.pairs.forEach(p => {
            const a=p.bodyA, b=p.bodyB;
            if(a.plugin?.t!==undefined && a.plugin.t===b.plugin.t && a.plugin.t<11) {
                const t=a.plugin.t, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
                C.remove(engine.world, [a,b]); spawnF(pos.x, pos.y, t+1, false);
                st.score+=(t+1)*10; st.wallet+=(t+1)*15; spawnTxt(pos.x, pos.y);
                if(st.score>st.best) st.best=st.score; if(!st.found.includes(t+1)) st.found.push(t+1);
                updUI(); save();
            }
        });
    });
    setupIn(); loop();
    setInterval(()=>{ skinCycle=(skinCycle+1)%12; if(st.paused) renderS(); }, 800);
}

function resize() {
    W=window.innerWidth; H=window.innerHeight; canvas.width=W*devicePixelRatio; canvas.height=H*devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    if(floor) C.remove(engine.world, [floor, wallL, wallR]);
    floor=B.rectangle(W/2, H-90+250, W, 500, {isStatic:true});
    wallL=B.rectangle(7.5, H/2, 15, H*2, {isStatic:true});
    wallR=B.rectangle(W-7.5, H/2, 15, H*2, {isStatic:true});
    C.add(engine.world, [floor, wallL, wallR]);
}

function getPhys() {
    const s=st.eq.sk;
    if(["Space","Nature","Shapes"].includes(s)) return {r:0.2, f:0.1};
    if(["Animals","Dessert"].includes(s)) return {r:0.8, f:0.01};
    return {r:0.5, f:0.02};
}

function spawnF(x,y,t,isD) {
    const p=getPhys();
    const b=B.circle(x,y,SIZES[t],{restitution:p.r, friction:p.f, plugin:{t:t}});
    b.squish = 1.4; C.add(engine.world, b);
    if(isD) { curIdx=nextIdx; nextIdx=Math.floor(Math.random()*5); canDrop=false; setTimeout(()=>canDrop=true, 500); updUI(); }
    return b;
}

function setupIn() {
    const getX=e=>(e.touches?e.touches[0].clientX:e.clientX);
    const getY=e=>(e.touches?e.touches[0].clientY:e.clientY);
    const move=e=>{ if(isPaused) return; if(activeDrag) dragPos={x:getX(e), y:getY(e)}; else lastX=Math.max(30,Math.min(W-30,getX(e))); e.preventDefault(); };
    const end=e=>{ if(isPaused) return; if(activeDrag) releaseP(dragPos.x, dragPos.y); else if(canDrop && !isDead && !e.target.closest('.ui')) spawnF(lastX, 165, curIdx, true); };
    window.addEventListener('touchstart', e=>{ if(e.target.dataset.type){ activeDrag=e.target.dataset.type; dragPos={x:getX(e),y:getY(e)}; } }, {passive:false});
    window.addEventListener('mousedown', e=>{ if(e.target.dataset.type){ activeDrag=e.target.dataset.type; dragPos={x:getX(e),y:getY(e)}; } });
    window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('mousemove', move);
    window.addEventListener('touchend', end); window.addEventListener('mouseup', end);
}

function releaseP(x,y) {
    const type=activeDrag; activeDrag=null; const price=type==='bomb'?50:type==='wipe'?75:150;
    if(st.wallet<price) return;
    const bodies=C.allBodies(engine.world).filter(b=>b.plugin);
    if(type==='bomb'){ bodies.forEach(b=>{ if(M.Vector.magnitude(M.Vector.sub(b.position,{x,y}))<80) C.remove(engine.world,b); }); }
    else { const target=bodies.find(b=>M.Bounds.contains(b.bounds,{x,y})); if(target){
        const t=target.plugin.t;
        if(type==='wipe') bodies.forEach(b=>{ if(b.plugin.t===t) C.remove(engine.world, b); });
        if(type==='evo' && t<11) bodies.forEach(b=>{ if(b.plugin.t===t){ const p=b.position; C.remove(engine.world, b); spawnF(p.x, p.y, t+1, false); } });
    }}
    st.wallet-=price; updUI(); save();
}

function loop() {
    if(!isPaused) E.update(engine, 16);
    ctx.clearRect(0,0,W,H); document.body.style.background=THEMES[st.eq.th];
    ctx.fillStyle=BORDERS[st.eq.bd]; ctx.fillRect(0,0,15,H); ctx.fillRect(W-15,0,15,H);
    ctx.setLineDash([5,5]); ctx.strokeStyle="red"; ctx.beginPath(); ctx.moveTo(0,165); ctx.lineTo(W,165); ctx.stroke();
    const now=Date.now();
    C.allBodies(engine.world).forEach(b => {
        if(!b.plugin) return;
        if(b.position.y-b.circleRadius<165 && b.speed<0.2){ if(!b.tm) b.tm=now; if(now-b.tm>2000) isDead=true; } else b.tm=null;
        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        if(b.squish > 1) b.squish -= 0.05; ctx.scale(b.squish, b.squish);
        ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(0,0,b.circleRadius,0,Math.PI*2); ctx.fill();
        ctx.lineWidth=4; ctx.strokeStyle=st.eq.ot==='rbw'?`hsl(${now/10%360},80%,50%)`:st.eq.ot==='def'?'#0002':st.eq.ot;
        ctx.stroke(); ctx.font=`${b.circleRadius*1.2}px serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk][b.plugin.t], 0, 0); ctx.restore();
        if(activeDrag && M.Vector.magnitude(M.Vector.sub(b.position, dragPos))<80) { ctx.save(); ctx.beginPath(); ctx.arc(b.position.x, b.position.y, b.circleRadius+5, 0, Math.PI*2); ctx.strokeStyle="#fff"; ctx.lineWidth=3; ctx.stroke(); ctx.restore(); }
    });
    if(canDrop && !activeDrag && !isDead && !isPaused){ ctx.globalAlpha=0.3; ctx.font="40px serif"; ctx.textAlign="center"; ctx.fillText(SKINS[st.eq.sk][curIdx], lastX, 145); ctx.globalAlpha=1; }
    if(isDead){ document.getElementById('game-over').style.display='flex'; document.getElementById('go-score').innerText=st.score; document.getElementById('go-best').innerText=st.best; }
    requestAnimationFrame(loop);
}

function renderS() {
    const cont=document.getElementById('shop-content'); cont.innerHTML='';
    const cats=[{n:'Outlines',k:'ot',d:OUTLINES,c:2000},{n:'Skins',k:'sk',d:SKINS,c:1500},{n:'Themes',k:'th',d:THEMES,c:750},{n:'Borders',k:'bd',d:BORDERS,c:500}];
    cats.forEach(cat=>{
        cont.innerHTML+=`<h4 class="cat-h">${cat.n}</h4>`;
        Object.keys(cat.d).forEach(k=>{
            const id=cat.k+'_'+k, isO=st.owned.includes(id), val=(cat.k==='ot'?cat.d[k]:k), isE=st.eq[cat.k]===val;
            const card=document.createElement('div'); card.className=`card ${isE?'eq':''}`;
            let pre = cat.k==='sk'?cat.d[k][skinCycle]:(k==='Rainbow'?'ðŸŒˆ':'');
            let style = `background:${cat.k==='th'?cat.d[k]:'white'}; border-color:${cat.k==='bd'?cat.d[k]:'#333'}`;
            card.innerHTML=`<div class="swatch" style="${style}">${pre}</div><small>${k}</small><br><small>${isE?'EQ':isO?'OWN':cat.c}</small>`;
            card.onclick=()=>{ if(isO){st.eq[cat.k]=val;} else if(st.wallet>=cat.c){st.wallet-=cat.c; st.owned.push(id); st.eq[cat.k]=val;} updUI(); renderS(); save(); };
            cont.appendChild(card);
        });
    });
}

function spawnTxt(x,y) {
    const div=document.createElement('div'); div.className='float-txt'; div.style.left=x+'px'; div.style.top=y+'px';
    const p=PHRASES[st.eq.sk]; div.innerText=p[Math.floor(Math.random()*p.length)];
    document.body.appendChild(div); setTimeout(()=>div.remove(), 800);
}

function updUI() {
    document.getElementById('score').innerText=st.score; document.getElementById('best').innerText=st.best;
    document.getElementById('wallet').innerText='$'+st.wallet; document.getElementById('next-box').innerText=SKINS[st.eq.sk][nextIdx];
    const pb=document.getElementById('prog-bar'); pb.innerHTML='';
    for(let i=0; i<12; i++) pb.innerHTML+=`<span style="opacity:${st.found.includes(i)?1:0.1}">${SKINS[st.eq.sk][i]}</span>`;
}

function toggleM(id){ const m=document.getElementById(id); m.classList.toggle('open'); isPaused=m.classList.contains('open'); if(id==='shop-modal') renderS(); }
function toggleFS(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
function restart(){ st.score=0; st.found=[0]; isDead=false; isPaused=false; document.getElementById('game-over').style.display='none'; C.clear(engine.world,false); resize(); updUI(); }
function save(){ localStorage.setItem('fm_v140', JSON.stringify(st)); }
function load(){ const d=localStorage.getItem('fm_v140'); if(d) Object.assign(st, JSON.parse(d)); }
window.onload=init;
</script>
</body>
</html>
