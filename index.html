<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fruit Merge - v1.34</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --accent: #3498db; --bg: #FDF6E3; --font: -apple-system, system-ui, sans-serif; --panel: rgba(255,255,255,0.98); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { 
            overflow: hidden; background: var(--bg); font-family: var(--font); 
            height: 100vh; width: 100vw; position: fixed; touch-action: none; 
            -webkit-user-select: none; 
        }
        canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }

        /* UI PANELS */
        .ui-panel { position: absolute; width: 100%; z-index: 1000; pointer-events: none; }
        .top-bar { top: 0; height: 140px; background: var(--panel); border-bottom: 3px solid #333; pointer-events: auto; padding: 10px 20px; padding-top: env(safe-area-inset-top); }
        .bot-bar { bottom: 0; height: 100px; background: var(--panel); border-top: 3px solid #333; pointer-events: auto; display: flex; align-items: center; justify-content: space-evenly; padding-bottom: env(safe-area-inset-bottom); }
        
        .score-box { text-align: center; min-width: 60px; font-size: 14px; }
        #next-preview { width: 55px; height: 55px; border: 3px solid #333; border-radius: 50%; display: grid; place-items: center; font-size: 32px; background: #fff; box-shadow: 0 4px 0 #333; }
        
        /* POWER UPS */
        .pwr-btn { width: 50px; height: 50px; border-radius: 14px; border: 2px solid #333; color: white; font-size: 24px; cursor: grab; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; pointer-events: auto; box-shadow: 0 3px 0 #333; }
        .pwr-btn.locked { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }
        .pwr-btn.dragging { opacity: 0.4; transform: scale(0.8); }
        #p-bomb { background: #e67e22; } #p-wipe { background: #9b59b6; } #p-evo { background: #f1c40f; }
        
        /* MODALS */
        .modal { display: none; position: absolute; inset: 20px; background: white; z-index: 5000; border-radius: 25px; border: 5px solid var(--accent); flex-direction: column; overflow: hidden; pointer-events: auto; }
        .modal.open { display: flex; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        
        .card { background: #f9f9f9; padding: 12px; border-radius: 15px; text-align: center; border: 2px solid #eee; cursor: pointer; position: relative; }
        .card.equipped { border-color: #2ecc71; background: #f0fff4; border-width: 3px; }
        .preview-swatch { width: 60px; height: 60px; border-radius: 50%; margin: 5px auto; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 28px; background: white; overflow: hidden; }
        
        #overlay-start { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .rainbow-fx { animation: rb 3s linear infinite; }
        @keyframes rb { 0% { border-color: red; } 33% { border-color: lime; } 66% { border-color: blue; } 100% { border-color: red; } }
    </style>
</head>
<body>

<div id="overlay-start">
    <h1 style="margin-bottom:20px">FRUIT MERGE v1.34</h1>
    <button onclick="startGame()" style="padding:15px 40px; font-size:20px; border-radius:50px; border:none; background:#2ecc71; color:white; font-weight:bold;">START GAME</button>
</div>

<div id="toast" style="display:none; position:fixed; top:160px; left:50%; transform:translateX(-50%); background:#e74c3c; color:white; padding:10px 20px; border-radius:20px; z-index:10001;">NOT ENOUGH CASH</div>

<div class="ui-panel top-bar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="score-box"><b>SCORE</b><div id="cur-score">0</div></div>
        <div id="next-preview"></div>
        <div class="score-box"><b>WALLET</b><div id="wallet-ui" style="color:#2ecc71">$0</div></div>
    </div>
    <div id="prog-bar" style="display:flex; justify-content:space-around; margin-top:10px; background:rgba(0,0,0,0.05); border-radius:10px; padding:5px;"></div>
</div>

<div class="ui-panel bot-bar">
    <div id="p-bomb" class="pwr-btn" data-type="bomb">ðŸ’£</div>
    <div id="p-wipe" class="pwr-btn" data-type="wipe">ðŸ§¹</div>
    <div id="p-evo" class="pwr-btn" data-type="evo">ðŸª„</div>
    <div style="width:2px; height:40px; background:#ccc;"></div>
    <div class="pwr-btn" style="background:#34495e;" onclick="toggleModal('shop-modal')">ðŸ›’</div>
    <div class="pwr-btn" style="background:#95a5a6;" onclick="toggleModal('help-modal')">?</div>
</div>

<div id="shop-modal" class="modal">
    <div style="padding:15px; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center;">
        <h2 id="shop-wallet">$0</h2>
        <b onclick="toggleModal('shop-modal')" style="font-size:24px; padding:5px;">âœ•</b>
    </div>
    <div class="modal-content" id="store-container"></div>
</div>

<div id="help-modal" class="modal">
    <div style="padding:15px; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center;">
        <h2>GUIDE</h2>
        <b onclick="toggleModal('help-modal')" style="font-size:24px; padding:5px;">âœ•</b>
    </div>
    <div class="modal-content">
        <p>â€¢ Drop emojis to merge pairs.</p>
        <p>â€¢ Don't stay above the red line for 2 seconds!</p>
        <p><b>Power-ups:</b> Drag from button to target area/fruit.</p>
        <div id="ios-standalone" style="margin-top:20px; padding:10px; background:#eee; display:none;">
            <b>iPhone Tip:</b> Tap <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iIzM0OThkYiIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICA8cGF0aCBkPSJNOCAwTDQgNHgzVjhIOXYtNEwxMiA0IDggMHpNMyA1djloMTBWNUgxMXYxaDJ2N0g0VjZINXYtMUgzem01IDR2M2gxdi0zSDh6Ii8+Cjwvc3ZnPg=="> and "Add to Home Screen" for fullscreen play.
        </div>
    </div>
</div>

<canvas id="c"></canvas>

<script>
const M=Matter, E=M.Engine, R=M.Render, B=M.Bodies, C=M.Composite;
const SKINS = { Fruit: ["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"], Animals: ["ðŸž","ðŸ¸","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","ðŸ˜","ðŸ‹"], Dessert: ["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"], Space: ["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"] };
const THEMES = { Mellow: "#FDF6E3", Midnight: "#1a1b26", Sky: "#E1F5FE", Forest: "#1B5E20" };
const BORDERS = { Slate: "#657B83", Neon: "#B026FF", Gold: "#DAA520" };
const SIZES = [20, 26, 34, 42, 50, 60, 72, 85, 100, 115, 130, 150];
const V_W = 1000, V_H = 1000; // Fixed Virtual Scale

let st = { score:0, wallet:0, eq:{sk:'Fruit', th:'Mellow', bd:'Slate', ot:'def'}, owned:['sk_Fruit', 'th_Mellow', 'bd_Slate', 'ot_def'], found:[0] };
let engine, canvas, ctx, audioCtx, isDead = false;
let nextIdx = 1, curIdx = 0, canDrop = true, lastX = 500, activeDrag = null, dragPos = {x:0, y:0};

function startGame() {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('overlay-start').style.display = 'none';
    init();
}

function init() {
    const d = localStorage.getItem('fm_v133'); if(d) Object.assign(st, JSON.parse(d));
    canvas = document.getElementById('c'); ctx = canvas.getContext('2d');
    engine = E.create({ gravity: { y: 2.5 } });
    
    if(/iPhone|iPad/.test(navigator.userAgent)) document.getElementById('ios-standalone').style.display = 'block';

    window.addEventListener('resize', resize); resize();
    
    M.Events.on(engine, 'collisionStart', e => {
        e.pairs.forEach(p => {
            const a = p.bodyA, b = p.bodyB;
            if(a.plugin?.t !== undefined && a.plugin.t === b.plugin.t && a.plugin.t < 11) {
                const t = a.plugin.t, pos = { x: (a.position.x+b.position.x)/2, y: (a.position.y+b.position.y)/2 };
                C.remove(engine.world, [a, b]);
                spawnFruit(pos.x, pos.y, t + 1, false);
                st.score += (t+1)*10; st.wallet += (t+1)*10;
                if(!st.found.includes(t+1)) st.found.push(t+1);
                updUI(); save();
            }
        });
    });

    setupInputs();
    loop();
}

function resize() {
    const w = window.innerWidth, h = window.innerHeight;
    canvas.width = w * devicePixelRatio; canvas.height = h * devicePixelRatio;
    ctx.scale(devicePixelRatio * (w/V_W), devicePixelRatio * (h/V_H));
    updateBounds();
}

function updateBounds() {
    C.clear(engine.world, false);
    const floor = B.rectangle(500, 950, 1000, 100, { isStatic: true });
    const wallL = B.rectangle(-10, 500, 20, 1000, { isStatic: true });
    const wallR = B.rectangle(1010, 500, 20, 1000, { isStatic: true });
    C.add(engine.world, [floor, wallL, wallR]);
}

function spawnFruit(x, y, t, isDrop) {
    const b = B.circle(x, y, SIZES[t], { restitution:0.2, plugin:{t:t} });
    C.add(engine.world, b);
    if(isDrop) {
        curIdx = nextIdx; nextIdx = Math.floor(Math.random()*5);
        canDrop = false; setTimeout(() => canDrop = true, 500);
        updUI();
    }
}

function loop() {
    E.update(engine, 16);
    ctx.clearRect(0,0,V_W,V_H);
    
    // Death Line
    ctx.setLineDash([10, 10]); ctx.strokeStyle = "red";
    ctx.beginPath(); ctx.moveTo(0, 165); ctx.lineTo(1000, 165); ctx.stroke(); ctx.setLineDash([]);

    const now = Date.now();
    C.allBodies(engine.world).forEach(b => {
        if(!b.plugin) return;
        const r = b.circleRadius, t = b.plugin.t;
        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        
        ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2);
        ctx.fillStyle = "#fff"; ctx.fill();
        ctx.strokeStyle = st.eq.ot === 'rainbow' ? `hsl(${now/5%360},100%,50%)` : "#333";
        ctx.lineWidth = 4; ctx.stroke();
        
        ctx.font = `${r*1.2}px serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk][t], 0, 0);
        ctx.restore();
    });

    if(activeDrag) {
        ctx.beginPath(); ctx.arc(dragPos.x, dragPos.y, activeDrag === 'bomb' ? 80 : 20, 0, Math.PI*2);
        ctx.setLineDash([5,5]); ctx.strokeStyle = "#333"; ctx.stroke();
    } else if(canDrop) {
        ctx.globalAlpha = 0.3; ctx.font = "50px serif"; ctx.fillText(SKINS[st.eq.sk][curIdx], lastX - 25, 140); ctx.globalAlpha = 1;
    }

    requestAnimationFrame(loop);
}

function setupInputs() {
    const handleMove = (e) => {
        const p = e.touches ? e.touches[0] : e;
        const rect = canvas.getBoundingClientRect();
        const x = (p.clientX - rect.left) * (V_W / rect.width);
        const y = (p.clientY - rect.top) * (V_H / rect.height);
        dragPos = {x, y};
        if(!activeDrag) lastX = Math.max(50, Math.min(950, x));
    };

    const handleEnd = (e) => {
        if(activeDrag) {
            processPowerUp(dragPos.x, dragPos.y);
            activeDrag = null;
            document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('dragging'));
        } else if(canDrop) {
            spawnFruit(lastX, 165, curIdx, true);
        }
    };

    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', e => { e.preventDefault(); handleMove(e); }, {passive:false});
    canvas.addEventListener('touchend', e => { e.preventDefault(); handleEnd(e); }, {passive:false});

    document.querySelectorAll('.pwr-btn[data-type]').forEach(btn => {
        btn.addEventListener('touchstart', (e) => {
            const type = btn.dataset.type;
            const cost = type === 'bomb' ? 500 : type === 'wipe' ? 1000 : 1500;
            if(st.wallet >= cost) {
                activeDrag = type;
                btn.classList.add('dragging');
            } else showToast();
        });
    });
}

function processPowerUp(x, y) {
    const bodies = C.allBodies(engine.world).filter(b => b.plugin);
    let cost = 0;
    if(activeDrag === 'bomb') {
        bodies.forEach(b => { if(M.Vector.magnitude(M.Vector.sub(b.position, {x,y})) < 80) C.remove(engine.world, b); });
        cost = 500;
    } else {
        const target = bodies.find(b => M.Bounds.contains(b.bounds, {x, y}));
        if(target) {
            const t = target.plugin.t;
            if(activeDrag === 'wipe') {
                bodies.forEach(b => { if(b.plugin.t === t) C.remove(engine.world, b); });
                cost = 1000;
            } else if(activeDrag === 'evo' && t < 11) {
                bodies.forEach(b => { if(b.plugin.t === t) { const p = b.position; C.remove(engine.world, b); spawnFruit(p.x, p.y, t+1, false); } });
                cost = 1500;
            }
        }
    }
    if(cost > 0) { st.wallet -= cost; updUI(); save(); }
}

function renderStore() {
    const container = document.getElementById('store-container'); container.innerHTML = '';
    document.getElementById('shop-wallet').innerText = '$' + st.wallet;
    
    const cats = [
        {t: 'Skins', k: 'sk', d: SKINS, c: 1500},
        {t: 'Themes', k: 'th', d: THEMES, c: 500},
        {t: 'Borders', k: 'bd', d: BORDERS, c: 500}
    ];

    cats.forEach(cat => {
        container.innerHTML += `<h3 style="margin:15px 0 10px">${cat.t}</h3><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;" id="grid-${cat.k}"></div>`;
        const grid = document.getElementById(`grid-${cat.k}`);
        Object.keys(cat.d).forEach(item => {
            const id = `${cat.k}_${item}`;
            const owned = st.owned.includes(id);
            const eq = st.eq[cat.k] === item;
            const card = document.createElement('div');
            card.className = `card ${eq ? 'equipped' : ''}`;
            
            // Skin Cycling Logic for Store
            let displayIcon = cat.k === 'sk' ? cat.d[item][0] : "ðŸŽ¨";
            card.innerHTML = `<div class="preview-swatch" id="prev-${id}">${displayIcon}</div><b>${item}</b><br><small>${eq?'Equipped':owned?'Owned':'$'+cat.c}</small>`;
            
            if(cat.k === 'sk') {
                let idx = 0;
                setInterval(() => {
                    idx = (idx + 1) % 12;
                    const p = document.getElementById(`prev-${id}`);
                    if(p) p.innerText = cat.d[item][idx];
                }, 1000);
            }

            card.onclick = () => {
                if(owned) { st.eq[cat.k] = item; }
                else if(st.wallet >= cat.c) { st.wallet -= cat.c; st.owned.push(id); st.eq[cat.k] = item; }
                save(); renderStore(); updUI();
            };
            grid.appendChild(card);
        });
    });
}

function updUI() {
    document.getElementById('cur-score').innerText = st.score;
    document.getElementById('wallet-ui').innerText = '$' + st.wallet;
    document.getElementById('next-preview').innerText = SKINS[st.eq.sk][nextIdx];
    const pb = document.getElementById('prog-bar'); pb.innerHTML = '';
    for(let i=0; i<12; i++) pb.innerHTML += `<div style="opacity:${st.found.includes(i)?1:0.1}; font-size:18px">${SKINS[st.eq.sk][i]}</div>`;
}

function toggleModal(id) {
    const m = document.getElementById(id);
    const isO = m.classList.contains('open');
    document.querySelectorAll('.modal').forEach(x => x.classList.remove('open'));
    if(!isO) { m.classList.add('open'); if(id === 'shop-modal') renderStore(); }
}
function showToast() { const t = document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
function save() { localStorage.setItem('fm_v133', JSON.stringify(st)); }
</script>
</body>
</html>
