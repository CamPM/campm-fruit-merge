<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Merge v92</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc; --ui-border: #e2e8f0; --accent: #94a3b8; --text: #1e293b;
            --border-width: 12px;
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-color); color: var(--text); touch-action: none;
        }

        /* UI Framework */
        #top-ui { height: 175px; position: absolute; top: 0; width: 100%; border-bottom: var(--border-width) solid var(--ui-border); z-index: 10; background: inherit; box-sizing: border-box; padding: 15px; }
        #bottom-ui { height: 100px; position: absolute; bottom: 0; width: 100%; border-top: var(--border-width) solid var(--ui-border); display: flex; justify-content: space-around; align-items: center; z-index: 10; background: inherit; }
        
        #game-container { position: absolute; top: 175px; bottom: 100px; left: var(--border-width); right: var(--border-width); border-left: var(--border-width) solid var(--ui-border); border-right: var(--border-width) solid var(--ui-border); overflow: hidden; background: #ffffff; }
        
        /* Progress Bar Icons */
        #progress-list { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; }
        .tier-icon { filter: grayscale(1); opacity: 0.3; font-size: 1.2rem; transition: all 0.4s ease; }
        .tier-icon.unlocked { filter: grayscale(0); opacity: 1; transform: scale(1.1); }

        /* Store & Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { width: 85%; max-height: 70%; background: white; border-radius: 24px; padding: 25px; overflow-y: auto; touch-action: pan-y; }
        .store-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .store-item { padding: 15px; border: 1px solid #eee; border-radius: 12px; text-align: center; }

        .btn { padding: 10px 15px; border-radius: 12px; border: 1px solid var(--ui-border); background: #fff; font-weight: 600; cursor: pointer; }
        .danger-line { position: absolute; top: 195px; width: 100%; border-top: 2px dashed #ff8080; opacity: 0.6; z-index: 5; pointer-events: none; }
        
        #drop-preview { position: absolute; top: 10px; pointer-events: none; font-size: 2rem; transform: translateX(-50%); z-index: 8; opacity: 0.8; }
    </style>
</head>
<body>

<div id="top-ui">
    <div style="display:flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <div style="font-size: 0.8rem; opacity: 0.6;">SCORE</div>
            <div id="score" style="font-size: 1.5rem; font-weight: bold;">0</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.8rem; opacity: 0.6;">NEXT</div>
            <div id="next-preview" style="font-size: 1.5rem;"></div>
        </div>
        <div>
            <button class="btn" onclick="toggleFullscreen()">‚õ∂</button>
            <button class="btn" onclick="showModal('help')">?</button>
        </div>
    </div>
    <div id="progress-list"></div>
    <div style="text-align:center; margin-top: 10px; font-weight: bold;">$ <span id="wallet">0</span></div>
</div>

<div class="danger-line"></div>
<div id="game-container">
    <div id="drop-preview"></div>
</div>

<div id="bottom-ui">
    <button class="btn" onclick="activatePowerUp('bomb')">üí£</button>
    <button class="btn" onclick="activatePowerUp('broom')">üßπ</button>
    <button class="btn" onclick="activatePowerUp('wand')">ü™Ñ</button>
    <button class="btn" onclick="showModal('store')">üè™ Store</button>
</div>

<div id="help-modal" class="modal" onclick="closeModals()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>How to Play</h3>
        <p>Drop items to merge them! Two identical items create the next tier.</p>
        <p>Don't let them stack above the red line for 2 seconds!</p>
        <button class="btn" onclick="closeModals()">Got it</button>
    </div>
</div>

<div id="store-modal" class="modal" onclick="closeModals()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Store</h3>
        <div class="store-grid" id="store-items"></div>
        <button class="btn" style="width:100%; margin-top:20px" onclick="closeModals()">Close</button>
    </div>
</div>

<script>
/** * DATA & STATE
 */
const SKINS = {
    Fruit: ['üçí','üçì','üçá','üçä','üçé','üçê','üçë','üçç','üçà','üçâ','ü••','üéÉ'],
    Plants: ['üå±','üåµ','ü™¥','üå≤','üå≥','üå¥','üéã','üåø','üçÄ','üçÑ','üåª','üåπ'],
    Weather: ['‚òÅÔ∏è','üå§Ô∏è','‚ö°','‚òÄÔ∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','‚õàÔ∏è','‚ùÑÔ∏è','üå¨Ô∏è','üåà','üå™Ô∏è'],
    Shapes: ['‚ñ≤','‚ñ†','‚¨ì','‚¨¢','‚¨¶','‚¨ó','‚òÖ','‚óÜ','‚úö','‚¨ô','‚¨£','‚¨§'],
    Space: ['‚òÑÔ∏è','üõ∞Ô∏è','ü™ê','üåô','‚òÄÔ∏è','üî≠','üöÄ','üëΩ','üõ∏','üåå','üå†','üë©‚ÄçüöÄ'],
    Dessert: ['üç™','üç©','üßÅ','üç¶','üç∞','ü•ß','üç´','üç¨','üç≠','ŸÇ','üçØ','üéÇ']
};

let state = {
    score: 0, highScore: parseInt(localStorage.getItem('hs')) || 0,
    wallet: parseInt(localStorage.getItem('wallet')) || 1000,
    skin: 'Fruit', unlocked: new Set([0, 1]), next: 0
};

/** * AUDIO ENGINE (Chill Sine Wave)
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playChillTone(f, type='sine', d=0.5) {
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + d);
}

/** * PHYSICS ENGINE
 */
const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
const container = document.getElementById('game-container');
const engine = Engine.create({ gravity: { y: 1.5 } }); // Heavier gravity for better feel
const render = Render.create({
    element: container, engine: engine,
    options: { width: container.clientWidth, height: container.clientHeight, wireframes: false, background: 'transparent' }
});

// Walls & Floor
const wallOptions = { isStatic: true, render: { visible: false } };
const floor = Bodies.rectangle(container.clientWidth/2, container.clientHeight + 10, container.clientWidth, 20, wallOptions);
const leftWall = Bodies.rectangle(-10, container.clientHeight/2, 20, container.clientHeight, wallOptions);
const rightWall = Bodies.rectangle(container.clientWidth + 10, container.clientHeight/2, 20, container.clientHeight, wallOptions);
Composite.add(engine.world, [floor, leftWall, rightWall]);

function createItem(x, y, tier) {
    const radius = 15 + (tier * 7);
    const item = Bodies.circle(x, y, radius, {
        restitution: 0.3, friction: 0.1, slop: 0.05,
        render: { fillStyle: 'transparent' },
        plugin: { tier: tier }
    });
    Composite.add(engine.world, item);
    return item;
}

/** * INTERACTION
 */
const preview = document.getElementById('drop-preview');
container.addEventListener('pointermove', (e) => {
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    preview.style.left = `${x}px`;
    preview.innerText = SKINS[state.skin][state.next];
});

container.addEventListener('pointerup', (e) => {
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    createItem(x, 20, state.next);
    state.next = Math.floor(Math.random() * 4); // Standard drop tier 0-3
    updateUI();
    playChillTone(220, 'sine', 0.2);
});

// Merging Logic
Events.on(engine, 'collisionStart', (e) => {
    e.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        if(bodyA.plugin && bodyB.plugin && bodyA.plugin.tier === bodyB.plugin.tier) {
            const tier = bodyA.plugin.tier;
            if(tier < 11) {
                const newX = (bodyA.position.x + bodyB.position.x) / 2;
                const newY = (bodyA.position.y + bodyB.position.y) / 2;
                Composite.remove(engine.world, [bodyA, bodyB]);
                createItem(newX, newY, tier + 1);
                
                state.score += (tier + 1) * 10;
                state.wallet += (tier + 1);
                state.unlocked.add(tier + 1);
                playChillTone(300 + (tier * 40), 'sine', 0.6);
                updateUI();
            }
        }
    });
});

// Custom Rendering for Emojis
Events.on(render, 'afterRender', () => {
    const ctx = render.context;
    Composite.allBodies(engine.world).forEach(body => {
        if(body.plugin && body.plugin.tier !== undefined) {
            const tier = body.plugin.tier;
            const size = 15 + (tier * 7);
            ctx.font = `${size * 1.8}px serif`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.save();
            ctx.translate(body.position.x, body.position.y);
            ctx.rotate(body.angle);
            ctx.fillText(SKINS[state.skin][tier], 0, 0);
            ctx.restore();
        }
    });
});

/** * FUNCTIONS
 */
function updateUI() {
    document.getElementById('score').innerText = state.score;
    document.getElementById('wallet').innerText = state.wallet;
    document.getElementById('next-preview').innerText = SKINS[state.skin][state.next];
    
    const list = document.getElementById('progress-list');
    list.innerHTML = '';
    SKINS[state.skin].forEach((s, i) => {
        const span = document.createElement('span');
        span.className = `tier-icon ${state.unlocked.has(i) ? 'unlocked' : ''}`;
        span.innerText = s;
        list.appendChild(span);
    });
    localStorage.setItem('hs', state.score);
    localStorage.setItem('wallet', state.wallet);
}

function showModal(id) { 
    if(id === 'store') populateStore();
    document.getElementById(id + '-modal').style.display = 'flex'; 
}
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

function toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
}

function populateStore() {
    const grid = document.getElementById('store-items');
    grid.innerHTML = '';
    Object.keys(SKINS).forEach(s => {
        const item = document.createElement('div');
        item.className = 'store-item';
        item.innerHTML = `<div>${s}</div><div>$500</div>`;
        item.onclick = () => {
            if(state.wallet >= 500) {
                state.wallet -= 500;
                state.skin = s;
                closeModals();
                updateUI();
            }
        };
        grid.appendChild(item);
    });
}

function activatePowerUp(type) {
    if(type === 'broom') {
        const all = Composite.allBodies(engine.world).filter(b => b.plugin.tier < 3);
        Composite.remove(engine.world, all);
        playChillTone(100, 'sine', 1);
    }
    // Simple logic for demonstration - can be expanded to drag-and-drop
}

// Init
updateUI();
Render.run(render);
Runner.run(Runner.create(), engine);
</script>
</body>
</html>
