<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fruit Merge - v1.25</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --accent: #3498db; --bg: #FDF6E3; --font: -apple-system, system-ui, sans-serif; --panel: rgba(255,255,255,0.95); }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; touch-action: none; }
        
        /* UI LAYOUT */
        .ui-panel { position: absolute; width: 100%; z-index: 1000; pointer-events: none; }
        .top-bar { top: 0; height: 115px; background: var(--panel); border-bottom: 3px solid #333; pointer-events: auto; padding: 10px 20px; padding-top: env(safe-area-inset-top); }
        .bot-bar { bottom: 0; height: 100px; background: var(--panel); border-top: 3px solid #333; pointer-events: auto; display: flex; align-items: center; justify-content: space-evenly; padding-bottom: env(safe-area-inset-bottom); }
        
        .score-box { text-align: center; min-width: 60px; }
        #next-preview { width: 55px; height: 55px; border: 3px solid #333; border-radius: 50%; display: grid; place-items: center; font-size: 32px; background: #fff; box-shadow: 0 4px 0 #333; }
        
        /* BUTTONS */
        .pwr-btn { width: 48px; height: 48px; border-radius: 12px; border: 2px solid #333; color: white; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; pointer-events: auto; }
        .btn-small { width: 32px; height: 32px; font-size: 16px; position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: #95a5a6; border-radius: 50%; }
        #p-bomb { background: #e67e22; } #p-wipe { background: #9b59b6; } #p-evo { background: #f1c40f; }
        .pwr-btn.active { outline: 4px solid #2ecc71; transform: translateY(-5px); }

        /* MODALS & SCROLLING */
        .modal { display: none; position: absolute; inset: 20px; background: white; z-index: 5000; border-radius: 25px; border: 5px solid var(--accent); flex-direction: column; overflow: hidden; pointer-events: auto; }
        .modal.open { display: flex; }
        .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; touch-action: pan-y; -webkit-overflow-scrolling: touch; }
        
        /* STORE */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding-bottom: 20px; }
        .card { background: #f9f9f9; padding: 10px; border-radius: 15px; text-align: center; border: 2px solid #eee; }
        .card.equipped { border-color: #2ecc71; background: #f0fff4; }
        .preview-swatch { width: 40px; height: 40px; border-radius: 50%; margin: 5px auto; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        
        #game-over { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        #toast { position: absolute; top: 130px; left: 50%; transform: translateX(-50%); background: #ff4757; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; display: none; z-index: 10000; }
        .divider { width: 2px; height: 40px; background: #ccc; }
    </style>
</head>
<body>

<div id="toast">NEED MORE POINTS!</div>

<div id="game-over">
    <h1>GAME OVER</h1>
    <p>Score: <span id="final-score">0</span></p>
    <button onclick="restartGame()" style="padding:15px 40px; background:#2ecc71; color:white; border:none; border-radius:15px; font-weight:bold;">PLAY AGAIN</button>
</div>

<div class="ui-panel top-bar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="score-box"><b>SCORE</b><div id="cur-score" style="font-size:24px">0</div></div>
        <div id="next-preview"></div>
        <div class="score-box"><b>CASH</b><div id="wallet-ui" style="font-size:24px; color:#2ecc71">0</div></div>
    </div>
    <div id="prog-bar" style="display:flex; justify-content:space-around; margin-top:10px; background: rgba(0,0,0,0.05); border-radius: 10px; padding: 5px;"></div>
</div>

<div class="ui-panel bot-bar">
    <div id="p-bomb" class="pwr-btn" onclick="prepPower('bomb')">ðŸ’£</div>
    <div id="p-wipe" class="pwr-btn" onclick="prepPower('wipe')">ðŸ§¹</div>
    <div id="p-evo" class="pwr-btn" onclick="prepPower('evo')">ðŸª„</div>
    <div class="divider"></div>
    <div style="position: relative;">
        <button id="mute-btn" class="pwr-btn btn-small" onclick="toggleMute()">ðŸ”Š</button>
        <div class="pwr-btn" style="background:#95a5a6" onclick="toggleModal('help-modal')">?</div>
    </div>
    <div class="pwr-btn" style="background:#3498db; width:80px" onclick="toggleModal('shop-modal')">SHOP</div>
</div>

<div id="shop-modal" class="modal">
    <div class="modal-header"><h2>Store</h2><b onclick="toggleModal('shop-modal')" style="font-size:24px; cursor:pointer;">âœ•</b></div>
    <div class="modal-content" id="store-container"></div>
</div>

<div id="help-modal" class="modal">
    <div class="modal-header"><h2>How to Play</h2><b onclick="toggleModal('help-modal')" style="font-size:24px; cursor:pointer;">âœ•</b></div>
    <div class="modal-content">
        <h3>Objective</h3>
        <p>Drop items and merge matching pairs to evolve them. Reach the final tier to win!</p>
        <h3>Rules</h3>
        <ul>
            <li>Items merge when they touch a matching item.</li>
            <li>Don't let items stay above the <b>Red Death Line</b> for more than 2 seconds.</li>
            <li>Earn Cash by merging items. Use Cash in the Shop for themes and skins!</li>
        </ul>
        <h3>Power Ups</h3>
        <p><b>ðŸ’£ Bomb ($500):</b> Destroys all items in a small radius.</p>
        <p><b>ðŸ§¹ Wipe ($1000):</b> Clears every item of a specific tier from the board.</p>
        <p><b>ðŸª„ Evolve ($1500):</b> Instantly levels up every item of the selected tier.</p>
        <hr>
        <button onclick="requestFullscreen()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">ENTER FULLSCREEN</button>
        <p style="font-size:12px; text-align:center; color:#666; margin-top:10px;">Fullscreen improves experience on mobile devices.</p>
    </div>
</div>

<canvas id="c"></canvas>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, Ev=M.Events;

const SKINS = { 
    Fruit: ["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"], 
    Animals: ["ðŸž"," frogs ","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","ðŸ˜","ðŸ‹"], 
    Space: ["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"], 
    Dessert: ["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"], 
    Nature: ["ðŸ€","ðŸŒ¸","ðŸŒµ","ðŸŒ´","ðŸŒ²","ðŸ","ðŸ„","ðŸŒ»","ðŸŒŠ","ðŸ”¥","ðŸŒªï¸","ðŸŒˆ"],
    Sports: ["âš½","ðŸ€","ðŸˆ","âš¾","ðŸŽ¾","ðŸ","ðŸ‰","ðŸŽ±","ðŸ“","ðŸ’","ðŸ¥Š","ðŸ†"]
};
const THEMES = { 
    Mellow: "#FDF6E3", Matcha: "#E8F5E9", Midnight: "#1a1b26", Lavender: "#F3E5F5", Sky: "#E1F5FE", 
    Rose: "#FFF1F0", Slate: "#ECEFF1", Coffee: "#EFEBE9", Forest: "#E8F5E9", Lemon: "#FFFDE7", Mint: "#F1F8E9"
};
const BORDERS = { 
    Slate: "#657B83", Gold: "#DAA520", Red: "#DC143C", Neon: "#B026FF", Black: "#000000", 
    Blue: "#0D47A1", White: "#FFFFFF", Silver: "#C0C0C0", Pink: "#FF69B4", Green: "#2E7D32", Orange: "#EF6C00"
};
const OUTLINES = { 
    Default: "def", Rainbow: "rainbow", White: "white", Black: "black", Thin: "thin", 
    Thick: "thick", Dotted: "dotted", Glow: "glow", Blue: "blue", Red: "red", Gold: "gold"
};
const SIZES = [18, 24, 30, 38, 46, 55, 65, 76, 88, 102, 118, 135];

let st = {
    score: 0, high: 0, wallet: 0, muted: false,
    eq: { sk: 'Fruit', th: 'Mellow', bd: 'Slate', ot: 'Default' },
    owned: ['sk_Fruit', 'th_Mellow', 'bd_Slate', 'ot_Default'],
    found: new Set([0])
};

let engine, canvas, ctx, W, H, DL, FY, audioCtx;
let nextIdx = 1, curIdx = 0, canDrop = true, lastX = 150, activePower = null, floor, wallL, wallR;

function init() {
    load();
    canvas = document.getElementById('c'); ctx = canvas.getContext('2d');
    resize();
    window.addEventListener('resize', resize);

    engine = E.create({ gravity: { y: 1.2 } });
    
    Ev.on(engine, 'collisionStart', e => {
        e.pairs.forEach(p => {
            const a = p.bodyA, b = p.bodyB;
            if(a.plugin?.t !== undefined && b.plugin?.t !== undefined && a.plugin.t === b.plugin.t && a.plugin.t < 11) {
                const t = a.plugin.t, pos = { x: (a.position.x+b.position.x)/2, y: (a.position.y+b.position.y)/2 };
                C.remove(engine.world, [a, b]);
                spawnFruit(pos.x, pos.y, t + 1, false);
                st.score += (t+1)*10; st.wallet += (t+1);
                st.found.add(t+1);
                playPop(); updUI(); save();
            }
        });
    });

    loop();
}

function resize() {
    W = window.innerWidth; H = window.innerHeight;
    canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio;
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    DL = 125; FY = H - 105; 
    
    if(engine) {
        if(floor) C.remove(engine.world, [floor, wallL, wallR]);
        floor = B.rectangle(W/2, FY + 50, W, 100, { isStatic: true, friction: 0.5 });
        wallL = B.rectangle(-25, H/2, 50, H*2, { isStatic: true });
        wallR = B.rectangle(W+25, H/2, 50, H*2, { isStatic: true });
        C.add(engine.world, [floor, wallL, wallR]);
    }
}

function spawnFruit(x, y, t, isDrop) {
    const b = B.circle(x, y, SIZES[t], { restitution: 0.3, friction: 0.1, plugin: { t: t } });
    C.add(engine.world, b);
    if(isDrop) {
        curIdx = nextIdx; nextIdx = Math.floor(Math.random()*5);
        canDrop = false; setTimeout(() => canDrop = true, 500);
        updUI();
    }
}

function loop() {
    E.update(engine, 16);
    ctx.clearRect(0, 0, W, H);
    
    document.body.style.background = THEMES[st.eq.th] || THEMES.Mellow;
    ctx.fillStyle = BORDERS[st.eq.bd] || BORDERS.Slate;
    ctx.fillRect(0, 0, 15, H); ctx.fillRect(W-15, 0, 15, H);
    // Draw visual floor
    ctx.fillRect(0, FY, W, 5);

    // Death Line
    ctx.setLineDash([8,8]); ctx.strokeStyle="rgba(255,0,0,0.5)"; ctx.beginPath(); ctx.moveTo(15, DL); ctx.lineTo(W-15, DL); ctx.stroke(); ctx.setLineDash([]);

    const now = Date.now();
    C.allBodies(engine.world).forEach(b => {
        if(b.isStatic || !b.plugin) return;
        if(b.position.y - b.circleRadius < DL && b.speed < 0.5) {
            if(!b.tm) b.tm = now;
            if(now - b.tm > 2000) triggerGameOver();
        } else b.tm = null;

        const r = b.circleRadius, t = b.plugin.t;
        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
        
        ctx.lineWidth = st.eq.ot === 'thick' ? 6 : 3;
        if(st.eq.ot === 'rainbow') ctx.strokeStyle = `hsl(${now/5%360},100%,50%)`;
        else if(st.eq.ot === 'white') ctx.strokeStyle = "#fff";
        else if(st.eq.ot === 'black') ctx.strokeStyle = "#000";
        else if(st.eq.ot === 'blue') ctx.strokeStyle = "#3498db";
        else if(st.eq.ot === 'red') ctx.strokeStyle = "#e74c3c";
        else if(st.eq.ot === 'gold') ctx.strokeStyle = "#f1c40f";
        else ctx.strokeStyle = "#0002";
        
        if(st.eq.ot === 'dotted') ctx.setLineDash([4,4]);
        ctx.stroke();
        
        ctx.font = `${r*1.3}px serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk][t], 0, r*0.05);
        ctx.restore();
    });

    if(canDrop && !activePower) {
        ctx.strokeStyle="rgba(0,0,0,0.05)"; ctx.beginPath(); ctx.moveTo(lastX, DL); ctx.lineTo(lastX, FY); ctx.stroke();
        ctx.font="40px serif"; ctx.globalAlpha=0.4; ctx.textAlign="center";
        ctx.fillText(SKINS[st.eq.sk][curIdx], lastX, DL-20); ctx.globalAlpha=1;
    }
    requestAnimationFrame(loop);
}

function prepPower(type) {
    const costs = { bomb: 500, wipe: 1000, evo: 1500 };
    if(st.wallet >= costs[type]) {
        activePower = (activePower === type) ? null : type;
        document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
        if(activePower) document.getElementById('p-'+type).classList.add('active');
    } else showToast("NEED MORE CASH!");
}

function handlePower(x, y) {
    const bodies = C.allBodies(engine.world).filter(b => b.plugin);
    const costs = { bomb: 500, wipe: 1000, evo: 1500 };
    let success = false;

    if(activePower === 'bomb') {
        bodies.forEach(b => { if(M.Vector.magnitude(M.Vector.sub(b.position, {x,y})) < 80) C.remove(engine.world, b); });
        success = true;
    } else {
        const target = bodies.find(b => M.Bounds.contains(b.bounds, {x, y}));
        if(target) {
            const t = target.plugin.t;
            if(activePower === 'wipe') bodies.forEach(b => { if(b.plugin.t === t) C.remove(engine.world, b); });
            if(activePower === 'evo' && t < 11) bodies.forEach(b => { 
                if(b.plugin.t === t) { const p = b.position; C.remove(engine.world, b); spawnFruit(p.x, p.y, t+1, false); }
            });
            success = true;
        }
    }

    if(success) {
        st.wallet -= costs[activePower];
        activePower = null;
        document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
        playPop(); updUI(); save();
    }
}

function playPop() {
    if(st.muted) return;
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.frequency.setValueAtTime(400, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime+0.1);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.1);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1);
}

function requestFullscreen() {
    const de = document.documentElement;
    if (de.requestFullscreen) de.requestFullscreen();
    else if (de.webkitRequestFullscreen) de.webkitRequestFullscreen();
    else if (de.msRequestFullscreen) de.msRequestFullscreen();
}

function renderStore() {
    const container = document.getElementById('store-container'); container.innerHTML = '';
    const cats = [
        {title: 'Skins', key: 'sk', data: SKINS, cost: 1500},
        {title: 'Themes', key: 'th', data: THEMES, cost: 500},
        {title: 'Borders', key: 'bd', data: BORDERS, cost: 500},
        {title: 'Outlines', key: 'ot', data: OUTLINES, cost: 1000}
    ];

    cats.forEach(cat => {
        container.innerHTML += `<h3 style="margin:20px 0 10px; border-left: 4px solid var(--accent); padding-left:10px;">${cat.title}</h3><div class="grid" id="grid-${cat.key}"></div>`;
        const grid = document.getElementById(`grid-${cat.key}`);
        Object.keys(cat.data).forEach(item => {
            const id = cat.key + '_' + item;
            const isOwned = st.owned.includes(id);
            const isEq = st.eq[cat.key] === item;
            const card = document.createElement('div');
            card.className = `card ${isEq ? 'equipped' : ''}`;
            
            let swatch = '';
            if(cat.key === 'sk') swatch = `<div class="preview-swatch">${cat.data[item][0]}</div>`;
            else if(cat.key === 'th') swatch = `<div class="preview-swatch" style="background:${cat.data[item]}"></div>`;
            else if(cat.key === 'bd') swatch = `<div class="preview-swatch" style="border:4px solid ${cat.data[item]}"></div>`;
            else swatch = `<div class="preview-swatch" style="border:2px solid #333">Aa</div>`;

            card.innerHTML = `${swatch}<b>${item}</b><br><small style="color:${isOwned?'#2ecc71':'#e67e22'}">${isEq?'ACTIVE':isOwned?'OWNED':'$'+cat.cost}</small>`;
            card.onclick = () => {
                if(isOwned) { st.eq[cat.key] = item; }
                else if(st.wallet >= cat.cost) { st.wallet -= cat.cost; st.owned.push(id); st.eq[cat.key] = item; }
                else return showToast("NOT ENOUGH CASH!");
                save(); renderStore(); updUI();
            };
            grid.appendChild(card);
        });
    });
}

function toggleMute() { st.muted = !st.muted; document.getElementById('mute-btn').innerText = st.muted ? "ðŸ”‡" : "ðŸ”Š"; save(); }
function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
function triggerGameOver() { document.getElementById('final-score').innerText = st.score; document.getElementById('game-over').style.display = 'flex'; if(st.score > st.high) st.high = st.score; save(); }
function restartGame() { st.score = 0; st.found = new Set([0]); document.getElementById('game-over').style.display = 'none'; C.clear(engine.world, false); resize(); updUI(); }
function updUI() {
    document.getElementById('cur-score').innerText = st.score;
    document.getElementById('wallet-ui').innerText = st.wallet;
    document.getElementById('next-preview').innerText = SKINS[st.eq.sk][nextIdx];
    const pb = document.getElementById('prog-bar'); pb.innerHTML = '';
    for(let i=0; i<12; i++) pb.innerHTML += `<div style="opacity:${st.found.has(i)?1:0.2}; font-size:14px">${SKINS[st.eq.sk][i]}</div>`;
}
function save() { localStorage.setItem('fm_v125_save', JSON.stringify({...st, found: Array.from(st.found)})); }
function load() { 
    const d = localStorage.getItem('fm_v125_save'); 
    if(d) { let p = JSON.parse(d); Object.assign(st, p); st.found = new Set(p.found); } 
}
function toggleModal(id) { 
    document.querySelectorAll('.modal').forEach(m => { if(m.id !== id) m.classList.remove('open'); });
    document.getElementById(id).classList.toggle('open');
    if(id === 'shop-modal') renderStore();
}

window.addEventListener('pointermove', e => { lastX = Math.max(45, Math.min(W-45, e.clientX)); });
window.addEventListener('pointerup', e => {
    if(e.clientY < 115 || e.clientY > H-100) return;
    if(activePower) handlePower(e.clientX, e.clientY);
    else if(canDrop) spawnFruit(lastX, DL, curIdx, true);
});

window.onload = init;
</script>
</body>
</html>
