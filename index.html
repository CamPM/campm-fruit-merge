<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Fruit Merge v1.05</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root{--bg:#FDF6E3;--bd:#657B83;--txt:#586E75;--acc:#2AA198;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
*{box-sizing:border-box;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
body{margin:0;overflow:hidden;background:var(--bg);font-family:var(--font);color:var(--txt)}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;display:flex;flex-direction:column;justify-content:space-between}
.top{height:175px;padding:15px;background:linear-gradient(to bottom,rgba(255,255,255,.9),transparent);pointer-events:auto;text-align:center}
.row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.score{font-size:20px;font-weight:800} .lbl{font-size:9px;opacity:.7;text-transform:uppercase}
#next-box{width:50px;height:50px;border:2px dashed var(--bd);border-radius:50%;margin:0 auto;display:grid;place-items:center;font-size:24px;background:#fff}
.bar{display:flex;justify-content:space-between;background:rgba(0,0,0,.08);padding:6px;border-radius:15px;margin:8px 0}
.dot{width:15px;height:15px;border-radius:50%;background:rgba(0,0,0,0.1);display:grid;place-items:center;font-size:8px}
.dot.on{transform:scale(1.2);box-shadow:0 0 5px currentColor;background:#fff}
.wallet-row{font-weight:800;font-size:14px;color:var(--acc)}
.bot{height:100px;background:rgba(255,255,255,0.95);border-top:1px solid #0001;display:flex;justify-content:space-around;align-items:center;pointer-events:auto;padding-bottom:env(safe-area-inset-bottom)}
.btn{background:0;border:0;font-size:24px;display:flex;flex-direction:column;align-items:center;opacity:.6;cursor:pointer}
.btn.act{opacity:1;color:var(--acc)} .btn span{font-size:9px;font-weight:700}
.modal{position:absolute;top:0;left:0;width:100%;height:100%;background:#0008;z-index:99;display:none;align-items:center;justify-content:center;pointer-events:auto}
.modal.open{display:flex}
.card{background:#fff;width:90%;max-width:400px;height:80%;border-radius:20px;display:flex;flex-direction:column;overflow:hidden}
.shop-body{flex:1;overflow-y:auto;padding:15px;background:#f9f9f9}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.item{border:1px solid #eee;border-radius:12px;padding:12px;text-align:center;background:#fff}
.item.eq{border:2px solid var(--acc);background:#f0fdf4}
.cat-title{font-size:11px;font-weight:800;padding:10px 0;text-transform:uppercase;color:var(--acc);border-bottom:1px solid #eee;grid-column:span 2}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
    <div class="top">
        <div class="row">
            <div style="text-align:left"><div class="lbl">Score</div><div class="score" id="sCurrent">0</div></div>
            <div id="next-box"></div>
            <div style="text-align:right"><div class="lbl">Best</div><div class="score" id="sBest">0</div></div>
        </div>
        <div class="bar" id="prog"></div>
        <div class="wallet-row">üí∞ <span id="val-wallet">0</span></div>
    </div>
    <div class="bot">
        <button class="btn" onclick="toggleModal('m-info')">‚ùì<span>Info</span></button>
        <button class="btn" onclick="toggleStore()">üõí<span>Store</span></button>
        <button class="btn pwr" id="b-bomb" onclick="setTool('bomb')">üí£<span>Bomb</span></button>
        <button class="btn pwr" id="b-broom" onclick="setTool('broom')">üßπ<span>Broom</span></button>
        <button class="btn pwr" id="b-wand" onclick="setTool('wand')">ü™Ñ<span>Wand</span></button>
        <button class="btn" onclick="toggleFull()">‚õ∂<span>Full</span></button>
    </div>
</div>

<div class="modal" id="m-store"><div class="card"><div style="padding:15px;display:flex;justify-content:space-between;border-bottom:1px solid #eee"><b>Market</b><span onclick="toggleStore()" style="cursor:pointer">‚úï</span></div><div class="shop-body" id="shop-container"></div></div></div>
<div class="modal" id="m-info"><div class="card" style="height:auto;padding:20px"><h3>How to Play</h3><p>‚Ä¢ Drop items to merge identical tiers.<br>‚Ä¢ Reach Tier 12 to win!<br>‚Ä¢ Don't stay above the red line for 2 seconds.<br>‚Ä¢ üí£ <b>Bomb:</b> Clears area.<br>‚Ä¢ üßπ <b>Broom:</b> Clears all of 1 type.<br>‚Ä¢ ü™Ñ <b>Wand:</b> Level up 1 item.</p><button class="btn" style="background:var(--acc);color:#fff;padding:10px;border-radius:10px;opacity:1" onclick="toggleModal('m-info')">Got it!</button></div></div>
<div class="modal" id="m-over"><div style="text-align:center;color:#fff"><h1>GAME OVER</h1><button class="btn" style="background:#fff;color:#000;padding:10px 30px;border-radius:20px;opacity:1" onclick="reset()">Retry</button></div></div>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, Ev=M.Events, Q=M.Query;
const SKINS={'Fruit':['üçí','üçì','üçá','üçä','üçé','üçê','üçë','üçç','üçà','üçâ','ü••','ü•ù'],'Space':['üåë','‚òÑÔ∏è','üõ∞Ô∏è','üöÄ','üõ∏','üëæ','üî≠','üåå','ü™ê','‚òÄÔ∏è','üåÄ','üëΩ'],'Animals':['üêû','üê∏','üê¢','ü¶Ü','üêí','ü¶â','üêß','üê∫','ü¶ì','ü¶ç','üêò','üêã'],'Weather':['üíß','‚ùÑÔ∏è','üå™Ô∏è','üåà','‚òÄÔ∏è','‚òÅÔ∏è','‚õàÔ∏è','üå©Ô∏è','üå´Ô∏è','üå§Ô∏è','üå¨Ô∏è','‚òÇÔ∏è'],'Dessert':['üç¨','üç™','üç©','üç´','üçÆ','üç¶','üßÅ','üç∞','ü•ß','ü•û','üßá','üéÇ'],'Shapes':['üî¥','üü†','üü°','üü¢','üîµ','üü£','üü§','‚ö´','‚¨ú','üü¶','üüß','üü•'],'Music':['üéµ','üé∂','üé∏','üéπ','üé∫','üéª','üé∑','ü•Å','üé§','üéß','üìª','üéº'],'Plants':['üå±','üåø','‚òòÔ∏è','üçÄ','üåµ','üå¥','üå≥','üå≤','üçÇ','üçÅ','üçÑ','üåπ']};
const THEMES={'Mellow':'#FDF6E3','Matcha':'#E8F5E9','Midnight':'#1a1b26','Lavender':'#F3E5F5','Sky':'#E1F5FE','Sunset':'#FFF3E0','Slate':'#263238','Rose':'#FCE4EC'};
const BORDERS={'Slate':'#657B83','Gold':'#DAA520','Red':'#DC143C','Neon':'#B026FF','Black':'#000000','White':'#FFFFFF'};
const COLORS=['#F00','#F70','#FF0','#0F0','#00F','#4B0','#940','#F14','#0CE','#FD7','#F45','#32C'];

let st={s:0, w:parseInt(localStorage.getItem('f5_w')||0), h:parseInt(localStorage.getItem('f5_h')||0), inv:JSON.parse(localStorage.getItem('f5_i')||'["sk_Fruit","ot_def","th_Mellow","bd_Slate"]'), 
    eq:JSON.parse(localStorage.getItem('f5_e')||'{"sk":"Fruit","ot":"def","th":"Mellow","bd":"Slate"}'), next:0, drag:0, x:0, y:0, drop:1, over:0, tool:null, max:-1, audInit:0};

const cv=document.getElementById('c'), cx=cv.getContext('2d'), eng=E.create();
let W, H, aud;

function rsz(){
    W=window.innerWidth; H=window.innerHeight;
    cv.width=W*devicePixelRatio; cv.height=H*devicePixelRatio;
    cx.scale(devicePixelRatio,devicePixelRatio);
    C.clear(eng.world,0,1);
    const t=150; // Extra thick floor
    const floor=B.rectangle(W/2,H-100+t/2,W,t,{isStatic:1,friction:0.5,label:'floor'});
    const lw=B.rectangle(0,H/2,30,H*2,{isStatic:1});
    const rw=B.rectangle(W,H/2,30,H*2,{isStatic:1});
    C.add(eng.world,[floor,lw,rw]);
}
window.onresize=rsz; rsz();

Ev.on(eng,'collisionStart',e=>{
    e.pairs.forEach(p=>{
        const a=p.bodyA, b=p.bodyB;
        if(a.tier!==undefined && b.tier!==undefined && a.tier===b.tier && a.tier<11){
            const n=a.tier+1, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
            C.remove(eng.world,[a,b]);
            const nb=B.circle(pos.x,pos.y,10+(n*6),{restitution:0.3}); nb.tier=n; C.add(eng.world,nb);
            updSc((n+1)*10); updPrg(n);
        }
    });
});

function loop(){
    E.update(eng,16); cx.clearRect(0,0,W,H);
    document.body.style.background=THEMES[st.eq.th];
    const dl=195;
    cx.beginPath(); cx.moveTo(15,dl); cx.lineTo(W-15,dl); cx.strokeStyle='#F44'; cx.setLineDash([5,5]); cx.stroke(); cx.setLineDash([]);
    cx.fillStyle=BORDERS[st.eq.bd]; cx.globalAlpha=0.5; cx.fillRect(0,0,15,H); cx.fillRect(W-15,0,15,H); cx.globalAlpha=1;

    C.allBodies(eng.world).forEach(b=>{
        if(b.isStatic || b.tier===undefined) return;
        if(b.position.y-b.circleRadius < dl && b.speed<0.5){ if(!b.tm) b.tm=Date.now(); if(Date.now()-b.tm>2000) over(); } else b.tm=null;
        const r=b.circleRadius; cx.translate(b.position.x,b.position.y); cx.rotate(b.angle);
        cx.shadowColor=COLORS[b.tier]; cx.shadowBlur=10; cx.fillStyle='#fff'; cx.beginPath(); cx.arc(0,0,r,0,6.28); cx.fill();
        cx.shadowBlur=0; cx.strokeStyle=st.eq.ot==='def'?'#0002':(st.eq.ot==='white'?'#fff':'#000'); cx.stroke();
        cx.font=`${r*1.4}px serif`; cx.textAlign='center'; cx.textBaseline='middle'; cx.fillStyle='#000'; cx.fillText(SKINS[st.eq.sk][b.tier],0,0);
        cx.rotate(-b.angle); cx.translate(-b.position.x,-b.position.y);
    });

    if(st.drag && st.drop && !st.tool){
        let gx=Math.max(35,Math.min(W-35,st.x));
        cx.beginPath(); cx.moveTo(gx,dl); cx.lineTo(gx,H-100); cx.strokeStyle='#aaa'; cx.setLineDash([5,5]); cx.stroke();
        cx.font="30px serif"; cx.globalAlpha=0.4; cx.fillText(SKINS[st.eq.sk][st.next],gx,dl-20); cx.globalAlpha=1;
    }
    if(!st.over) requestAnimationFrame(loop);
}

function ptr(e,t){
    const touch=e.touches?e.touches[0]:e; const r=cv.getBoundingClientRect();
    st.x=(touch.clientX-r.left)*(W/r.width); st.y=(touch.clientY-r.top)*(H/r.height);
    if(t==='d' && !e.target.closest('button,.modal')) st.drag=1;
    if(t==='u' && st.drag){ st.drag=0; act(); }
};
function act(){
    let bs=C.allBodies(eng.world);
    if(st.tool){
        if(st.tool==='bomb'){ C.remove(eng.world, bs.filter(b=>!b.isStatic && M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y}))<90)); }
        else {
            let target=Q.point(bs,{x:st.x,y:st.y})[0];
            if(target && target.tier!==undefined){
                if(st.tool==='broom') C.remove(eng.world, bs.filter(b=>b.tier===target.tier));
                if(st.tool==='wand' && target.tier<11){
                    let t=target.tier, p=target.position; C.remove(eng.world, target);
                    let nb=B.circle(p.x,p.y,10+(t+1)*6,{restitution:0.3}); nb.tier=t+1; C.add(eng.world,nb);
                }
            }
        }
        st.tool=null; document.querySelectorAll('.pwr').forEach(b=>b.classList.remove('act'));
    } else if(st.drop){
        const b=B.circle(Math.max(35,Math.min(W-35,st.x)),100,10+(st.next*6),{restitution:0.3});
        b.tier=st.next; C.add(eng.world,b);
        st.next=Math.floor(Math.random()*5); updPre(); st.drop=0; setTimeout(()=>st.drop=1,500);
    }
}
['down','move','up'].forEach(e=>window.addEventListener('pointer'+e, x=>ptr(x,e[0])));

function updSc(n){ st.s+=n; st.w+=Math.floor(n/10); document.getElementById('sCurrent').innerText=st.s; document.getElementById('val-wallet').innerText=st.w; if(st.s>st.h){st.h=st.s; document.getElementById('sBest').innerText=st.h;} save(); }
function updPrg(t){ if(t>st.max){st.max=t; renderPrg();} }
function updPre(){ document.getElementById('next-box').innerText=SKINS[st.eq.sk][st.next]; }
function renderPrg(){ const d=document.getElementById('prog'); d.innerHTML=''; for(let i=0;i<12;i++) d.innerHTML+=`<div class="dot ${i<=st.max?'on':''}" style="color:${COLORS[i]}">${i<=st.max?SKINS[st.eq.sk][i]:''}</div>`; }
function save(){ localStorage.setItem('f5_i',JSON.stringify(st.inv)); localStorage.setItem('f5_e',JSON.stringify(st.eq)); localStorage.setItem('f5_h',st.h); localStorage.setItem('f5_w',st.w); }
function toggleModal(id){ const m=document.getElementById(id); m.classList.toggle('open'); }
function reset(){ location.reload(); }
function toggleFull(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

function toggleStore(){
    document.getElementById('m-store').classList.toggle('open');
    if(document.getElementById('m-store').classList.contains('open')){
        const container=document.getElementById('shop-container'); container.innerHTML='<div class="grid" id="sg"></div>'; const g=document.getElementById('sg');
        const items = [
            ...Object.keys(SKINS).map(k=>({id:'sk_'+k,cat:'Skins',n:k,p:500,v:k})),
            {id:'ot_def',cat:'Outlines',n:'Soft',p:0,v:'def'},{id:'ot_white',cat:'Outlines',n:'White',p:2000,v:'white'},{id:'ot_black',cat:'Outlines',n:'Black',p:2000,v:'black'},
            ...Object.keys(THEMES).map(k=>({id:'th_'+k,cat:'Themes',n:k,p:300,v:k})),
            ...Object.keys(BORDERS).map(k=>({id:'bd_'+k,cat:'Borders',n:k,p:200,v:k}))
        ];
        ['Skins','Outlines','Themes','Borders'].forEach(cat=>{
            g.innerHTML+=`<div class="cat-title">${cat}</div>`;
            items.filter(i=>i.cat===cat).forEach(i=>{
                const own=st.inv.includes(i.id), eq=(st.eq.sk==i.v||st.eq.ot==i.v||st.eq.th==i.v||st.eq.bd==i.v);
                let prv = i.n;
                if(cat==='Skins') prv=SKINS[i.v][0];
                if(cat==='Themes') prv=`<div style="width:20px;height:20px;background:${THEMES[i.v]};border-radius:50%;margin:0 auto"></div>`;
                if(cat==='Borders') prv=`<div style="width:20px;height:20px;background:${BORDERS[i.v]};border-radius:50%;margin:0 auto"></div>`;
                const el=document.createElement('div'); el.className=`item ${eq?'eq':''}`;
                el.innerHTML=`${prv}<br><b>${i.n}</b><br><small>${own?(eq?'EQ':'‚úì'):'$'+i.p}</small>`;
                el.onclick=()=>{
                    if(own){ if(cat==='Skins')st.eq.sk=i.v; if(cat==='Outlines')st.eq.ot=i.v; if(cat==='Themes')st.eq.th=i.v; if(cat==='Borders')st.eq.bd=i.v; }
                    else if(st.w>=i.p){ st.w-=i.p; st.inv.push(i.id); }
                    save(); toggleStore(); toggleStore(); updPre(); renderPrg(); document.getElementById('val-wallet').innerText=st.w;
                };
                g.appendChild(el);
            });
        });
    }
}
function setTool(t){ st.tool=(st.tool===t?null:t); document.querySelectorAll('.pwr').forEach(b=>b.classList.toggle('act',b.id==='b-'+st.tool)); }

document.getElementById('sBest').innerText=st.h; document.getElementById('val-wallet').innerText=st.w; updPre(); renderPrg(); loop();
</script></body></html>
