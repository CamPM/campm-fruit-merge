<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Merge v91</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --ui-border: #d1d9e6;
            --accent: #a3b1c6;
            --text: #4a4a4a;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color); touch-action: none;
        }

        /* UI Layout */
        #top-ui { height: 175px; position: absolute; top: 0; width: 100%; border-bottom: 2px solid var(--ui-border); display: flex; flex-direction: column; justify-content: space-around; padding: 10px; box-sizing: border-box; z-index: 10; background: inherit; }
        #bottom-ui { height: 100px; position: absolute; bottom: 0; width: 100%; border-top: 2px solid var(--ui-border); display: flex; justify-content: space-around; align-items: center; z-index: 10; background: inherit; }
        
        #game-container { position: absolute; top: 175px; bottom: 100px; width: 100%; overflow: hidden; }
        
        /* Progress Bar */
        #progress-wrapper { width: 90%; margin: 0 auto; height: 30px; position: relative; background: rgba(0,0,0,0.05); border-radius: 15px; }
        #progress-list { display: flex; justify-content: space-between; padding: 0 10px; position: absolute; top: -20px; width: 100%; }
        .tier-icon { opacity: 0.3; transition: 0.3s; font-size: 1.2rem; }
        .tier-icon.unlocked { opacity: 1; transform: scale(1.2); }

        /* Modals */
        .modal { display: none; position: fixed; top: 10%; left: 5%; width: 90%; height: 80%; background: white; border-radius: 20px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.2); flex-direction: column; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; touch-action: pan-y; }
        
        .btn { padding: 10px 20px; border-radius: 10px; border: 1px solid var(--ui-border); background: #fff; cursor: pointer; }
        .danger-line { position: absolute; top: 195px; width: 100%; border-top: 2px dashed #ff4d4d; opacity: 0.5; pointer-events: none; }
        
        canvas { display: block; }
    </style>
</head>
<body>

<div id="top-ui">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div>Score: <span id="score">0</span> | Best: <span id="best">0</span></div>
        <div>Next: <span id="next-preview"></span></div>
        <div>
            <button class="btn" onclick="toggleFullscreen()">‚õ∂</button>
            <button class="btn" onclick="showModal('help')">?</button>
        </div>
    </div>
    <div id="progress-wrapper">
        <div id="progress-list"></div>
    </div>
    <div style="text-align:center">Wallet: $<span id="wallet">0</span></div>
</div>

<div class="danger-line"></div>
<div id="game-container"></div>

<div id="bottom-ui">
    <button class="btn power-up" data-type="bomb">üí£ Bomb</button>
    <button class="btn power-up" data-type="broom">üßπ Broom</button>
    <button class="btn power-up" data-type="wand">ü™Ñ Wand</button>
    <button class="btn" onclick="showModal('store')">üè™ Store</button>
</div>

<div id="store-modal" class="modal">
    <div class="modal-content">
        <h2>Store (44 Items)</h2>
        <div id="store-items"></div>
    </div>
    <button class="btn" onclick="closeModals()">Close</button>
</div>

<script>
/** * CONFIGURATION & DATA
 */
const SKINS = {
    Fruit: ['üçí','üçì','üçá','üçä','üçé','üçê','üçë',' Pineapple ','üçà','üçâ','ü••','üéÉ'],
    Plants: ['üå±','üåµ','ü™¥','üå≤','üå≥','üå¥','üéã','üåø','üçÄ','üçÑ','üåª','üåπ'],
    Weather: ['‚òÅÔ∏è','üå§Ô∏è','‚ö°','‚òÄÔ∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','‚õàÔ∏è','‚ùÑÔ∏è','üå¨Ô∏è','üåà','üå™Ô∏è'],
    Shapes: ['‚ñ≤','‚ñ†','‚¨ì','‚¨¢','‚¨¶','‚¨ó','‚òÖ','‚óÜ','‚úö','‚¨ô','‚¨£','‚¨§'],
    Space: ['‚òÑÔ∏è','üõ∞Ô∏è','ü™ê','üåô','‚òÄÔ∏è','üî≠','üöÄ','üëΩ','üõ∏','üåå','üå†','üë©‚ÄçüöÄ'],
    Dessert: ['üç™','üç©','üßÅ','üç¶','üç∞','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üéÇ']
    // ... other skins added via shop
};

let state = {
    score: 0,
    highScore: localStorage.getItem('highScore') || 0,
    wallet: parseInt(localStorage.getItem('wallet')) || 0,
    currentSkin: 'Fruit',
    unlockedTiers: new Set([0]),
    nextTier: 0
};

/** * AUDIO ENGINE (Web Audio API)
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playTone(freq, type = 'sine', duration = 0.2) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

const skinSounds = {
    Fruit: 200, Space: 100, Shapes: 400, Dessert: 300, Plants: 150
};

/** * MATTER.JS PHYSICS
 */
const { Engine, Render, Runner, Bodies, Composite, Events, Mouse, MouseConstraint } = Matter;
const container = document.getElementById('game-container');
const engine = Engine.create();
const render = Render.create({
    element: container,
    engine: engine,
    options: {
        width: window.innerWidth,
        height: window.innerHeight - 275,
        wireframes: false,
        background: 'transparent'
    }
});

const ground = Bodies.rectangle(window.innerWidth/2, window.innerHeight - 275, window.innerWidth, 20, { 
    isStatic: true, render: { fillStyle: 'transparent' } 
});
Composite.add(engine.world, ground);

/** * GAME LOGIC
 */
function createFruit(x, y, tier, isStatic = false) {
    const size = 20 + (tier * 8);
    const fruit = Bodies.circle(x, y, size, {
        restitution: 0.4,
        friction: 0.1,
        label: 'fruit',
        plugin: { tier: tier }
    });
    
    fruit.render.sprite = null; // We use Canvas drawing for emojis
    Composite.add(engine.world, fruit);
    return fruit;
}

// Render Loop for Emojis
Events.on(render, 'afterRender', () => {
    const ctx = render.context;
    const bodies = Composite.allBodies(engine.world);
    
    bodies.forEach(body => {
        if(body.label === 'fruit') {
            const tier = body.plugin.tier;
            const emoji = SKINS[state.currentSkin][tier];
            const size = 20 + (tier * 8);
            ctx.font = `${size * 1.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.save();
            ctx.translate(body.position.x, body.position.y);
            ctx.rotate(body.angle);
            ctx.fillText(emoji, 0, 0);
            ctx.restore();
        }
    });
});

// Merging Logic
Events.on(engine, 'collisionStart', (event) => {
    event.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        if(bodyA.label === 'fruit' && bodyB.label === 'fruit' && bodyA.plugin.tier === bodyB.plugin.tier) {
            const nextTier = bodyA.plugin.tier + 1;
            if(nextTier < 12) {
                const midX = (bodyA.position.x + bodyB.position.x) / 2;
                const midY = (bodyA.position.y + bodyB.position.y) / 2;
                
                Composite.remove(engine.world, [bodyA, bodyB]);
                createFruit(midX, midY, nextTier);
                
                state.score += (nextTier * 10);
                updateUI(nextTier);
                playTone(500 + (nextTier * 50), 'triangle'); // Merge "pop"
            }
        }
    });
});

/** * INITIALIZATION & CONTROLS
 */
function init() {
    updateUI();
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);
    
    container.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        const x = touch.clientX;
        dropFruit(x);
    });
}

function dropFruit(x) {
    const tier = state.nextTier;
    createFruit(x, 50, tier);
    state.nextTier = Math.floor(Math.random() * 3);
    document.getElementById('next-preview').innerText = SKINS[state.currentSkin][state.nextTier];
    playTone(skinSounds[state.currentSkin] || 200, 'sine', 0.1);
}

function updateUI(unlockedTier = null) {
    if(unlockedTier !== null) state.unlockedTiers.add(unlockedTier);
    document.getElementById('score').innerText = state.score;
    document.getElementById('wallet').innerText = state.wallet;
    
    const list = document.getElementById('progress-list');
    list.innerHTML = '';
    SKINS[state.currentSkin].forEach((emoji, i) => {
        const span = document.createElement('span');
        span.className = `tier-icon ${state.unlockedTiers.has(i) ? 'unlocked' : ''}`;
        span.innerText = emoji;
        list.appendChild(span);
    });
}

function showModal(id) { document.getElementById(id + '-modal').style.display = 'flex'; }
function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

init();
</script>
</body>
</html>
