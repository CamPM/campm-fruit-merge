<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fruit Merge v60</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: system-ui, sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #E6E6FA; border: 8px solid #333; box-sizing: border-box; overflow: hidden; }
        
        #top-ui { position: absolute; top: 0; left: 0; width: 100%; height: 135px; background: rgba(255,255,255,0.95); border-bottom: 3px solid #333; z-index: 1000; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        #bottom-ui { position: absolute; bottom: 0; left: 0; width: 100%; height: 95px; background: #fff; border-top: 3px solid #333; z-index: 1000; display: flex; align-items: center; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); }
        
        #progress-wrap { width: 100%; height: 32px; background: #ddd; border-radius: 16px; margin-top: 5px; border: 2px solid #333; position: relative; overflow: hidden; }
        #progress-bar { height: 100%; background: #2ecc71; width: 0%; transition: width 0.4s; }
        #progress-icons { position: absolute; width: 100%; top: 0; display: flex; justify-content: space-between; padding: 0 6px; box-sizing: border-box; font-size: 11px; line-height: 28px; pointer-events: none; }

        .stats { display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; color: #333; }
        .btn { width: 52px; height: 52px; border-radius: 12px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; background: #eee; box-shadow: 0 4px 0 #999; position: relative; }
        .btn span { position: absolute; bottom: -12px; font-size: 10px; background: white; border: 1px solid #333; padding: 0 4px; border-radius: 4px; }
        
        #controls-overlay { position: absolute; top: 145px; right: 15px; z-index: 1001; display: flex; flex-direction: column; gap: 10px; }
        .sub-btn { background: #3498db; color: white; border: 2px solid #333; padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }

        .modal { display: none; position: fixed; inset: 5% 8%; background: white; z-index: 2000; border: 4px solid #333; border-radius: 20px; padding: 20px; overflow-y: auto; }
        .store-section { margin-bottom: 25px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .item-card { border: 2px solid #ccc; padding: 10px; border-radius: 12px; text-align: center; position: relative; }
        .item-card.selected { border-color: #2ecc71; background: #e8f8f0; border-width: 3px; }
        .badge { font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 10px; position: absolute; top: -8px; right: -5px; border: 1px solid #333; color: #fff; }

        #status-msg { position: absolute; top: 185px; width: 100%; text-align: center; font-weight: bold; color: #e67e22; z-index: 500; font-size: 18px; display: none; pointer-events: none; }
        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="top-ui">
        <div class="stats"><span>SCORE: <span id="s-val">0</span></span><span>BEST: <span id="h-val">0</span></span></div>
        <div id="next-disp" style="text-align:center; font-size:38px; height: 45px; line-height: 45px;"></div>
        <div id="progress-wrap"><div id="progress-bar"></div><div id="progress-icons"></div></div>
        <div class="stats" style="margin-top:8px"><span>WALLET: $<span id="w-val">0</span></span><span id="mute-btn" onclick="toggleMute()" style="cursor:pointer">ðŸ”Š</span></div>
    </div>

    <div id="status-msg">DRAG TO TARGET</div>

    <div id="controls-overlay">
        <div class="sub-btn" onclick="openHelp()" style="background:#f1c40f; color:#333;">?</div>
        <div class="sub-btn" onclick="toggleFullScreen()">â›¶</div>
    </div>

    <div id="bottom-ui">
        <div class="btn" style="background:#e67e22" onpointerdown="prepPwr('bomb', event)">ðŸ’£<span>$500</span></div>
        <div class="btn" style="background:#9b59b6" onpointerdown="prepPwr('wipe', event)">ðŸ§¹<span>$1k</span></div>
        <div class="btn" style="background:#f1c40f" onpointerdown="prepPwr('evo', event)">âœ¨<span>$1.5k</span></div>
        <div class="btn" style="background:#3498db; width: 85px; font-size: 13px; font-weight: bold; color:white;" onclick="openShop()">STORE</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="helpModal" class="modal">
        <h2 style="text-align:center">Instructions</h2>
        <p><b>Objective:</b> Merge identical items to evolve them. Reach the end of the bar to win big!</p>
        <hr>
        <p><b>ðŸ’£ Bomb ($500):</b> Destroys all items in a medium radius. Great for clearing space.</p>
        <p><b>ðŸ§¹ Broom ($1k):</b> Drag onto a specific item to delete ALL items of that same type.</p>
        <p><b>âœ¨ Sparkle ($1.5k):</b> Drag onto an item to upgrade ALL items of that type to the next level.</p>
        <button class="sub-btn" onclick="closeModal()" style="width:100%; border-radius:10px; height: 50px; margin-top: 10px;">GOT IT!</button>
    </div>

    <div id="shopModal" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h2>Store</h2><button onclick="closeModal()">X</button></div>
        <p style="text-align:center; font-weight:bold; color:#2ecc71;">Wallet: $<span id="shop-wallet">0</span></p>
        <div class="store-section"><h3>Skins</h3><div id="skin-grid" class="grid"></div></div>
        <div class="store-section"><h3>Themes</h3><div id="theme-grid" class="grid"></div></div>
    </div>
</div>

<script>
const SKINS = { Fruit: ["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸŽƒ"], Animals: ["ðŸ­","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ¦","ðŸ¯","ðŸ·","ðŸ¸","ðŸ™","ðŸ³","ðŸ¦„"], Retro: ["â–²","â– ","â¬¢","â—†","â˜…","âœš","âœ–","â¬¤","â¬Ÿ","â–¼","â¬“","âŒ¬"], Space: ["â˜„ï¸","ðŸ›°ï¸","ðŸª","ðŸŒ™","â˜€ï¸","ðŸ”­","ðŸš€","ðŸ‘½","ðŸ›¸","ðŸŒŒ","ðŸŒ ","ðŸ‘¨â€ðŸš€"], Desserts: ["ðŸª","ðŸ©","ðŸ§","ðŸ¦","ðŸ°","ðŸ¥§","ðŸ«","ðŸ¬","ðŸ­","ðŸ®","ðŸ¯","ðŸŽ‚"], Cars: ["ðŸŽï¸","ðŸš—","ðŸš•","ðŸš™","ðŸšŒ","ðŸš","ðŸš›","ðŸšœ","ðŸš“","ðŸš‘","ðŸš’","ðŸš€"], Plants: ["ðŸŒ¿","ðŸŒµ","ðŸª´","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŽ‹","ðŸŒ¿","ðŸ€","ðŸ„","ðŸŒ»","ðŸŒ¹"] };
const THEMES = { Lilac: "#E6E6FA", Sunset: "#ff7675", Forest: "#55efc4", Midnight: "#2d3436", Gold: "#fdcb6e", Slate: "#718093", Ocean: "#0984e3", Cherry: "#d63031", Mint: "#00b894", Grape: "#6c5ce7", Pumpkin: "#e67e22", Coffee: "#634832", Rose: "#fd79a8", Sky: "#81ecec", Grass: "#26de81", Charcoal: "#2f3640" };
const SIZES = [22, 30, 38, 48, 60, 74, 88, 104, 122, 140, 160, 185];
const COLORS = ["#ff7979", "#ffbe76", "#f6e58d", "#badc58", "#7ed6df", "#686de0", "#4834d4", "#f0932b", "#eb4d4b", "#6ab04c", "#130f40", "#222f3e"];

let state = { score: 0, best: 0, pts: 0, skin: 'Fruit', theme: 'Lilac', owned: ['Fruit', 'Lilac'], muted: false, maxT: 0 };
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let engine, runner, currentIdx = 0, nextIdx = 1, lastX = 200, isDragging = false, canDrop = true;
let activePwr = null, pwrX = 0, pwrY = 0;
let ground, leftWall, rightWall;

// AUDIO ENGINE
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type, freq = 440) {
    if(state.muted) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = type === 'pop' ? 'sine' : 'triangle';
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

function init() {
    const saved = localStorage.getItem('fm_v60_save');
    if(saved) Object.assign(state, JSON.parse(saved));
    engine = Matter.Engine.create();
    setupDimensions();

    Matter.Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            const a = p.bodyA, b = p.bodyB;
            // Merge logic
            if(a.plugin && b.plugin && a.plugin.t === b.plugin.t && a.plugin.t < 11) {
                const nt = a.plugin.t + 1;
                state.maxT = Math.max(state.maxT, nt);
                playSound('pop', 600 + (nt * 50));
                const pos = { x: (a.position.x+b.position.x)/2, y: (a.position.y+b.position.y)/2 };
                Matter.Composite.remove(engine.world, [a, b]);
                Matter.Composite.add(engine.world, Matter.Bodies.circle(pos.x, pos.y, SIZES[nt], { plugin: {t: nt, dT: null} }));
                state.score += nt * 10; state.pts += nt * 5;
                save(); updateUI();
            } else if (p.collision.depth > 2) {
                // Thud logic based on skin index
                const t = a.plugin ? a.plugin.t : (b.plugin ? b.plugin.t : 0);
                playSound('thud', 100 + (t * 20));
            }
        });
    });

    runner = Matter.Runner.create();
    Matter.Runner.run(runner, engine);
    window.addEventListener('resize', handleResize);
    requestAnimationFrame(renderLoop);
    updateUI();
}

function handleResize() {
    const oldW = canvas.width;
    setupDimensions();
    Matter.Composite.allBodies(engine.world).forEach(b => {
        if(!b.isStatic) Matter.Body.setPosition(b, { x: b.position.x * (canvas.width / oldW), y: b.position.y });
    });
}

function setupDimensions() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    if (ground) Matter.Composite.remove(engine.world, [ground, leftWall, rightWall]);
    const floorY = canvas.height - 95;
    ground = Matter.Bodies.rectangle(canvas.width/2, floorY + 100, canvas.width, 200, { isStatic: true });
    leftWall = Matter.Bodies.rectangle(-25, canvas.height/2, 50, canvas.height, { isStatic: true });
    rightWall = Matter.Bodies.rectangle(canvas.width+25, canvas.height/2, 50, canvas.height, { isStatic: true });
    Matter.Composite.add(engine.world, [ground, leftWall, rightWall]);
}

function renderLoop() {
    ctx.fillStyle = THEMES[state.theme]; ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.strokeStyle = "red"; ctx.setLineDash([10, 5]); ctx.beginPath(); ctx.moveTo(0, 175); ctx.lineTo(canvas.width, 175); ctx.stroke(); ctx.setLineDash([]);

    if(isDragging && !activePwr) {
        ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.beginPath(); ctx.moveTo(lastX, 135); ctx.lineTo(lastX, canvas.height - 95); ctx.stroke();
        ctx.font = "40px Arial"; ctx.textAlign = "center"; ctx.fillText(SKINS[state.skin][currentIdx], lastX, 160);
    }

    const bodies = Matter.Composite.allBodies(engine.world).filter(b => b.plugin && b.plugin.t !== undefined);
    
    // Find highlighted target for powerups
    let targetType = -1;
    if(activePwr && activePwr !== 'bomb') {
        const hit = bodies.find(b => Math.hypot(b.position.x - pwrX, b.position.y - pwrY) < b.circleRadius + 40);
        if(hit) targetType = hit.plugin.t;
    }

    bodies.forEach(b => {
        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        // Highlight logic
        if((activePwr === 'bomb' && Math.hypot(b.position.x-pwrX, b.position.y-pwrY) < 100) || (targetType !== -1 && b.plugin.t === targetType)) {
            ctx.shadowBlur = 20; ctx.shadowColor = "white";
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(0,0,b.circleRadius+4,0,Math.PI*2); ctx.fill();
        }
        ctx.fillStyle = COLORS[b.plugin.t]; ctx.beginPath(); ctx.arc(0,0,b.circleRadius,0,Math.PI*2); ctx.fill();
        ctx.font = (b.circleRadius * 1.4) + "px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[state.skin][b.plugin.t], 0, 0); ctx.restore();

        if(b.position.y < 175 && !b.isStatic && !isDragging) {
            if(!b.plugin.dT) b.plugin.dT = Date.now();
            if(Date.now() - b.plugin.dT > 3000) { 
                state.score = 0; state.maxT = 0; save(); alert("GAME OVER!"); location.reload(); 
            }
        } else { b.plugin.dT = null; }
    });

    if(activePwr) {
        ctx.fillStyle = "rgba(255, 255, 255, 0.2)"; ctx.beginPath(); 
        ctx.arc(pwrX, pwrY, (activePwr==='bomb'?100:40), 0, Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(renderLoop);
}

function prepPwr(type, e) {
    const cost = {bomb:500, wipe:1000, evo:1500}[type];
    if(state.pts < cost) { alert("Insufficient funds!"); return; }
    activePwr = type; pwrX = e.clientX; pwrY = e.clientY;
    document.getElementById('status-msg').style.display = 'block';
}

canvas.addEventListener('pointerdown', (e) => {
    if(e.clientY > canvas.height - 95 || e.clientY < 135) return;
    isDragging = true; lastX = e.clientX;
});
canvas.addEventListener('pointermove', (e) => { 
    if(activePwr) { pwrX = e.clientX; pwrY = e.clientY; }
    if(isDragging) lastX = e.clientX; 
});
canvas.addEventListener('pointerup', (e) => {
    if(activePwr) { usePwr(e.clientX, e.clientY); activePwr = null; document.getElementById('status-msg').style.display = 'none'; }
    isDragging = false;
    if(!canDrop) return;
    const b = Matter.Bodies.circle(lastX, 135, SIZES[currentIdx], { restitution: 0.3, plugin: {t: currentIdx, dT: null} });
    Matter.Composite.add(engine.world, b);
    currentIdx = nextIdx; nextIdx = Math.floor(Math.random() * 4);
    canDrop = false; setTimeout(() => canDrop = true, 600);
    updateUI();
});

function usePwr(x, y) {
    const bodies = Matter.Composite.allBodies(engine.world).filter(b => b.plugin && b.plugin.t !== undefined);
    const hit = bodies.find(b => Math.hypot(b.position.x - x, b.position.y - y) < b.circleRadius + 40);
    if(activePwr === 'bomb') {
        bodies.forEach(b => { if(Math.hypot(b.position.x-x, b.position.y-y) < 100) Matter.Composite.remove(engine.world, b); });
        state.pts -= 500;
    } else if(activePwr === 'wipe' && hit) {
        bodies.forEach(b => { if(b.plugin.t === hit.plugin.t) Matter.Composite.remove(engine.world, b); });
        state.pts -= 1000;
    } else if(activePwr === 'evo' && hit && hit.plugin.t < 11) {
        const type = hit.plugin.t;
        bodies.forEach(b => { if(b.plugin.t === type) {
            const nt = b.plugin.t + 1;
            Matter.Composite.add(engine.world, Matter.Bodies.circle(b.position.x, b.position.y, SIZES[nt], { plugin: {t: nt, dT: null} }));
            Matter.Composite.remove(engine.world, b);
        }});
        state.pts -= 1500;
    }
    save(); updateUI();
}

function updateUI() {
    document.getElementById('s-val').innerText = state.score;
    document.getElementById('h-val').innerText = state.best = Math.max(state.best, state.score);
    document.getElementById('w-val').innerText = state.pts;
    document.getElementById('next-disp').innerText = "NEXT: " + SKINS[state.skin][nextIdx];
    document.getElementById('game-container').style.background = THEMES[state.theme];
    const progress = (state.maxT / 11) * 100;
    document.getElementById('progress-bar').style.width = progress + "%";
    document.getElementById('progress-icons').innerHTML = SKINS[state.skin].map(emoji => `<span>${emoji}</span>`).join('');
}

function save() { localStorage.setItem('fm_v60_save', JSON.stringify(state)); }
function openShop() {
    document.getElementById('shopModal').style.display = 'block';
    document.getElementById('shop-wallet').innerText = state.pts;
    const sG = document.getElementById('skin-grid'); const tG = document.getElementById('theme-grid');
    sG.innerHTML = ''; tG.innerHTML = '';
    Object.keys(SKINS).forEach(id => {
        const owned = state.owned.includes(id);
        sG.innerHTML += `<div class="item-card ${state.skin===id?'selected':''}" onclick="buy('${id}','skin',500)">
            <span class="badge" style="background:${owned?'#2ecc71':'#f1c40f'}">${owned?'OWNED':'$500'}</span>
            <div style="font-size:30px">${SKINS[id][0]}</div><div style="font-size:10px">${id}</div></div>`;
    });
    Object.keys(THEMES).forEach(id => {
        const owned = state.owned.includes(id);
        tG.innerHTML += `<div class="item-card ${state.theme===id?'selected':''}" onclick="buy('${id}','theme',300)">
            <span class="badge" style="background:${owned?'#2ecc71':'#f1c40f'}">${owned?'OWNED':'$300'}</span>
            <div style="width:30px;height:30px;background:${THEMES[id]};margin:0 auto;border:1px solid #333;border-radius:4px"></div>
            <div style="font-size:10px">${id}</div></div>`;
    });
}
function buy(id, type, cost) {
    if(!state.owned.includes(id)) { if(state.pts >= cost) { state.pts -= cost; state.owned.push(id); } else return; }
    state[type === 'skin' ? 'skin' : 'theme'] = id;
    save(); updateUI(); openShop();
}
function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
function toggleFullScreen() {
    const el = document.documentElement;
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        if (el.requestFullscreen) el.requestFullscreen(); else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    } else {
        if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
}
function toggleMute() { state.muted = !state.muted; document.getElementById('mute-btn').innerText = state.muted ? "ðŸ”‡" : "ðŸ”Š"; save(); }
function openHelp() { document.getElementById('helpModal').style.display = 'block'; }
init();
</script>
</body>
</html>
