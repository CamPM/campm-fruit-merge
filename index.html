<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Merge v94</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #fdfbf7; --ui-border: #e8e6e1; --text: #5c554a;
            --border-width: 15px; --outline-style: none;
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-color); color: var(--text); touch-action: none;
        }

        /* Layout */
        #top-ui { height: 175px; position: absolute; top: 0; width: 100%; border-bottom: var(--border-width) solid var(--ui-border); z-index: 50; background: inherit; padding: 10px; box-sizing: border-box; }
        #bottom-ui { height: 100px; position: absolute; bottom: 0; width: 100%; border-top: var(--border-width) solid var(--ui-border); display: flex; justify-content: space-around; align-items: center; z-index: 50; background: inherit; }
        #game-container { position: absolute; top: 175px; bottom: 100px; left: 0; right: 0; border-left: var(--border-width) solid var(--ui-border); border-right: var(--border-width) solid var(--ui-border); background: #fff; z-index: 5; }

        /* Store UI */
        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 1000; flex-direction: column; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; touch-action: pan-y; }
        .store-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card { border: 1px solid var(--ui-border); border-radius: 12px; padding: 10px; text-align: center; position: relative; font-size: 0.8rem; }
        .item-card.owned { background: #f0fff4; border-color: #c6f6d5; opacity: 0.8; }
        .preview-box { height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 5px; }

        /* Visual Elements */
        .btn { padding: 10px; border-radius: 10px; border: 1px solid var(--ui-border); background: #fff; cursor: pointer; }
        .danger-line { position: absolute; top: 195px; width: 100%; border-top: 2px dashed rgba(255, 118, 117, 0.6); z-index: 10; pointer-events: none; }
        #crosshair { position: absolute; width: 60px; height: 60px; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; pointer-events: none; display: none; transform: translate(-50%, -50%); z-index: 100; }
        #crosshair::after, #crosshair::before { content: ''; position: absolute; background: rgba(0,0,0,0.2); }
        #crosshair::after { width: 100%; height: 2px; top: 50%; left: 0; }
        #crosshair::before { height: 100%; width: 2px; left: 50%; top: 0; }
    </style>
</head>
<body>

<div id="top-ui">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div><b>Score:</b> <span id="score">0</span></div>
        <div style="text-align: center;">Next <br> <span id="next-preview" style="font-size:1.5rem"></span></div>
        <div><button class="btn" onclick="toggleFS()">‚õ∂</button> <button class="btn" onclick="showModal('help')">?</button></div>
    </div>
    <div id="progress-list" style="display:flex; justify-content: space-between; margin-top:15px;"></div>
    <div style="text-align:center; font-weight:bold; margin-top:5px;">$ <span id="wallet">0</span></div>
</div>

<div class="danger-line"></div>
<div id="game-container">
    <div id="crosshair"></div>
</div>

<div id="bottom-ui">
    <button id="pwr-bomb" class="btn" ontouchstart="startDragPower(event, 'bomb')">üí£</button>
    <button id="pwr-broom" class="btn" ontouchstart="startDragPower(event, 'broom')">üßπ</button>
    <button id="pwr-sparkle" class="btn" ontouchstart="startDragPower(event, 'sparkle')">‚ú®</button>
    <button class="btn" onclick="showModal('store')">üè™ Store</button>
</div>

<div id="store-modal" class="modal">
    <div class="modal-content" id="store-render"></div>
    <button class="btn" style="margin: 20px;" onclick="closeModals()">Close</button>
</div>

<script>
/** * DATA ENGINE
 */
const DATA = {
    skins: {
        Fruit: ['üçí','üçì','üçá','üçä','üçé','üçê','üçë','üçç','üçà','üçâ','ü••','üéÉ'],
        Plants: ['üå±','üåµ','ü™¥','üå≤','üå≥','üå¥','üéã','üåø','üçÄ','üçÑ','üåª','üåπ'],
        Weather: ['‚òÅÔ∏è','üå§Ô∏è','‚ö°','‚òÄÔ∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','‚õàÔ∏è','‚ùÑÔ∏è','üå¨Ô∏è','üåà','üå™Ô∏è'],
        Animals: ['üê≠','üê∞','ü¶ä','üêª','üêº','ü¶Å','üêØ','üê∑','üê∏','üêô','üê≥','ü¶Ñ'],
        Shapes: ['‚ñ≤','‚ñ†','‚¨ì','‚¨¢','‚¨¶','‚¨ó','‚òÖ','‚óÜ','‚úö','‚¨ô','‚¨£','‚¨§'],
        Music: ['üéµ','üé∂','üé∑','üé∏','üéπ','üéª','ü•Å','üìª','üé§','üéß','ü™ï','üìª'],
        Space: ['‚òÑÔ∏è','üõ∞Ô∏è','ü™ê','üåô','‚òÄÔ∏è','üî≠','üöÄ','üëΩ','üõ∏','üåå','üå†','üë©‚ÄçüöÄ'],
        Dessert: ['üç™','üç©','üßÅ','üç¶','üç∞','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üéÇ']
    },
    outlines: { "None": "transparent", "White": "#fff", "Black": "#000", "Neon": "#0ff" },
    themes: { "Mellow": "#fdfbf7", "Midnight": "#1a1a2e", "Forest": "#edf5f1", "Ocean": "#eef2f7" }, // Examples
    borders: { "Clay": "#e8e6e1", "Gold": "#d4af37", "Steel": "#718096", "Neon Blue": "#00d2ff" }
};

let state = {
    score: 0, wallet: parseInt(localStorage.getItem('wallet')) || 1500,
    skin: 'Fruit', unlocked: new Set([0]), next: 0,
    owned: JSON.parse(localStorage.getItem('owned')) || ["Fruit", "None", "Mellow", "Clay"],
    activePower: null, touchX: 0, touchY: 0
};

/** * PHYSICS & RENDERING
 */
const { Engine, Render, Runner, Bodies, Composite, Events, Vector, Query } = Matter;
const container = document.getElementById('game-container');
const engine = Engine.create({ gravity: { y: 1.2 } });
const render = Render.create({
    element: container, engine: engine,
    options: { width: container.clientWidth, height: container.clientHeight, wireframes: false, background: 'transparent' }
});

const ground = Bodies.rectangle(container.clientWidth/2, container.clientHeight + 10, container.clientWidth, 25, { isStatic: true });
const lWall = Bodies.rectangle(-10, container.clientHeight/2, 20, container.clientHeight, { isStatic: true });
const rWall = Bodies.rectangle(container.clientWidth + 10, container.clientHeight/2, 20, container.clientHeight, { isStatic: true });
Composite.add(engine.world, [ground, lWall, rWall]);

function spawnItem(x, y, tier) {
    const r = 14 + (tier * 7.5);
    const b = Bodies.circle(x, y, r, { restitution: 0.3, friction: 0.2, plugin: { tier } });
    Composite.add(engine.world, b);
}

/** * DRAG-AND-DROP INTERACTIONS
 */
const ch = document.getElementById('crosshair');

function startDragPower(e, type) {
    state.activePower = type;
    ch.style.display = 'block';
}

window.addEventListener('touchmove', (e) => {
    const touch = e.touches[0];
    const rect = container.getBoundingClientRect();
    state.touchX = touch.clientX - rect.left;
    state.touchY = touch.clientY - rect.top;

    if (state.activePower) {
        ch.style.left = touch.clientX - rect.left + 'px';
        ch.style.top = touch.clientY - rect.top + 'px';
    }
});

window.addEventListener('touchend', (e) => {
    if (state.activePower) {
        executePowerUp(state.activePower, state.touchX, state.touchY);
        state.activePower = null;
        ch.style.display = 'none';
    } else {
        // Only drop fruit if touch released inside game container and not using powerup
        const rect = container.getBoundingClientRect();
        const touch = e.changedTouches[0];
        if (touch.clientY > rect.top && touch.clientY < rect.bottom) {
            spawnItem(state.touchX, 40, state.next);
            state.next = Math.floor(Math.random() * 4);
            updateUI();
        }
    }
});

function executePowerUp(type, x, y) {
    const bodies = Composite.allBodies(engine.world);
    const target = Query.point(bodies, { x, y })[0];

    if (type === 'bomb') {
        const inArea = bodies.filter(b => Vector.magnitude(Vector.sub(b.position, {x, y})) < 60);
        Composite.remove(engine.world, inArea);
    } else if (target && target.plugin.tier !== undefined) {
        const targetTier = target.plugin.tier;
        if (type === 'broom') {
            const sameType = bodies.filter(b => b.plugin.tier === targetTier);
            Composite.remove(engine.world, sameType);
        } else if (type === 'sparkle') {
            const sameType = bodies.filter(b => b.plugin.tier === targetTier);
            sameType.forEach(b => {
                const pos = {...b.position};
                Composite.remove(engine.world, b);
                if (targetTier < 11) spawnItem(pos.x, pos.y, targetTier + 1);
            });
        }
    }
}

/** * COLLISION & GAMEOVER
 */
Events.on(engine, 'collisionStart', (e) => {
    e.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        if (bodyA.plugin?.tier === bodyB.plugin?.tier && bodyA.plugin.tier < 11) {
            const pos = Vector.div(Vector.add(bodyA.position, bodyB.position), 2);
            const next = bodyA.plugin.tier + 1;
            Composite.remove(engine.world, [bodyA, bodyB]);
            spawnItem(pos.x, pos.y, next);
            state.score += (next * 20);
            state.wallet += next;
            state.unlocked.add(next);
            updateUI();
        }
    });
});

Events.on(render, 'afterRender', () => {
    const ctx = render.context;
    Composite.allBodies(engine.world).forEach(body => {
        if (body.plugin.tier !== undefined) {
            const tier = body.plugin.tier;
            const r = 14 + (tier * 7.5);
            ctx.save();
            ctx.translate(body.position.x, body.position.y);
            ctx.rotate(body.angle);
            
            // Apply Outlines
            if (state.owned.includes("White") || state.owned.includes("Black") || state.owned.includes("Neon")) {
                ctx.strokeStyle = state.owned.find(o => DATA.outlines[o]) || "transparent";
                ctx.lineWidth = 4;
                ctx.strokeText(DATA.skins[state.skin][tier], 0, 0);
            }

            ctx.font = `${r * 1.8}px Arial`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(DATA.skins[state.skin][tier], 0, 0);
            ctx.restore();
        }
    });
});

/** * UI & STORE LOGIC
 */
function updateUI() {
    document.getElementById('score').innerText = state.score;
    document.getElementById('wallet').innerText = state.wallet;
    document.getElementById('next-preview').innerText = DATA.skins[state.skin][state.next];
    
    const list = document.getElementById('progress-list');
    list.innerHTML = '';
    DATA.skins[state.skin].forEach((s, i) => {
        const span = document.createElement('span');
        span.style.opacity = state.unlocked.has(i) ? '1' : '0.2';
        span.innerText = s;
        list.appendChild(span);
    });
    localStorage.setItem('wallet', state.wallet);
    localStorage.setItem('owned', JSON.stringify(state.owned));
}

function showModal(id) {
    if(id === 'store') renderStore();
    document.getElementById(id + '-modal').style.display = 'flex';
}

function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

function renderStore() {
    const container = document.getElementById('store-render');
    container.innerHTML = '<h2>Store</h2>';
    
    const categories = [
        { name: 'Skins', data: DATA.skins, price: 500 },
        { name: 'Outlines', data: DATA.outlines, price: 2000 },
        { name: 'Themes', data: DATA.themes, price: 300 },
        { name: 'Borders', data: DATA.borders, price: 200 }
    ];

    categories.forEach(cat => {
        container.innerHTML += `<h3>${cat.name}</h3>`;
        const grid = document.createElement('div');
        grid.className = 'store-grid';
        
        Object.keys(cat.data).sort().forEach(key => {
            const isOwned = state.owned.includes(key);
            const card = document.createElement('div');
            card.className = `item-card ${isOwned ? 'owned' : ''}`;
            
            let preview = Array.isArray(cat.data[key]) ? cat.data[key][0] : key[0];
            if(cat.name === 'Borders') preview = 'üî≤';
            
            card.innerHTML = `
                <div class="preview-box">${preview}</div>
                <div><b>${key}</b></div>
                <div>${isOwned ? 'ACTIVE' : '$' + cat.price}</div>
            `;
            
            card.onclick = () => {
                if(!isOwned && state.wallet >= cat.price) {
                    state.wallet -= cat.price;
                    state.owned.push(key);
                    if(cat.name === 'Skins') state.skin = key;
                    updateUI(); renderStore();
                } else if(isOwned) {
                    if(cat.name === 'Skins') state.skin = key;
                    updateUI();
                }
            };
            grid.appendChild(card);
        });
        container.appendChild(grid);
    });
}

function toggleFS() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
}

// Boot
updateUI();
Render.run(render);
Runner.run(Runner.create(), engine);
</script>
</body>
</html>
