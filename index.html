<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fruit Merge v51 - iPad Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: system-ui, -apple-system, sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #E6E6FA; overflow: hidden; }
        
        /* Fixed UI Layers */
        #top-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100px; background: rgba(255,255,255,0.9); border-bottom: 2px solid #333; z-index: 10; display: flex; flex-direction: column; justify-content: center; padding: 0 15px; box-sizing: border-box; }
        #bottom-ui { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: #fff; border-top: 3px solid #333; z-index: 10; display: flex; align-items: center; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); }
        
        .stats { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; color: #333; }
        .btn { width: 50px; height: 50px; border-radius: 12px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        #status-bar { position: absolute; bottom: 90px; width: 100%; text-align: center; font-weight: bold; color: #3498db; pointer-events: none; z-index: 5; text-shadow: 1px 1px 0 #fff; }

        .modal { display: none; position: fixed; inset: 5%; background: white; z-index: 1000; border: 4px solid #3498db; border-radius: 20px; padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .card { border: 2px solid #eee; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; font-size: 11px; }
        .card.owned { border-color: #2ecc71; background: #f0fff4; }

        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="top-ui">
        <div class="stats"><span>SCORE: <span id="s-val">0</span></span><span>BEST: <span id="h-val">0</span></span></div>
        <div id="next-disp" style="text-align:center; font-size:28px; margin: 5px 0;"></div>
        <div class="stats"><span>WALLET: $<span id="w-val">0</span></span><span id="mute-btn" onclick="toggleMute()" style="cursor:pointer">ğŸ”Š</span></div>
    </div>

    <div id="status-bar">READY</div>

    <div id="bottom-ui">
        <div class="btn" style="background:#e67e22" onclick="startPwr('bomb')">ğŸ’£</div>
        <div class="btn" style="background:#9b59b6" onclick="startPwr('wipe')">ğŸ§¹</div>
        <div class="btn" style="background:#f1c40f" onclick="startPwr('evo')">âœ¨</div>
        <div class="btn" style="background:#3498db; width: 70px; font-size: 12px; font-weight: bold; color:white; text-align:center;" onclick="openShop()">MARKET</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="shopModal" class="modal">
        <div style="display:flex; justify-content:space-between"><h3>Market</h3><button onclick="closeModal()">X</button></div>
        <h4>Skins ($500)</h4><div id="skin-grid" class="grid"></div>
        <h4>Themes ($300)</h4><div id="theme-grid" class="grid"></div>
    </div>
</div>

<script>
const SKINS = {
    Fruit: ["ğŸ’","ğŸ“","ğŸ‡","ğŸŠ","ğŸ","ğŸ","ğŸ‘","ğŸ","ğŸˆ","ğŸ‰","ğŸ¥¥","ğŸƒ"],
    Animals: ["ğŸ­","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¦","ğŸ¯","ğŸ·","ğŸ¸","ğŸ™","ğŸ³","ğŸ¦„"],
    Retro: ["â–²","â– ","â¬¢","â—†","â˜…","âœš","âœ–","â¬¤","â¬Ÿ","â–¼","â¬“","âŒ¬"],
    Space: ["â˜„ï¸","ğŸ›°ï¸","ğŸª","ğŸŒ™","â˜€ï¸","ğŸ”­","ğŸš€","ğŸ‘½","ğŸ›¸","ğŸŒŒ","ğŸŒ ","ğŸ‘¨â€ğŸš€"],
    Desserts: ["ğŸª","ğŸ©","ğŸ§","ğŸ¦","ğŸ°","ğŸ¥§","ğŸ«","ğŸ¬","ğŸ­","ğŸ®","ğŸ¯","ğŸ‚"],
    Cars: ["ğŸï¸","ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš","ğŸš›","ğŸšœ","ğŸš“","ğŸš‘","ğŸš’","ğŸš€"],
    Plants: ["ğŸŒ¿","ğŸŒµ","ğŸª´","ğŸŒ²","ğŸŒ³","ğŸŒ´","ğŸ‹","ğŸŒ¿","ğŸ€","ğŸ„","ğŸŒ»","ğŸŒ¹"]
};
const THEMES = { Lilac: "#E6E6FA", Sunset: "#ff7675", Forest: "#55efc4", Midnight: "#2d3436", Gold: "#fdcb6e", Ocean: "#0984e3", Rose: "#fd79a8", Charcoal: "#2f3640" };
const SIZES = [20, 28, 36, 46, 58, 72, 86, 102, 120, 138, 158, 180];
const COLORS = ["#ff7979", "#ffbe76", "#f6e58d", "#badc58", "#7ed6df", "#686de0", "#4834d4", "#f0932b", "#eb4d4b", "#6ab04c", "#130f40", "#222f3e"];

let state = { score: 0, best: 0, pts: 0, skin: 'Fruit', theme: 'Lilac', owned: ['Fruit', 'Lilac'], muted: false, activePwr: null };
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let engine, render, runner, currentIdx = 0, nextIdx = 1, lastX = 200, isDragging = false, canDrop = true;
let ground, leftWall, rightWall;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playPop(freq = 400) {
    if(state.muted) return;
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } catch(e) {}
}

function init() {
    const saved = localStorage.getItem('fm_v51');
    if(saved) Object.assign(state, JSON.parse(saved));
    
    engine = Matter.Engine.create();
    
