<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fruit Merge Pro v1.01</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #f0e6d2;
            --border-color: #5d4037;
            --ui-font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: var(--ui-font);
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #fffdf9;
            box-sizing: border-box;
            border: 8px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        /* Top UI */
        #top-ui {
            height: 140px;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: rgba(255,255,255,0.8);
            z-index: 10;
            border-bottom: 2px solid #ddd;
        }

        .stat-box { font-weight: bold; font-size: 18px; }
        .stat-label { font-size: 12px; color: #666; display: block; }

        #progress-bar {
            grid-column: span 2;
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            background: #eee;
            padding: 5px;
            border-radius: 20px;
        }

        .tier-icon {
            width: 22px;
            height: 22px;
            filter: grayscale(1) opacity(0.3);
            transition: all 0.3s;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tier-icon.active { filter: grayscale(0) opacity(1); transform: scale(1.2); }

        /* Canvas Area */
        #canvas-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }

        /* Bottom UI */
        #bottom-ui {
            height: 100px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #fff;
            z-index: 10;
        }

        .btn-circle {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Modals */
        #store-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 70%;
            background: white;
            border-radius: 20px;
            display: none;
            z-index: 100;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        .scroll-area { overflow-y: auto; flex-grow: 1; }
        
        #game-over {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="top-ui">
        <div class="stat-box"><span class="stat-label">SCORE</span><span id="score">0</span></div>
        <div class="stat-box" style="text-align: right;"><span class="stat-label">WALLET</span><span id="wallet">ðŸ’° 0</span></div>
        <div id="progress-bar">
            </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="bottom-ui">
        <button class="btn-circle" onclick="toggleStore()">ðŸ›’</button>
        <div class="btn-circle powerup" data-type="bomb">ðŸ’£</div>
        <div class="btn-circle powerup" data-type="broom">ðŸ§¹</div>
        <div class="btn-circle powerup" data-type="wand">ðŸª„</div>
        <button class="btn-circle" onclick="toggleFullscreen()">ðŸ“º</button>
    </div>

    <div id="store-modal">
        <h2>Store</h2>
        <div class="scroll-area" id="store-items"></div>
        <button onclick="toggleStore()" style="margin-top:10px; padding:10px;">Close</button>
    </div>

    <div id="game-over">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        <button onclick="location.reload()" style="padding:15px 30px; font-size:20px; border-radius:10px;">RETRY</button>
    </div>
</div>

<script>
/** 1. CONFIGURATION & STATE **/
const FRUIT_HIERARCHY = [
    { name: "Cherry", emoji: "ðŸ’", radius: 15, color: "#ff4d4d", value: 2 },
    { name: "Strawberry", emoji: "ðŸ“", radius: 22, color: "#ff85a2", value: 4 },
    { name: "Grape", emoji: "ðŸ‡", radius: 30, color: "#a18cd1", value: 8 },
    { name: "Dekopon", emoji: "ðŸŠ", radius: 38, color: "#ffb347", value: 16 },
    { name: "Persimmon", emoji: "ðŸ…", radius: 48, color: "#ff5e62", value: 32 },
    { name: "Apple", emoji: "ðŸŽ", radius: 58, color: "#ff0844", value: 64 },
    { name: "Pear", emoji: "ðŸ", radius: 68, color: "#cedf13", value: 128 },
    { name: "Peach", emoji: "ðŸ‘", radius: 80, color: "#fbd3e9", value: 256 },
    { name: "Pineapple", emoji: "ðŸ", radius: 92, color: "#f7971e", value: 512 },
    { name: "Melon", emoji: "ðŸˆ", radius: 105, color: "#56ab2f", value: 1024 },
    { name: "Watermelon", emoji: "ðŸ‰", radius: 120, color: "#00b09b", value: 2048 },
    { name: "King", emoji: "ðŸ‘‘", radius: 135, color: "#ffd700", value: 4096 }
];

let score = 0;
let wallet = parseInt(localStorage.getItem('wallet')) || 0;
let highScore = parseInt(localStorage.getItem('highScore')) || 0;
let canDrop = true;
let currentTierIdx = 0;
let gameActive = true;
let audioCtx = null;

/** 2. MATTER.JS SETUP **/
const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
const engine = Engine.create({ positionIterations: 10 }); // High precision
const wrapper = document.getElementById('canvas-wrapper');
const canvas = document.getElementById('gameCanvas');

const cw = wrapper.clientWidth;
const ch = wrapper.clientHeight;
canvas.width = cw;
canvas.height = ch;

const runner = Runner.create();
const deathLineY = ch * 0.2;

// Walls
const wallStyle = { isStatic: true, render: { visible: false } };
const floor = Bodies.rectangle(cw/2, ch + 25, cw, 50, wallStyle);
const leftWall = Bodies.rectangle(-25, ch/2, 50, ch, wallStyle);
const rightWall = Bodies.rectangle(cw + 25, ch/2, 50, ch, wallStyle);
Composite.add(engine.world, [floor, leftWall, rightWall]);

Runner.run(runner, engine);

/** 3. PROCEDURAL AUDIO **/
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playSound(type) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    if (type === 'merge') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(); osc.stop(now + 0.1);
    } else if (type === 'death') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(50, now + 1);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0, now + 1);
        osc.start(); osc.stop(now + 1);
    }
}

/** 4. GAME LOGIC **/
function spawnFruit(x, tierIdx, isGhost = false) {
    const tier = FRUIT_HIERARCHY[tierIdx];
    const fruit = Bodies.circle(x, 50, tier.radius, {
        restitution: 0.3,
        friction: 0.1,
        label: "fruit",
        tier: tierIdx,
        render: { sprite: { emoji: tier.emoji } } // Custom rendering handled in Draw loop
    });
    
    if (!isGhost) {
        Composite.add(engine.world, fruit);
        unlockTier(tierIdx);
    }
    return fruit;
}

function unlockTier(idx) {
    const icon = document.getElementsByClassName('tier-icon')[idx];
    if (icon) icon.classList.add('active');
}

// Merge Handling
Events.on(engine, 'collisionStart', (event) => {
    event.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        if (bodyA.label === "fruit" && bodyB.label === "fruit" && bodyA.tier === bodyB.tier) {
            if (bodyA.tier < 11) {
                const newX = (bodyA.position.x + bodyB.position.x) / 2;
                const newY = (bodyA.position.y + bodyB.position.y) / 2;
                
                Composite.remove(engine.world, [bodyA, bodyB]);
                const newFruit = spawnFruit(newX, bodyA.tier + 1);
                Body.setPosition(newFruit, { x: newX, y: newY });
                
                score += FRUIT_HIERARCHY[bodyA.tier].value;
                wallet += Math.floor(FRUIT_HIERARCHY[bodyA.tier].value / 2);
                updateUI();
                playSound('merge');
            }
        }
    });
});

/** 5. RENDERING & INPUT **/
let mouseX = cw / 2;
let isDragging = false;

canvas.addEventListener('pointerdown', (e) => {
    initAudio();
    isDragging = true;
    updateMousePos(e);
});

canvas.addEventListener('pointermove', (e) => {
    updateMousePos(e);
});

canvas.addEventListener('pointerup', () => {
    if (isDragging && canDrop && gameActive) {
        spawnFruit(mouseX, currentTierIdx);
        currentTierIdx = Math.floor(Math.random() * 4); // Only spawn first 4 types
        canDrop = false;
        setTimeout(() => canDrop = true, 500);
    }
    isDragging = false;
});

function updateMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    // Keep fruit within walls
    const radius = FRUIT_HIERARCHY[currentTierIdx].radius;
    mouseX = Math.max(radius, Math.min(cw - radius, mouseX));
}

function updateUI() {
    document.getElementById('score').innerText = score;
    document.getElementById('wallet').innerText = "ðŸ’° " + wallet;
    localStorage.setItem('wallet', wallet);
}

// Custom Draw Loop (60fps)
(function render() {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, cw, ch);

    // Death Line
    ctx.setLineDash([5, 5]);
    ctx.strokeStyle = "red";
    ctx.beginPath();
    ctx.moveTo(0, deathLineY);
    ctx.lineTo(cw, deathLineY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Ghost Preview
    if (isDragging && canDrop) {
        ctx.globalAlpha = 0.4;
        const tier = FRUIT_HIERARCHY[currentTierIdx];
        ctx.font = `${tier.radius * 2}px serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(tier.emoji, mouseX, 50);
        
        ctx.strokeStyle = "#ccc";
        ctx.beginPath();
        ctx.moveTo(mouseX, 50);
        ctx.lineTo(mouseX, ch);
        ctx.stroke();
        ctx.globalAlpha = 1.0;
    }

    // Render Fruits
    const bodies = Composite.allBodies(engine.world);
    let topFruitViolator = false;

    bodies.forEach(body => {
        if (body.label === "fruit") {
            const tier = FRUIT_HIERARCHY[body.tier];
            
            // Draw Glow
            ctx.beginPath();
            const grad = ctx.createRadialGradient(body.position.x, body.position.y, 0, body.position.x, body.position.y, tier.radius * 1.5);
            grad.addColorStop(0, tier.color + "55");
            grad.addColorStop(1, "transparent");
            ctx.fillStyle = grad;
            ctx.arc(body.position.x, body.position.y, tier.radius * 1.5, 0, Math.PI * 2);
            ctx.fill();

            // Draw Emoji
            ctx.save();
            ctx.translate(body.position.x, body.position.y);
            ctx.rotate(body.angle);
            ctx.font = `${tier.radius * 2}px serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(tier.emoji, 0, 0);
            ctx.restore();

            // Check Death Line
            if (body.position.y < deathLineY && body.velocity.y < 0.1) {
                topFruitViolator = true;
            }
        }
    });

    checkGameOver(topFruitViolator);
    requestAnimationFrame(render);
})();

/** 6. GAME OVER & ECONOMY **/
let deathTimer = 0;
function checkGameOver(isViolating) {
    if (isViolating && gameActive) {
        deathTimer += 16.6; // approx ms per frame
        if (deathTimer > 2000) {
            triggerGameOver();
        }
    } else {
        deathTimer = 0;
    }
}

function triggerGameOver() {
    gameActive = false;
    playSound('death');
    document.getElementById('game-over').style.display = 'flex';
    document.getElementById('final-score').innerText = score;
}

function toggleStore() {
    const modal = document.getElementById('store-modal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Init Progress Bar Icons
const progBar = document.getElementById('progress-bar');
FRUIT_HIERARCHY.forEach(f => {
    const div = document.createElement('div');
    div.className = 'tier-icon';
    div.innerHTML = f.emoji;
    progBar.appendChild(div);
});

updateUI();
</script>
</body>
</html>
