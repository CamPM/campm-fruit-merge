<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Fruit Merge v99</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root{--bg:#FDF6E3;--bd:#657B83;--txt:#586E75;--acc:#2AA198;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
*{box-sizing:border-box;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
body{margin:0;overflow:hidden;background:var(--bg);font-family:var(--font);color:var(--txt);transition:background .5s}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;display:flex;flex-direction:column;justify-content:space-between}
.top{height:175px;padding:15px;background:linear-gradient(to bottom,rgba(255,255,255,.9),transparent);pointer-events:auto}
.row{display:flex;justify-content:space-between;align-items:center}
.score{font-size:24px;font-weight:800} .lbl{font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:1px}
.bar{display:flex;justify-content:space-between;background:rgba(0,0,0,.05);padding:8px;border-radius:20px;margin-top:10px}
.dot{width:16px;height:16px;border-radius:50%;background:#ddd;display:grid;place-items:center;font-size:10px;transition:.3s}
.dot.on{transform:scale(1.2);box-shadow:0 0 8px currentColor}
.preview{position:absolute;top:60px;right:20px;width:50px;height:50px;border:2px dashed var(--bd);border-radius:50%;display:grid;place-items:center;font-size:24px;background:rgba(255,255,255,.5)}
.bot{height:100px;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-top:1px solid #0001;display:flex;justify-content:space-around;align-items:center;pointer-events:auto;padding-bottom:env(safe-area-inset-bottom)}
.btn{background:0;border:0;font-size:24px;display:flex;flex-direction:column;align-items:center;opacity:.6;cursor:pointer;transition:.2s}
.btn.act{opacity:1;color:var(--acc);transform:translateY(-5px)} .btn span{font-size:9px;font-weight:700}
.modal{position:absolute;top:0;left:0;width:100%;height:100%;background:#0008;backdrop-filter:blur(4px);z-index:99;display:none;opacity:0;transition:opacity .3s;align-items:center;justify-content:center;pointer-events:auto}
.modal.open{display:flex;opacity:1}
.card{background:#fff;width:90%;max-width:400px;height:80%;border-radius:20px;display:flex;flex-direction:column;overflow:hidden}
.head{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;font-weight:700}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:15px;overflow-y:auto}
.item{border:1px solid #eee;border-radius:10px;padding:10px;text-align:center;cursor:pointer}
.item.own{background:#f0fdf4;border-color:#86efac} .item.eq{box-shadow:0 0 0 3px var(--acc)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
    <div class="top">
        <div class="row"><div><div class="lbl">Score</div><div class="score" id="sCurrent">0</div></div><div style="text-align:right"><div class="lbl">Best</div><div class="score" id="sBest">0</div></div></div>
        <div class="bar" id="prog"></div>
        <div class="preview" id="next"></div>
    </div>
    <div class="bot">
        <button class="btn" onclick="toggleStore()">ðŸ›’<span>Store</span></button>
        <div style="width:1px;height:30px;background:#ccc"></div>
        <button class="btn pwr" id="b-bomb" onclick="setTool('bomb')">ðŸ’£<span>Bomb</span></button>
        <button class="btn pwr" id="b-broom" onclick="setTool('broom')">ðŸ§¹<span>Broom</span></button>
        <button class="btn pwr" id="b-wand" onclick="setTool('wand')">ðŸª„<span>Wand</span></button>
        <div style="width:1px;height:30px;background:#ccc"></div>
        <button class="btn" onclick="toggleFull()">â›¶<span>Full</span></button>
    </div>
</div>
<div class="modal" id="m-store"><div class="card"><div class="head"><span>Market</span><span id="wallet"></span><span onclick="toggleStore()">âœ•</span></div><div class="grid" id="shop"></div></div></div>
<div class="modal" id="m-over"><div style="text-align:center;color:#fff"><h1>GAME OVER</h1><button class="btn" style="background:#fff;color:#000;padding:10px 30px;border-radius:20px;opacity:1" onclick="reset()">Retry</button></div></div>

<script>
// --- FRUIT MERGE v99 ---
const M=Matter, E=M.Engine, R=M.Render, B=M.Bodies, C=M.Composite, Ev=M.Events, Q=M.Query;
const SKINS={
    'Fruit':['ðŸ’','ðŸ“','ðŸ‡','ðŸŠ','ðŸŽ','ðŸ','ðŸ‘','ðŸ','ðŸˆ','ðŸ‰','ðŸ¥¥','ðŸ¥'],
    'Space':['ðŸŒ‘','â˜„ï¸','ðŸ›°ï¸','ðŸš€','ðŸ›¸','ðŸ‘¾','ðŸ”­','ðŸŒŒ','ðŸª','â˜€ï¸','ðŸŒ€','ðŸ‘½'],
    'Animals':['ðŸž','ðŸ¸','ðŸ¢','ðŸ¦†','ðŸ’','ðŸ¦‰','ðŸ§','ðŸº','ðŸ¦“','ðŸ¦','ðŸ˜','ðŸ‹'],
    'Weather':['ðŸ’§','â„ï¸','ðŸŒªï¸','ðŸŒˆ','â˜€ï¸','â˜ï¸','â›ˆï¸','ðŸŒ©ï¸','ðŸŒ«ï¸','ðŸŒ¤ï¸','ðŸŒ¬ï¸','â˜‚ï¸'],
    'Dessert':['ðŸ¬','ðŸª','ðŸ©','ðŸ«','ðŸ®','ðŸ¦','ðŸ§','ðŸ°','ðŸ¥§','ðŸ¥ž','ðŸ§‡','ðŸŽ‚'],
    'Shapes':['ðŸ”´','ðŸŸ ','ðŸŸ¡','ðŸŸ¢','ðŸ”µ','ðŸŸ£','ðŸŸ¤','âš«','â¬œ','ðŸŸ¦','ðŸŸ§','ðŸŸ¥'],
    'Music':['ðŸŽµ','ðŸŽ¶','ðŸŽ¸','ðŸŽ¹','ðŸŽº','ðŸŽ»','ðŸŽ·','ðŸ¥','ðŸŽ¤','ðŸŽ§','ðŸ“»','ðŸŽ¼'],
    'Plants':['ðŸŒ±','ðŸŒ¿','â˜˜ï¸','ðŸ€','ðŸŒµ','ðŸŒ´','ðŸŒ³','ðŸŒ²','ðŸ‚','ðŸ','ðŸ„','ðŸŒ¹']
};
const THEMES={'Mellow':'#FDF6E3','Matcha':'#E8F5E9','Midnight':'#1a1b26','Lavender':'#F3E5F5','Sky':'#E1F5FE','Sunset':'#FFF3E0','Slate':'#263238','Rose':'#FCE4EC'};
const COLORS=['#F00','#F70','#FF0','#0F0','#00F','#4B0082','#9400D3','#FF1493','#0CED1','#FFD700','#FF4500','#32CD32'];
const ITEMS=[]; // Generated on load

// State
let st={s:0, w:1000, h:parseInt(localStorage.getItem('fm_h')||0), inv:JSON.parse(localStorage.getItem('fm_i')||'["sk_Fruit","ot_def","th_Mellow","bd_def"]'), 
    eq:JSON.parse(localStorage.getItem('fm_e')||'{"sk":"Fruit","ot":"def","th":"Mellow","bd":"#657B83"}'), next:0, drag:0, x:0, y:0, drop:1, over:0, tool:null, max:-1};

// Setup
const cv=document.getElementById('c'), cx=cv.getContext('2d'), aud=new (window.AudioContext||window.webkitAudioContext)();
const eng=E.create(); eng.timing.timeScale=1;
let W,H; 

function rsz(){ W=window.innerWidth; H=window.innerHeight; cv.width=W*devicePixelRatio; cv.height=H*devicePixelRatio; cx.scale(devicePixelRatio,devicePixelRatio); C.clear(eng.world,0,1); addWalls(); }
function addWalls(){
    const b=100, t=15, g=B.rectangle(W/2,H-b+50,W,100,{isStatic:1,render:{visible:0}});
    C.add(eng.world,[g, B.rectangle(0,H/2,30,H*2,{isStatic:1}), B.rectangle(W,H/2,30,H*2,{isStatic:1})]);
}
window.onresize=rsz; rsz();

// Audio
const tone=(f,t,d,v=.1)=>{if(aud.state==='suspended')aud.resume();const o=aud.createOscillator(),g=aud.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,aud.currentTime);g.gain.exponentialRampToValueAtTime(.01,aud.currentTime+d);o.connect(g);g.connect(aud.destination);o.start();o.stop(aud.currentTime+d)};

// Core Logic
function spawn(x,t){
    const r=15+(t*9), b=B.circle(x,50,r,{restitution:.2,friction:.005,label:'f_'+t});
    b.tier=t; b.spawn=Date.now(); C.add(eng.world,b); return b;
}
Ev.on(eng,'collisionStart',e=>{
    e.pairs.forEach(p=>{
        const a=p.bodyA, b=p.bodyB;
        if(a.tier!==undefined && b.tier!==undefined && a.tier===b.tier && a.tier<11){
            const n=a.tier+1, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
            C.remove(eng.world,[a,b]);
            const nb=B.circle(pos.x,pos.y,15+(n*9),{restitution:.2,label:'f_'+n}); nb.tier=n; C.add(eng.world,nb);
            tone(400+Math.random()*200,'sine',.15,.2); updSc((n+1)*10); updPrg(n);
        } else if(!p.isActive && (a.tier!==undefined||b.tier!==undefined)) tone(150-((a.tier||b.tier)*5),'triangle',.1);
    });
});

// Loop
function loop(){
    E.update(eng,1000/60); cx.clearRect(0,0,W,H);
    document.body.style.background=THEMES[st.eq.th]||st.eq.th;
    
    // Danger Line
    cx.beginPath(); cx.moveTo(15,195); cx.lineTo(W-15,195); cx.strokeStyle='#F44'; cx.setLineDash([10,10]); cx.stroke(); cx.setLineDash([]);
    cx.fillStyle=st.eq.bd; cx.fillRect(0,0,15,H); cx.fillRect(W-15,0,15,H); // Borders

    C.allBodies(eng.world).forEach(b=>{
        if(b.isStatic || !b.circleRadius) return;
        if(b.position.y-b.circleRadius < 195 && b.speed<.5){ if(!b.tm) b.tm=Date.now(); if(Date.now()-b.tm>2000) over(); } else b.tm=null;
        
        const r=b.circleRadius, t=b.tier;
        cx.translate(b.position.x,b.position.y); cx.rotate(b.angle);
        // Glow/Stroke
        if(st.tool && st.hov===b) { cx.shadowColor='#FFD700'; cx.strokeStyle='#FFD700'; cx.shadowBlur=20; }
        else { cx.shadowColor=COLORS[t]; cx.shadowBlur=15; cx.strokeStyle=st.eq.ot==='rain'?`hsl(${Date.now()/5%360},100%,50%)`: (st.eq.ot==='def'?'#0003':st.eq.ot); }
        
        cx.fillStyle='#fff'; cx.beginPath(); cx.arc(0,0,r,0,6.28); cx.fill(); cx.lineWidth=2; cx.stroke();
        cx.font=`${r*1.5}px serif`; cx.textAlign='center'; cx.textBaseline='middle'; cx.shadowBlur=0;
        cx.fillStyle='#000'; cx.fillText(SKINS[st.eq.sk][t],0,2);
        cx.rotate(-b.angle); cx.translate(-b.position.x,-b.position.y);
    });

    // Drag UI
    if(st.drag && !st.tool && st.drop){
        let gx=Math.max(35,Math.min(W-35,st.x));
        cx.beginPath(); cx.moveTo(gx,50); cx.lineTo(gx,H-100); cx.strokeStyle='#aaa'; cx.setLineDash([5,5]); cx.stroke();
        cx.font=`${(15+st.next*9)*1.5}px serif`; cx.globalAlpha=.5; cx.fillText(SKINS[st.eq.sk][st.next],gx,50); cx.globalAlpha=1;
    }
    // Crosshair
    if(st.drag && st.tool){
        cx.strokeStyle=st.tool==='bomb'?'red':'gold'; cx.lineWidth=2;
        cx.beginPath(); cx.moveTo(st.x-20,st.y); cx.lineTo(st.x+20,st.y); cx.moveTo(st.x,st.y-20); cx.lineTo(st.x,st.y+20); cx.stroke();
        if(st.tool==='bomb'){ cx.beginPath();cx.arc(st.x,st.y,90,0,6.28);cx.fillStyle='#f001';cx.fill(); }
    }
    if(!st.over) requestAnimationFrame(loop);
}

// Input
const ptr=(e,t)=>{
    if(t==='d' && !e.target.closest('button,.modal')) { st.drag=1; move(e); }
    if(t==='m' && st.drag) move(e);
    if(t==='u' && st.drag) { st.drag=0; act(); }
};
const move=e=>{ 
    const t=e.touches?e.touches[0]:e, r=cv.getBoundingClientRect(); 
    st.x=(t.clientX-r.left)*(W/r.width); st.y=(t.clientY-r.top)*(H/r.height);
    if(st.tool) st.hov = Q.point(C.allBodies(eng.world),{x:st.x,y:st.y})[0];
}
const act=()=>{
    if(st.tool) {
        let h=0, bs=C.allBodies(eng.world);
        if(st.tool==='bomb'){ C.remove(eng.world, bs.filter(b=>!b.isStatic && M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y}))<90)); h=1; }
        else if(st.hov && !st.hov.isStatic){
            if(st.tool==='broom'){ C.remove(eng.world, bs.filter(b=>b.tier===st.hov.tier)); h=1; }
            if(st.tool==='wand' && st.hov.tier<11){ 
                let t=st.hov.tier, p=st.hov.position; C.remove(eng.world,st.hov);
                let nb=B.circle(p.x,p.y,15+(t+1)*9,{restitution:.2,label:'f_'+(t+1)}); nb.tier=t+1; C.add(eng.world,nb); h=1;
            }
        }
        if(h){ tone(400,'sine',.2); st.tool=null; document.querySelectorAll('.pwr').forEach(b=>b.classList.remove('act')); }
    } else if(st.drop){
        spawn(Math.max(35,Math.min(W-35,st.x)), st.next);
        st.next=Math.floor(Math.random()*5); updPre(); st.drop=0; setTimeout(()=>st.drop=1,500);
    }
}
['down','move','up'].forEach(e=>window.addEventListener('pointer'+e, x=>ptr(x,e[0])));

// UI & Store
function updSc(n){ st.s+=n; st.w+=Math.floor(n/10); document.getElementById('sCurrent').innerText=st.s; if(st.s>st.h){st.h=st.s; document.getElementById('sBest').innerText=st.h;} save(); }
function updPrg(t){ if(t>st.max){st.max=t; renderPrg();} }
function updPre(){ document.getElementById('next').innerText=SKINS[st.eq.sk][st.next]; }
function renderPrg(){ const d=document.getElementById('prog'); d.innerHTML=''; for(let i=0;i<12;i++){ d.innerHTML+=`<div class="dot ${i<=st.max?'on':''}" style="color:${COLORS[i]}">${i<=st.max?SKINS[st.eq.sk][i]:''}</div>`; } }
function over(){ st.over=1; tone(100,'sawtooth',.5); document.getElementById('m-over').classList.add('open'); }
function reset(){ C.clear(eng.world,0,1); st.s=0; st.over=0; st.max=-1; updSc(0); renderPrg(); document.getElementById('m-over').classList.remove('open'); loop(); }
function save(){ localStorage.setItem('fm_i',JSON.stringify(st.inv)); localStorage.setItem('fm_e',JSON.stringify(st.eq)); localStorage.setItem('fm_h',st.h); }

// Store Gen
Object.keys(SKINS).forEach(k=>ITEMS.push({id:'sk_'+k, t:'skin', n:k, p:500, v:k}));
ITEMS.push({id:'ot_def',t:'ot',n:'Def',p:0,v:'def'},{id:'ot_w',t:'ot',n:'Wht',p:2000,v:'#fff'},{id:'ot_b',t:'ot',n:'Blk',p:2000,v:'#000'},{id:'ot_r',t:'ot',n:'Rain',p:2000,v:'rain'});
Object.keys(THEMES).forEach(k=>ITEMS.push({id:'th_'+k,t:'th',n:k,p:300,v:THEMES[k]}));
ITEMS.push({id:'bd_def',t:'bd',n:'Slate',p:0,v:'#657B83'},{id:'bd_g',t:'bd',n:'Gold',p:200,v:'#DAA520'},{id:'bd_r',t:'bd',n:'Red',p:200,v:'#DC143C'});

function toggleStore(){ 
    const m=document.getElementById('m-store'); m.classList.toggle('open'); 
    if(m.classList.contains('open')){
        document.getElementById('wallet').innerText='ðŸ’°'+st.w;
        const g=document.getElementById('shop'); g.innerHTML='';
        ITEMS.forEach(i=>{
            const own=st.inv.includes(i.id), eq=(st.eq.sk==i.v||st.eq.ot==i.v||st.eq.th==i.v||st.eq.bd==i.v);
            const p=i.t=='skin'?SKINS[i.v][0]:(i.t=='ot'?'â­•':`<div style="width:15px;height:15px;background:${i.v};border-radius:50%;display:inline-block"></div>`);
            const el=document.createElement('div'); el.className=`item ${own?'own':''} ${eq?'eq':''}`;
            el.innerHTML=`<div>${p}</div><b>${i.n}</b><div style="font-size:10px">${own?(eq?'EQ':'âœ“'):'$'+i.p}</div>`;
            el.onclick=()=>{
                if(own){ if(i.t=='skin')st.eq.sk=i.v; if(i.t=='ot')st.eq.ot=i.v; if(i.t=='th')st.eq.th=i.v; if(i.t=='bd')st.eq.bd=i.v; }
                else if(st.w>=i.p){ st.w-=i.p; st.inv.push(i.id); if(i.t=='skin')st.eq.sk=i.v; if(i.t=='ot')st.eq.ot=i.v; if(i.t=='th')st.eq.th=i.v; if(i.t=='bd')st.eq.bd=i.v;}
                save(); updPre(); renderPrg(); toggleStore(); toggleStore();
            };
            g.appendChild(el);
        });
    }
}
function setTool(t){ st.tool=(st.tool===t?null:t); document.querySelectorAll('.pwr').forEach(b=>b.classList.toggle('act',b.id==='b-'+st.tool)); }
function toggleFull(){ !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }

// Init
document.getElementById('sBest').innerText=st.h; updPre(); renderPrg(); loop();
</script></body></html>
