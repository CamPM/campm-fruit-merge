<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Fruit Merge v1.36</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root{--accent:#3498db;--panel:rgba(255,255,255,0.98)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
body{overflow:hidden;background:#FDF6E3;font-family:-apple-system,system-ui;height:100vh;width:100vw;position:fixed;touch-action:none}
canvas{display:block;width:100%;height:100%}
.ui-panel{position:absolute;width:100%;z-index:100;pointer-events:none}
.top-bar{top:0;height:140px;background:var(--panel);border-bottom:3px solid #333;pointer-events:auto;padding:10px 20px;padding-top:env(safe-area-inset-top)}
.bot-bar{bottom:0;height:100px;background:var(--panel);border-top:3px solid #333;pointer-events:auto;display:flex;align-items:center;justify-content:space-evenly;padding-bottom:env(safe-area-inset-bottom)}
.pwr-btn{width:46px;height:46px;border-radius:12px;border:2px solid #333;display:flex;align-items:center;justify-content:center;font-size:20px;background:#95a5a6;color:#fff;pointer-events:auto;transition:0.2s}
.pwr-btn.locked{filter:grayscale(1);opacity:0.5}
#p-bomb{background:#e67e22}#p-wipe{background:#9b59b6}#p-evo{background:#f1c40f}
.modal{display:none;position:absolute;inset:20px;background:#fff;z-index:500;border-radius:20px;border:4px solid var(--accent);flex-direction:column;pointer-events:auto}
.modal.open{display:flex}.modal-content{flex:1;overflow-y:auto;padding:15px;-webkit-overflow-scrolling:touch}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{padding:10px;border:2px solid #eee;border-radius:12px;text-align:center;background:#f9f9f9}
.card.equipped{border-color:#2ecc71;background:#f0fff4}
.preview-swatch{width:40px;height:40px;border-radius:50%;margin:5px auto;border:2px solid #333;display:flex;align-items:center;justify-content:center;background:#fff}
@keyframes rainbow{0%{border-color:red}33%{border-color:lime}66%{border-color:blue}100%{border-color:red}}
.rainbow-active{animation:rainbow 2s linear infinite;border-width:3px!important}
#toast{position:absolute;top:160px;left:50%;transform:translateX(-50%);background:#ff4757;color:#fff;padding:8px 16px;border-radius:20px;display:none;z-index:1000}
#combo-ui{position:absolute;top:180px;width:100%;text-align:center;font-weight:900;font-size:30px;color:#e74c3c;pointer-events:none;opacity:0;transition:0.3s}
</style>
</head>
<body>
<div id="toast"></div><div id="combo-ui"></div>
<div id="game-over" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,0.9);z-index:1000;color:#fff;flex-direction:column;align-items:center;justify-content:center">
    <h1>GAME OVER</h1><button onclick="restart()" style="padding:15px 40px;margin-top:20px;background:#2ecc71;border:none;border-radius:10px;color:#fff;font-weight:bold">RETRY</button>
</div>
<div class="ui-panel top-bar">
    <div style="display:flex;justify-content:space-between">
        <div>SCORE<div id="score" style="font-size:24px">0</div></div>
        <div id="next-box" style="width:50px;height:50px;border:3px solid #333;border-radius:50%;background:#fff;display:grid;place-items:center;font-size:28px"></div>
        <div>WALLET<div id="wallet" style="font-size:24px;color:#2ecc71">0</div></div>
    </div>
    <div id="prog-bar" style="display:flex;justify-content:space-around;margin-top:10px"></div>
</div>
<div class="ui-panel bot-bar">
    <div id="p-bomb" class="pwr-btn" onpointerdown="startDrag(event,'bomb')">ðŸ’£</div>
    <div id="p-wipe" class="pwr-btn" onpointerdown="startDrag(event,'wipe')">ðŸ§¹</div>
    <div id="p-evo" class="pwr-btn" onpointerdown="startDrag(event,'evo')">ðŸª„</div>
    <div class="pwr-btn" style="width:60px" onclick="toggleModal('shop-modal')">SHOP</div>
    <div class="pwr-btn" onclick="toggleModal('help-modal')">?</div>
</div>
<div id="shop-modal" class="modal">
    <div style="padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between"><b>MARKET</b><b onclick="toggleModal('shop-modal')">âœ•</b></div>
    <div class="modal-content" id="shop-items"></div>
</div>
<div id="help-modal" class="modal">
    <div style="padding:15px;border-bottom:1px solid #eee"><b>HELP</b></div>
    <div class="modal-content">Drag power-ups to board. Merge same items for combos. iOS: Add to Home Screen for best experience.</div>
    <button onclick="toggleModal('help-modal')" style="padding:10px">CLOSE</button>
</div>
<canvas id="c"></canvas>
<script>
const M=Matter,E=M.Engine,B=M.Bodies,C=M.Composite,Ev=M.Events;
const SKINS={Fruit:["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"],Animals:["ðŸž","ðŸ¸","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","ðŸ˜","ðŸ‹"],Music:["ðŸª•","ðŸª—","ðŸŽ¸","ðŸŽ¹","ðŸŽº","ðŸŽ»","ðŸ¥","ðŸŽ·","ðŸŽ™ï¸","ðŸ“»","ðŸŽ§","ðŸŽµ"],Weather:["â˜ï¸","ðŸŒ¦ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒªï¸","ðŸŒ«ï¸","ðŸŒˆ","â˜€ï¸"],Shapes:["ðŸ”º","ðŸŸ¡","ðŸŸ©","ðŸ”·","â­","ðŸ›‘","ðŸ’Ž","ðŸŒ™","ðŸŒ€","ðŸ’ ","â¬›","âšª"],Nature:["ðŸŒ±","ðŸŒ¿","â˜˜ï¸","ðŸ€","ðŸƒ","ðŸ‚","ðŸ","ðŸ„","ðŸŒµ","ðŸŒ´","ðŸŒ²","ðŸŒ³"],Dessert:["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"],Space:["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"]};
const WORDS={Fruit:"JUICY",Animals:"WILD",Music:"LOUD",Weather:"STORMY",Shapes:"SHARP",Nature:"LUSH",Dessert:"SWEET",Space:"COSMIC"};
const THEMES={Mellow:"#FDF6E3",Matcha:"#E8F5E9",Midnight:"#1a1b26",Lavender:"#F3E5F5",Sky:"#E1F5FE",Rose:"#FFF1F0",Sunset:"#FFF5E6",Forest:"#1B5E20",DeepSea:"#01579B",Charcoal:"#212121",Sand:"#F4A460",Mint:"#F0FFF0",Plum:"#4B0082",Peach:"#FFDAB9",Slate:"#708090",Ghost:"#E8ECEF"};
const BORDERS={Slate:"#657B83",Gold:"#DAA520",Neon:"#B026FF",Red:"#DC143C",Black:"#000",Silver:"#C0C0C0",Bronze:"#CD7F32",Electric:"#00FFFF",Lime:"#32CD32",Pink:"#FF69B4",Wine:"#800",Navy:"#000080",Olive:"#808000",Teal:"#008080",Orange:"#FF8C00",White:"#FFF"};
const OUTLINES={Default:"def",Rainbow:"rbw",White:"wht",Black:"blk"};
const SIZES=[18,24,30,38,46,55,65,76,88,102,118,135];
let st={score:0,best:0,wallet:0,eq:{sk:'Fruit',th:'Mellow',bd:'Slate',ot:'def'},owned:['sk_Fruit','th_Mellow','bd_Slate','ot_Default'],found:[0]};
let engine,canvas,ctx,W,H,floor,wallL,wallR,curIdx=0,nextIdx=1,lastX=150,canDrop=true,isDead=false,activeDrag=null,dragP={x:0,y:0},combo=1,lastM=0;

function init(){
    load(); canvas=document.getElementById('c'); ctx=canvas.getContext('2d');
    engine=E.create({gravity:{y:1.2}}); resize();
    window.addEventListener('resize',resize);
    canvas.addEventListener('pointerdown',onDown);
    canvas.addEventListener('pointermove',onMove);
    canvas.addEventListener('pointerup',onUp);
    Ev.on(engine,'collisionStart',e=>{
        e.pairs.forEach(p=>{
            const a=p.bodyA,b=p.bodyB;
            if(a.plugin?.t!==undefined&&b.plugin?.t===a.plugin.t&&a.plugin.t<11){
                const t=a.plugin.t,pos={x:(a.position.x+b.position.x)/2,y:(a.position.y+b.position.y)/2};
                C.remove(engine.world,[a,b]); spawn(pos.x,pos.y,t+1,false);
                const now=Date.now(); combo=(now-lastM<1500)?Math.min(5,combo+1):1; lastM=now;
                if(combo>1)showCombo();
                st.score+=(t+1)*10*combo; st.wallet+=(t+1);
                if(!st.found.includes(t+1))st.found.push(t+1); updUI(); save();
            }
        });
    });
    loop();
}
function resize(){
    W=window.innerWidth;H=window.innerHeight;
    canvas.width=W*devicePixelRatio;canvas.height=H*devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    if(floor)C.remove(engine.world,[floor,wallL,wallR]);
    floor=B.rectangle(W/2,H-75,W,500,{isStatic:true});
    wallL=B.rectangle(7.5,H/2,15,H*2,{isStatic:true});
    wallR=B.rectangle(W-7.5,H/2,15,H*2,{isStatic:true});
    C.add(engine.world,[floor,wallL,wallR]);
}
function spawn(x,y,t,isDrop){
    const b=B.circle(x,y,SIZES[t],{restitution:0.3,plugin:{t:t}});
    C.add(engine.world,b);
    if(isDrop){curIdx=nextIdx;nextIdx=Math.floor(Math.random()*5);canDrop=false;setTimeout(()=>canDrop=true,500);updUI();}
}
function onDown(e){
    if(isDead||activeDrag)return;
    lastX=e.clientX;
}
function onMove(e){
    if(activeDrag){dragP={x:e.clientX,y:e.clientY};return;}
    lastX=Math.max(40,Math.min(W-40,e.clientX));
}
function onUp(e){
    if(activeDrag){releasePower(e.clientX,e.clientY);return;}
    if(canDrop&&!isDead&&e.clientY>140&&e.clientY<H-100)spawn(lastX,160,curIdx,true);
}
function startDrag(e,type){
    if(st.wallet<({bomb:500,wipe:1000,evo:1500}[type])) return showToast("LOW FUNDS");
    activeDrag=type; dragP={x:e.clientX,y:e.clientY};
}
function releasePower(x,y){
    const type=activeDrag; activeDrag=null;
    const targets=C.allBodies(engine.world).filter(b=>b.plugin);
    let success=false;
    if(type==='bomb'){
        targets.forEach(b=>{if(M.Vector.magnitude(M.Vector.sub(b.position,{x,y}))<80)C.remove(engine.world,b)});
        success=true;
    }else{
        const hit=targets.find(b=>M.Bounds.contains(b.bounds,{x,y}));
        if(hit){
            if(type==='wipe')targets.forEach(b=>{if(b.plugin.t===hit.plugin.t)C.remove(engine.world,b)});
            if(type==='evo'&&hit.plugin.t<11)targets.forEach(b=>{if(b.plugin.t===hit.plugin.t){const p=b.position;C.remove(engine.world,b);spawn(p.x,p.y,hit.plugin.t+1,false)}});
            success=true;
        }
    }
    if(success){st.wallet-={bomb:500,wipe:1000,evo:1500}[type];updUI();save();}
}
function loop(){
    E.update(engine,16); ctx.clearRect(0,0,W,H);
    document.body.style.background=THEMES[st.eq.th];
    ctx.fillStyle=BORDERS[st.eq.bd]; ctx.fillRect(0,0,15,H); ctx.fillRect(W-15,0,15,H);
    ctx.setLineDash([5,5]);ctx.strokeStyle="red";ctx.beginPath();ctx.moveTo(0,165);ctx.lineTo(W,165);ctx.stroke();ctx.setLineDash([]);
    const now=Date.now();
    C.allBodies(engine.world).forEach(b=>{
        if(!b.plugin)return;
        if(b.position.y<165&&b.speed<0.2){if(!b.tm)b.tm=now;if(now-b.tm>2000)isDead=true}else b.tm=null;
        ctx.save();ctx.translate(b.position.x,b.position.y);ctx.rotate(b.angle);
        ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(0,0,SIZES[b.plugin.t],0,Math.PI*2);ctx.fill();
        if(st.eq.ot==='rbw')ctx.strokeStyle=`hsl(${now/10%360},100%,50%)`;
        else ctx.strokeStyle=(st.eq.ot==='wht')?'#fff':(st.eq.ot==='blk')?'#000':'#0002';
        ctx.lineWidth=3;ctx.stroke();
        ctx.font=`${SIZES[b.plugin.t]*1.2}px Arial`;ctx.textAlign="center";ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk][b.plugin.t],0,0);ctx.restore();
    });
    if(canDrop&&!activeDrag&&!isDead){
        ctx.globalAlpha=0.3;ctx.font="40px Arial";ctx.fillText(SKINS[st.eq.sk][curIdx],lastX,140);ctx.globalAlpha=1;
    }
    if(activeDrag){
        ctx.beginPath();ctx.arc(dragP.x,dragP.y,type==='bomb'?80:10,0,Math.PI*2);
        ctx.strokeStyle=activeDrag==='bomb'?'orange':activeDrag==='wipe'?'purple':'gold';ctx.stroke();
    }
    if(isDead)document.getElementById('game-over').style.display='flex';
    requestAnimationFrame(loop);
}
function updUI(){
    document.getElementById('score').innerText=st.score;
    document.getElementById('wallet').innerText=st.wallet;
    document.getElementById('next-box').innerText=SKINS[st.eq.sk][nextIdx];
    const pb=document.getElementById('prog-bar');pb.innerHTML='';
    SKINS[st.eq.sk].forEach((s,i)=>{if(i<12)pb.innerHTML+=`<span style="opacity:${st.found.includes(i)?1:0.1}">${s}</span>`});
    ['bomb','wipe','evo'].forEach(p=>document.getElementById('p-'+p).classList.toggle('locked',st.wallet<({bomb:500,wipe:1000,evo:1500}[p])));
}
function renderShop(){
    const c=document.getElementById('shop-items');c.innerHTML='';
    const cats=[{n:'Skins',k:'sk',d:SKINS,v:1500},{n:'Themes',k:'th',d:THEMES,v:500},{n:'Borders',k:'bd',d:BORDERS,v:500},{n:'Outlines',k:'ot',d:OUTLINES,v:1000}];
    cats.forEach(cat=>{
        c.innerHTML+=`<h4>${cat.n}</h4><div class="grid" id="g-${cat.k}"></div>`;
        Object.keys(cat.d).forEach(item=>{
            const id=cat.k+'_'+item, owned=st.owned.includes(id), eq=st.eq[cat.k]===(cat.k==='ot'?OUTLINES[item]:item);
            const card=document.createElement('div');card.className=`card ${eq?'equipped':''}`;
            card.innerHTML=`<div class="preview-swatch" style="${cat.k==='th'?'background:'+cat.d[item]:(cat.k==='bd'?'border-color:'+cat.d[item]:'')}">${cat.k==='sk'?cat.d[item][0]:''}</div><b>${item}</b><br>${eq?'Equipped':owned?'Owned':'$'+cat.v}`;
            card.onclick=()=>{
                if(owned)st.eq[cat.k]=(cat.k==='ot'?OUTLINES[item]:item);
                else if(st.wallet>=cat.v){st.wallet-=cat.v;st.owned.push(id);st.eq[cat.k]=(cat.k==='ot'?OUTLINES[item]:item);}
                save();renderShop();updUI();
            };
            document.getElementById('g-'+cat.k).appendChild(card);
        });
    });
}
function showCombo(){const u=document.getElementById('combo-ui');u.innerText=`${WORDS[st.eq.sk]} x${combo}`;u.style.opacity=1;setTimeout(()=>u.style.opacity=0,800)}
function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.style.display='block';setTimeout(()=>t.style.display='none',2000)}
function toggleModal(id){const m=document.getElementById(id);m.classList.toggle('open');if(id==='shop-modal')renderShop()}
function restart(){C.clear(engine.world,false);resize();st.score=0;isDead=false;st.found=[0];document.getElementById('game-over').style.display='none';updUI()}
function save(){localStorage.setItem('fm_v136',JSON.stringify(st))}
function load(){const d=localStorage.getItem('fm_v136');if(d)Object.assign(st,JSON.parse(d))}
window.onload=init;
</script>
</body>
</html>
