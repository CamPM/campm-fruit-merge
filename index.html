<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Fruit Merge v1.11</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root{--bg:#FDF6E3;--bd:#657B83;--txt:#586E75;--acc:#2AA198;--err:#DC143C;--gold:#D4AF37;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
*{box-sizing:border-box;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
body{margin:0;overflow:hidden;background:var(--bg);font-family:var(--font);color:var(--txt)}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;display:flex;flex-direction:column;justify-content:space-between}
.top{height:110px;padding:10px 15px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);pointer-events:auto;border-bottom:3px solid var(--bd)}
.row{display:flex;justify-content:space-between;align-items:center}
.score{font-size:22px;font-weight:900}
#next-box{width:46px;height:46px;border:2px dashed var(--bd);border-radius:50%;display:grid;place-items:center;font-size:28px;background:#fff}
.bar{display:flex;justify-content:space-between;background:rgba(0,0,0,.08);padding:4px;border-radius:10px;margin-top:6px}
.dot{width:14px;height:14px;border-radius:50%;background:rgba(0,0,0,0.1)}
.dot.on{transform:scale(1.2);background:#fff;box-shadow:0 0 5px rgba(0,0,0,0.3)}
.bot{height:95px;background:rgba(255,255,255,0.98);border-top:3px solid var(--bd);display:flex;align-items:center;padding:0 15px;pointer-events:auto;justify-content:space-between;padding-bottom:env(safe-area-inset-bottom)}
.btn-grp{display:flex;gap:12px;align-items:center}
.btn{background:0;border:0;font-size:26px;display:flex;flex-direction:column;align-items:center;opacity:.25;transition:0.2s;cursor:pointer}
.btn.can-afford{opacity:.7} .btn.act{opacity:1;color:var(--acc);transform:scale(1.1)}
.btn span{font-size:9px;font-weight:900;margin-top:3px}
.divider{width:2px;height:45px;background:var(--bd);opacity:0.3}
.modal{position:absolute;top:0;left:0;width:100%;height:100%;background:#000C;z-index:99;display:none;align-items:center;justify-content:center;pointer-events:auto}
.modal.open{display:flex}
.card{background:#fff;width:94%;max-width:450px;height:82%;border-radius:28px;display:flex;flex-direction:column;overflow:hidden}
.shop-body{flex:1;overflow-y:scroll;padding:20px;background:#f4f4f4;touch-action:pan-y;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}
.shop-body::-webkit-scrollbar{width:28px} .shop-body::-webkit-scrollbar-thumb{background:var(--bd);border-radius:14px;border:7px solid #f4f4f4}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.item{border:2px solid #eee;border-radius:18px;padding:18px;text-align:center;background:#fff}
.item.eq{border:4px solid var(--acc);background:#edfffb}
.cat-title{font-size:13px;font-weight:900;padding:18px 0 6px;text-transform:uppercase;color:var(--acc);border-bottom:2px solid #eee;grid-column:span 2}
#toast{position:absolute;top:130px;left:50%;transform:translateX(-50%);background:var(--err);color:#fff;padding:10px 25px;border-radius:30px;font-size:14px;font-weight:800;display:none;z-index:100}
</style>
</head>
<body>
<div id="toast">Insufficient Funds!</div>
<canvas id="c"></canvas>
<div id="ui">
    <div class="top">
        <div class="row">
            <div><div style="font-size:10px;font-weight:700;opacity:0.6">SCORE</div><div class="score" id="sCurrent">0</div></div>
            <div id="next-box"></div>
            <div style="text-align:right"><div style="font-size:10px;font-weight:700;opacity:0.6">WALLET</div><div class="score" style="color:var(--acc)">üí∞<span id="val-wallet">0</span></div></div>
        </div>
        <div class="bar" id="prog"></div>
    </div>
    <div class="bot">
        <div class="btn-grp">
            <button class="btn pwr" id="b-bomb" onpointerdown="startTool(event,'bomb',50)">üí£<span>$50</span></button>
            <button class="btn pwr" id="b-broom" onpointerdown="startTool(event,'broom',100)">üßπ<span>$100</span></button>
            <button class="btn pwr" id="b-wand" onpointerdown="startTool(event,'wand',150)">ü™Ñ<span>$150</span></button>
        </div>
        <div class="divider"></div>
        <div class="btn-grp">
            <button class="btn" style="opacity:1" onclick="toggleModal('m-info')">‚ùì<span>Help</span></button>
            <button class="btn" style="opacity:1" onclick="toggleStore()">üõí<span>Shop</span></button>
        </div>
    </div>
</div>

<div class="modal" id="m-store"><div class="card"><div style="padding:22px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #eee"><b>Shop (üí∞<span id="shop-wallet">0</span>)</b><span onclick="toggleStore()" style="cursor:pointer;font-size:32px">‚úï</span></div><div class="shop-body" id="shop-container"></div></div></div>
<div class="modal" id="m-info"><div class="card"><div style="padding:20px;border-bottom:1px solid #eee"><b>Detailed Help</b></div><div class="shop-body" style="background:#fff">
    <h4>Power-Up Drag Mechanic</h4><p>Press and hold a power-up button, then drag your finger into the arena. A dashed circle will follow your touch showing the range. Release to activate.</p>
    <h4>Targeting</h4><p>Fruits that will be hit by the power-up will glow with a pulsing gold outline.</p>
    <h4>Shop Categories</h4><p>You can equip 1 item from each of the 4 categories at a time. Selecting a new one automatically replaces the old one.</p>
    <button class="btn" style="background:var(--acc);color:#fff;padding:12px;border-radius:10px;opacity:1;width:100%" onclick="toggleModal('m-info')">Got it</button>
</div></div></div>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, Ev=M.Events, Q=M.Query;
const SKINS={'Fruit':['üçí','üçì','üçá','üçä','üçé','üçê','üçë','üçç','üçà','üçâ','ü••','ü•ù'],'Space':['üåë','‚òÑÔ∏è','üõ∞Ô∏è','üöÄ','üõ∏','üëæ','üî≠','üåå','ü™ê','‚òÄÔ∏è','üåÄ','üëΩ'],'Animals':['üêû','üê∏','üê¢','ü¶Ü','üêí','ü¶â','üêß','üê∫','ü¶ì','ü¶ç','üêò','üêã'],'Weather':['üíß','‚ùÑÔ∏è','üå™Ô∏è','üåà','‚òÄÔ∏è','‚òÅÔ∏è','‚õàÔ∏è','üå©Ô∏è','üå´Ô∏è','üå§Ô∏è','üå¨Ô∏è','‚òÇÔ∏è'],'Dessert':['üç¨','üç™','üç©','üç´','üçÆ','üç¶','üßÅ','üç∞','ü•ß','ü•û','üßá','üéÇ'],'Shapes':['üî¥','üü†','üü°','üü¢','üîµ','üü£','üü§','‚ö´','‚¨ú','üü¶','üüß','üü•'],'Music':['üéµ','üé∂','üé∏','üéπ','üé∫','üéª','üé∑','ü•Å','üé§','üéß','üìª','üéº'],'Plants':['üå±','üåø','‚òòÔ∏è','üçÄ','üåµ','üå¥','üå≥','üå≤','üçÇ','üçÅ','üçÑ','üåπ']};
const THEMES={'Mellow':'#FDF6E3','Matcha':'#E8F5E9','Midnight':'#1a1b26','Lavender':'#F3E5F5','Sky':'#E1F5FE','Sunset':'#FFF3E0','Slate':'#263238','Rose':'#FCE4EC','Mint':'#D0F0C0','Ocean':'#E0F7FA','Lemon':'#FFFDE7','Plum':'#F3E5F5','Coffee':'#EFEBE9','Storm':'#ECEFF1','Forest':'#F1F8E9','Blush':'#FFF5F8'};
const BORDERS={'Slate':'#657B83','Gold':'#DAA520','Red':'#DC143C','Neon':'#B026FF','Black':'#000000','White':'#FFFFFF','Grey':'#95A5A6','Blue':'#2980B9','Green':'#27AE60','Teal':'#16A085','Orange':'#E67E22','Pink':'#E91E63','Purple':'#8E44AD','Brown':'#795548','Mint':'#1ABC9C','Navy':'#2C3E50'};
const OUTLINES={'Soft':'def','White':'white','Black':'black','Rainbow':'rainbow'};

let st={s:0, w:parseInt(localStorage.getItem('f11_w')||0), h:parseInt(localStorage.getItem('f11_h')||0), 
    eq:JSON.parse(localStorage.getItem('f11_e')||'{"sk":"Fruit","ot":"def","th":"Mellow","bd":"Slate"}'), 
    inv:JSON.parse(localStorage.getItem('f11_i')||'["sk_Fruit","ot_def","th_Mellow","bd_Slate"]'),
    next:0, drag:0, x:0, y:0, drop:1, tool:null, toolCost:0, over:0, max:-1};

const cv=document.getElementById('c'), cx=cv.getContext('2d'), eng=E.create();
let W, H, DL;

function rsz(){
    W=window.innerWidth; H=window.innerHeight; DL=H*0.15;
    cv.width=W*devicePixelRatio; cv.height=H*devicePixelRatio;
    cx.scale(devicePixelRatio,devicePixelRatio);
    C.clear(eng.world,0,1);
    const t=400;
    const floor=B.rectangle(W/2,H-95+t/2,W,t,{isStatic:1,friction:0.8});
    C.add(eng.world,[floor,B.rectangle(0,H/2,40,H*2,{isStatic:1}),B.rectangle(W,H/2,40,H*2,{isStatic:1})]);
}
window.onresize=rsz; rsz();

Ev.on(eng,'collisionStart',e=>{
    e.pairs.forEach(p=>{
        const a=p.bodyA, b=p.bodyB;
        if(a.tier!==undefined && b.tier!==undefined && a.tier===b.tier && a.tier<11){
            const n=a.tier+1, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
            C.remove(eng.world,[a,b]);
            const nb=B.circle(pos.x,pos.y,10+(n*7),{restitution:0.4}); nb.tier=n; C.add(eng.world,nb);
            updSc((n+1)*10); if(n>st.max){st.max=n; renderPrg();}
        }
    });
});

function loop(){
    E.update(eng,16); cx.clearRect(0,0,W,H);
    document.body.style.background=THEMES[st.eq.th];
    
    cx.beginPath(); cx.moveTo(20,DL); cx.lineTo(W-20,DL); cx.strokeStyle='#F44'; cx.setLineDash([8,8]); cx.lineWidth=3; cx.stroke(); cx.setLineDash([]);
    cx.fillStyle=BORDERS[st.eq.bd]; cx.globalAlpha=0.8; cx.fillRect(0,0,20,H); cx.fillRect(W-20,0,20,H); cx.globalAlpha=1;

    const bs = C.allBodies(eng.world);
    const pulse = (Math.sin(Date.now()/150)+1)/2;

    bs.forEach(b=>{
        if(b.isStatic || b.tier===undefined) return;
        if(b.position.y-b.circleRadius < DL && b.speed<0.5){ if(!b.tm) b.tm=Date.now(); if(Date.now()-b.tm>2000) location.reload(); } else b.tm=null;
        
        const r=b.circleRadius; cx.translate(b.position.x,b.position.y); cx.rotate(b.angle);
        
        // Highlight logic
        let isHighlighted = false;
        if(st.tool){
            const dist = M.Vector.magnitude(M.Vector.sub(b.position, {x:st.x, y:st.y}));
            if(st.tool==='bomb' && dist < 120) isHighlighted = true;
            if((st.tool==='broom' || st.tool==='wand') && dist < r+40) isHighlighted = true;
        }

        if(isHighlighted){
            cx.strokeStyle=st.tool==='broom'?'#000':'var(--gold)';
            cx.lineWidth = 6 + (pulse*4);
            cx.beginPath(); cx.arc(0,0,r+2,0,6.28); cx.stroke();
        }

        cx.shadowColor=COLORS[b.tier]; cx.shadowBlur=15; cx.fillStyle='#fff'; cx.beginPath(); cx.arc(0,0,r,0,6.28); cx.fill();
        cx.shadowBlur=0; 
        
        if(st.eq.ot==='rainbow') cx.strokeStyle=`hsl(${Date.now()/5%360},100%,50%)`;
        else cx.strokeStyle=st.eq.ot==='white'?'#fff':(st.eq.ot==='black'?'#000':'#0001');
        cx.lineWidth=3; cx.stroke();
        
        cx.font=`bold ${r*1.4}px serif`; cx.textAlign='center'; cx.textBaseline='middle'; cx.fillText(SKINS[st.eq.sk][b.tier],0,0);
        cx.rotate(-b.angle); cx.translate(-b.position.x,-b.position.y);
    });

    if(st.tool){
        cx.beginPath(); cx.arc(st.x, st.y, st.tool==='bomb'?120:40, 0, 6.28);
        cx.strokeStyle='#fff'; cx.setLineDash([5,5]); cx.stroke(); cx.setLineDash([]);
    } else if(st.drag && st.drop){
        let gx=Math.max(50,Math.min(W-50,st.x));
        cx.font="45px serif"; cx.globalAlpha=0.4; cx.fillText(SKINS[st.eq.sk][st.next],gx,DL+20); cx.globalAlpha=1;
    }

    chkAfford();
    if(!st.over) requestAnimationFrame(loop);
}

function startTool(e, type, cost){
    if(st.w < cost){
        const t=document.getElementById('toast'); t.style.display='block';
        setTimeout(()=>t.style.display='none', 2000);
        return;
    }
    st.tool = type; st.toolCost = cost;
}

function ptr(e,t){
    const touch=e.touches?e.touches[0]:e; const r=cv.getBoundingClientRect();
    st.x=(touch.clientX-r.left)*(W/r.width); st.y=(touch.clientY-r.top)*(H/r.height);
    if(t==='d' && !e.target.closest('button,.modal')) st.drag=1;
    if(t==='u'){
        if(st.tool) useTool();
        st.drag=0;
    }
}

function useTool(){
    let bs=C.allBodies(eng.world);
    let used = false;
    if(st.tool==='bomb'){
        C.remove(eng.world, bs.filter(b=>!b.isStatic && b.tier!==undefined && M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y}))<120));
        used = true;
    } else {
        let target=bs.find(b=>b.tier!==undefined && M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y})) < b.circleRadius+40);
        if(target){
            if(st.tool==='broom') C.remove(eng.world, bs.filter(b=>b.tier===target.tier));
            if(st.tool==='wand' && target.tier<11){
                let t=target.tier, p=target.position; C.remove(eng.world, target);
                let nb=B.circle(p.x,p.y,10+((t+1)*7),{restitution:0.4}); nb.tier=t+1; C.add(eng.world,nb);
            }
            used = true;
        }
    }
    if(used){ st.w -= st.toolCost; updSc(0); }
    st.tool=null;
}

window.addEventListener('pointerdown', e=>ptr(e,'d'));
window.addEventListener('pointermove', e=>ptr(e,'m'));
window.addEventListener('pointerup', e=>ptr(e,'u'));

function chkAfford(){
    document.getElementById('b-bomb').classList.toggle('can-afford', st.w>=50);
    document.getElementById('b-broom').classList.toggle('can-afford', st.w>=100);
    document.getElementById('b-wand').classList.toggle('can-afford', st.w>=150);
}

function updSc(n){ st.s+=n; st.w+=Math.floor(n/10); document.getElementById('sCurrent').innerText=st.s; document.getElementById('val-wallet').innerText=st.w; save(); }
function updPrg(){ const d=document.getElementById('prog'); d.innerHTML=''; for(let i=0;i<12;i++) d.innerHTML+=`<div class="dot ${i<=st.max?'on':''}" style="background:${i<=st.max?COLORS[i]:''}"></div>`; }
function save(){ localStorage.setItem('f11_i',JSON.stringify(st.inv)); localStorage.setItem('f11_e',JSON.stringify(st.eq)); localStorage.setItem('f11_w',st.w); }
function toggleModal(id){ document.getElementById(id).classList.toggle('open'); }
function toggleStore(){ document.getElementById('m-store').classList.toggle('open'); if(document.getElementById('m-store').classList.contains('open')) renderShop(); }

function renderShop(){
    document.getElementById('shop-wallet').innerText=st.w;
    const g=document.getElementById('shop-container'); g.innerHTML='<div class="grid" id="sg"></div>'; const sg=document.getElementById('sg');
    const cats=[{n:'Skins',k:'sk',m:SKINS},{n:'Outlines',k:'ot',m:OUTLINES},{n:'Themes',k:'th',m:THEMES},{n:'Borders',k:'bd',m:BORDERS}];
    
    cats.forEach(c=>{
        sg.innerHTML+=`<div class="cat-title">${c.n}</div>`;
        Object.keys(c.m).forEach(key=>{
            const id=c.k+'_'+key; const own=st.inv.includes(id); const eq=st.eq[c.k]===key; const price=(c.n==='Skins'?500:(c.n==='Outlines'?2000:(c.n==='Themes'?300:200)));
            const el=document.createElement('div'); el.className=`item ${eq?'eq':''}`;
            el.innerHTML=`<b>${key}</b><br><small>${eq?'Equipped':(own?'Owned':'$'+price)}</small>`;
            el.onclick=()=>{
                if(own){ st.eq[c.k]=key; }
                else if(st.w>=price){ st.w-=price; st.inv.push(id); st.eq[c.k]=key; }
                save(); renderShop();
            };
            sg.appendChild(el);
        });
    });
}
updSc(0); updPrg(); loop();
</script></body></html>
