<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Merge v49 Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #E6E6FA; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        /* High-Z Index for Modals only */
        .modal { display: none; position: fixed; inset: 10%; background: white; z-index: 1000; border: 5px solid #3498db; border-radius: 20px; padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .item { border: 2px solid #eee; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; }
        .active-item { border-color: #2ecc71; background: #f0fff4; }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="gameCanvas"></canvas>
</div>

<div id="shopModal" class="modal">
    <div style="display:flex; justify-content:space-between"><h3>Market</h3><button onclick="closeModal()">X</button></div>
    <p>Points: <b id="pts-display">0</b></p>
    <h4>Skins</h4><div id="skin-grid" class="grid"></div>
    <h4>Themes</h4><div id="theme-grid" class="grid"></div>
</div>

<script>
const SKINS = {
    Fruit: ["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸŽƒ"],
    Animals: ["ðŸ­","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ¦","ðŸ¯","ðŸ·","ðŸ¸","ðŸ™","ðŸ³","ðŸ¦„"],
    Retro: ["â–²","â– ","â¬¢","â—†","â˜…","âœš","âœ–","â¬¤","â¬Ÿ","â–¼","â¬“","âŒ¬"],
    Space: ["â˜„ï¸","ðŸ›°ï¸","ðŸª","ðŸŒ™","â˜€ï¸","ðŸ”­","ðŸš€","ðŸ‘½","ðŸ›¸","ðŸŒŒ","ðŸŒ ","ðŸ‘¨â€ðŸš€"],
    Desserts: ["ðŸª","ðŸ©","ðŸ§","ðŸ¦","ðŸ°","ðŸ¥§","ðŸ«","ðŸ¬","ðŸ­","ðŸ®","ðŸ¯","ðŸŽ‚"],
    Cars: ["ðŸŽï¸","ðŸš—","ðŸš•","ðŸš™","ðŸšŒ","ðŸš","ðŸš›","ðŸšœ","ðŸš“","ðŸš‘","ðŸš’","ðŸš€"],
    Plants: ["ðŸŒ¿","ðŸŒµ","ðŸª´","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŽ‹","ðŸŒ¿","ðŸ€","ðŸ„","ðŸŒ»","ðŸŒ¹"]
};
const THEMES = { Lilac: "#E6E6FA", Sunset: "#ff7675", Forest: "#55efc4", Midnight: "#2d3436", Gold: "#fdcb6e", Ocean: "#0984e3", Rose: "#fd79a8", Charcoal: "#2f3640" };
const SIZES = [20, 28, 36, 46, 58, 72, 86, 102, 120, 138, 158, 180];
const COLORS = ["#ff7979", "#ffbe76", "#f6e58d", "#badc58", "#7ed6df", "#686de0", "#4834d4", "#f0932b", "#eb4d4b", "#6ab04c", "#130f40", "#222f3e"];

let state = { score: 0, best: 0, pts: 0, skin: 'Fruit', theme: 'Lilac', owned: ['Fruit', 'Lilac'], activePwr: null };
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let engine, runner, currentIdx = 0, nextIdx = 1, lastX = 200, canDrop = true;

function load() {
    const saved = localStorage.getItem('fm_v49_stable');
    if(saved) Object.assign(state, JSON.parse(saved));
}
function save() { localStorage.setItem('fm_v49_stable', JSON.stringify(state)); }

function init() {
    load();
    canvas.width = Math.min(window.innerWidth, 500);
    canvas.height = Math.min(window.innerHeight, 800);
    
    engine = Matter.Engine.create();
    const wallOpts = { isStatic: true, render: { visible: false } };
    Matter.Composite.add(engine.world, [
        Matter.Bodies.rectangle(canvas.width/2, canvas.height + 20, canvas.width, 40, wallOpts),
        Matter.Bodies.rectangle(-20, canvas.height/2, 40, canvas.height, wallOpts),
        Matter.Bodies.rectangle(canvas.width + 20, canvas.height/2, 40, canvas.height, wallOpts)
    ]);

    Matter.Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            const a = p.bodyA, b = p.bodyB;
            if(a.plugin && b.plugin && a.plugin.t === b.plugin.t && a.plugin.t < 11) {
                const nt = a.plugin.t + 1;
                const pos = { x: (a.position.x+b.position.x)/2, y: (a.position.y+b.position.y)/2 };
                Matter.Composite.remove(engine.world, [a, b]);
                Matter.Composite.add(engine.world, Matter.Bodies.circle(pos.x, pos.y, SIZES[nt], { plugin: {t: nt} }));
                state.score += nt * 10; state.pts += nt;
                if(state.score > state.best) state.best = state.score;
                save();
            }
        });
    });

    runner = Matter.Runner.create();
    Matter.Runner.run(runner, engine);
    requestAnimationFrame(renderLoop);
}

function renderLoop() {
    // Background
    ctx.fillStyle = THEMES[state.theme];
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Header Area (UI)
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillRect(0, 0, canvas.width, 120);
    
    ctx.fillStyle = "#333";
    ctx.font = "bold 16px Arial";
    ctx.textAlign = "left"; ctx.fillText(`SCORE: ${state.score}`, 20, 30);
    ctx.textAlign = "right"; ctx.fillText(`BEST: ${state.best}`, canvas.width - 20, 30);
    ctx.textAlign = "center"; ctx.fillText(`POINTS: ${state.pts}`, canvas.width/2, 55);
    ctx.font = "30px Arial"; ctx.fillText(`NEXT: ${SKINS[state.skin][nextIdx]}`, canvas.width/2, 100);

    // Power Up Buttons (Drawn on Canvas)
    drawBtn(20, canvas.height - 70, "ðŸ’£", "#e67e22", state.activePwr === 'bomb');
    drawBtn(80, canvas.height - 70, "ðŸ§¹", "#9b59b6", state.activePwr === 'wipe');
    drawBtn(140, canvas.height - 70, "âœ¨", "#f1c40f", state.activePwr === 'evo');
    drawBtn(canvas.width - 100, canvas.height - 70, "SHOP", "#3498db", false, 80);

    // Death Line
    ctx.strokeStyle = "red"; ctx.setLineDash([5, 5]);
    ctx.beginPath(); ctx.moveTo(0, 125); ctx.lineTo(canvas.width, 125); ctx.stroke(); ctx.setLineDash([]);

    // Crosshair & Current Fruit
    if(canDrop && !state.activePwr) {
        ctx.strokeStyle = "rgba(0,0,0,0.1)";
        ctx.beginPath(); ctx.moveTo(lastX, 125); ctx.lineTo(lastX, canvas.height); ctx.stroke();
        ctx.font = "40px Arial"; ctx.textAlign = "center";
        ctx.fillText(SKINS[state.skin][currentIdx], lastX, 115);
    }

    // Bodies
    const bodies = Matter.Composite.allBodies(engine.world);
    bodies.forEach(b => {
        if(b.plugin && b.plugin.t !== undefined) {
            ctx.save();
            ctx.translate(b.position.x, b.position.y);
            ctx.rotate(b.angle);
            ctx.fillStyle = COLORS[b.plugin.t];
            ctx.beginPath(); ctx.arc(0, 0, b.circleRadius, 0, Math.PI*2); ctx.fill();
            ctx.font = (b.circleRadius * 1.5) + "px Arial";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(SKINS[state.skin][b.plugin.t], 0, 0);
            ctx.restore();

            if(b.position.y < 125 && !b.isStatic) {
                if(!b.plugin.tOut) b.plugin.tOut = Date.now();
                if(Date.now() - b.plugin.tOut > 3000) { alert("Game Over!"); location.reload(); }
            } else { b.plugin.tOut = null; }
        }
    });

    if(state.activePwr) {
        ctx.fillStyle = "rgba(52, 152, 219, 0.3)";
        ctx.fillRect(0, 120, canvas.width, canvas.height - 200);
        ctx.fillStyle = "#fff"; ctx.font = "bold 20px Arial";
        ctx.fillText("TAP FRUIT TO USE POWER-UP", canvas.width/2, canvas.height/2);
    }

    requestAnimationFrame(renderLoop);
}

function drawBtn(x, y, txt, color, active, w = 50) {
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.roundRect(x, y, w, 50, 10); ctx.fill();
    ctx.strokeStyle = active ? "white" : "#333"; ctx.lineWidth = 3; ctx.stroke();
    ctx.fillStyle = "white"; ctx.font = w > 50 ? "bold 16px Arial" : "24px Arial";
    ctx.textAlign = "center"; ctx.fillText(txt, x + w/2, y + 32);
}

canvas.addEventListener('pointerdown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left; const y = e.clientY - rect.top;

    // Button Detection
    if(y > canvas.height - 80) {
        if(x > 20 && x < 70) state.activePwr = 'bomb';
        else if(x > 80 && x < 130) state.activePwr = 'wipe';
        else if(x > 140 && x < 190) state.activePwr = 'evo';
        else if(x > canvas.width - 100) openShop();
        return;
    }

    if(state.activePwr) {
        const bodies = Matter.Composite.allBodies(engine.world).filter(b => b.plugin && b.plugin.t !== undefined);
        const hit = bodies.find(b => Matter.Bounds.contains(b.bounds, {x, y}));
        if(hit) {
            if(state.activePwr === 'bomb') {
                bodies.forEach(b => { if(Math.hypot(b.position.x - hit.position.x, b.position.y - hit.position.y) < 150) Matter.Composite.remove(engine.world, b); });
                state.pts -= 500;
            } else if(state.activePwr === 'wipe') {
                bodies.forEach(b => { if(b.plugin.t === hit.plugin.t) Matter.Composite.remove(engine.world, b); });
                state.pts -= 1000;
            } else if(state.activePwr === 'evo' && hit.plugin.t < 11) {
                bodies.forEach(b => { if(b.plugin.t === hit.plugin.t) {
                    const nb = Matter.Bodies.circle(b.position.x, b.position.y, SIZES[b.plugin.t+1], { plugin: {t: b.plugin.t+1} });
                    Matter.Composite.remove(engine.world, b); Matter.Composite.add(engine.world, nb);
                }});
                state.pts -= 1500;
            }
            state.activePwr = null; save();
        }
        return;
    }

    if(canDrop && y > 120) {
        const b = Matter.Bodies.circle(lastX, 125, SIZES[currentIdx], { restitution: 0.3, plugin: {t: currentIdx} });
        Matter.Composite.add(engine.world, b);
        currentIdx = nextIdx; nextIdx = Math.floor(Math.random() * 4);
        canDrop = false; setTimeout(() => canDrop = true, 600);
    }
});

canvas.addEventListener('pointermove', (e) => {
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
});

function openShop() {
    document.getElementById('shopModal').style.display = 'block';
    document.getElementById('pts-display').innerText = state.pts;
    const sG = document.getElementById('skin-grid'); sG.innerHTML = '';
    Object.keys(SKINS).forEach(s => {
        sG.innerHTML += `<div class="item ${state.skin===s?'active-item':''}" onclick="buy('${s}','skin')">${SKINS[s][0]}<br>${s}</div>`;
    });
}
window.buy = (id, type) => {
    if(!state.owned.includes(id) && state.pts >= 500) { state.pts -= 500; state.owned.push(id); }
    if(state.owned.includes(id)) state[type] = id;
    save(); openShop();
};
window.closeModal = () => document.getElementById('shopModal').style.display = 'none';

init();
</script>
</body>
</html>
