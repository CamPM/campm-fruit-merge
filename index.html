<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Fruit Merge v1.18 - Final Fix</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root{--bg:#FDF6E3;--bd:#657B83;--txt:#586E75;--acc:#2AA198;--err:#DC143C;--gold:#D4AF37;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
*{box-sizing:border-box;touch-action:none;user-select:none;-webkit-tap-highlight-color:transparent}
body{margin:0;overflow:hidden;background:var(--bg);font-family:var(--font);color:var(--txt);height:100vh;display:flex;flex-direction:column}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;display:flex;flex-direction:column}
.top-bar{height:115px;padding:10px 15px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);pointer-events:auto;border-bottom:3px solid var(--bd)}
.row{display:flex;justify-content:space-between;align-items:center}
.score-val{font-size:20px;font-weight:900}
#next-box{width:42px;height:42px;border:2px dashed var(--bd);border-radius:50%;display:grid;place-items:center;font-size:24px;background:#fff}
.prog-container{display:flex;justify-content:space-between;background:rgba(0,0,0,.05);padding:4px;border-radius:12px;margin-top:8px;height:28px;align-items:center}
.dot{width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;font-size:10px}
.dot.on{transform:scale(1.1);background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.bot-bar{margin-top:auto;height:100px;background:rgba(255,255,255,0.98);border-top:3px solid var(--bd);display:flex;align-items:center;padding:0 15px;pointer-events:auto;justify-content:space-between;padding-bottom:env(safe-area-inset-bottom)}
.btn-grp{display:flex;gap:12px;align-items:center}
.btn{background:0;border:0;font-size:26px;display:flex;flex-direction:column;align-items:center;opacity:.3;transition:0.2s;cursor:pointer}
.btn.can-afford{opacity:.8} .btn.active{opacity:1;color:var(--acc);transform:scale(1.1)}
.btn span{font-size:9px;font-weight:900;margin-top:3px}
.modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:100;display:none;align-items:center;justify-content:center;pointer-events:auto}
.modal.open{display:flex}
.card{background:#fff;width:92%;max-width:450px;height:75%;border-radius:28px;display:flex;flex-direction:column;overflow:hidden}
/* GIANT SCROLLBAR FIX */
.shop-scroll{flex:1;overflow-y:scroll;padding:20px;background:#f8f9fa;touch-action:pan-y !important;pointer-events:auto}
.shop-scroll::-webkit-scrollbar {width: 12px;}
.shop-scroll::-webkit-scrollbar-thumb {background: var(--bd); border-radius: 10px; border: 2px solid #f8f9fa;}
.shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;padding-bottom:40px}
.item-box{border:2px solid #eee;border-radius:20px;padding:15px;text-align:center;background:#fff;transition:0.2s}
.item-box.equipped{border-color:var(--acc);background:#f0fffb}
.cat-label{grid-column:span 2;font-size:12px;font-weight:900;text-transform:uppercase;color:var(--acc);padding:20px 0 10px;border-bottom:1px solid #eee}
#toast{position:absolute;top:130px;left:50%;transform:translateX(-50%);background:var(--err);color:#fff;padding:12px 30px;border-radius:40px;font-size:14px;font-weight:900;display:none;z-index:200}
</style>
</head>
<body>
<div id="toast">INSUFFICIENT FUNDS</div>
<canvas id="c"></canvas>
<div id="ui">
    <div class="top-bar">
        <div class="row">
            <div><div style="font-size:10px;font-weight:800;opacity:0.6">POINTS</div><div class="score-val" id="cur-score">0</div></div>
            <div id="next-box"></div>
            <div style="text-align:right"><div style="font-size:10px;font-weight:800;opacity:0.6">WALLET</div><div class="score-val" style="color:var(--acc)">ğŸ’°<span id="wallet-val">0</span></div></div>
        </div>
        <div class="prog-container" id="prog-bar"></div>
        <div style="text-align:center;font-size:11px;font-weight:800;margin-top:4px;letter-spacing:1px">BEST: <span id="best-score">0</span></div>
    </div>
    <div class="bot-bar">
        <div class="btn-grp">
            <button class="btn" id="b-bomb" onpointerdown="startTool('bomb',50)">ğŸ’£<span>$50</span></button>
            <button class="btn" id="b-broom" onpointerdown="startTool('broom',100)">ğŸ§¹<span>$100</span></button>
            <button class="btn" id="b-wand" onpointerdown="startTool('wand',150)">ğŸª„<span>$150</span></button>
        </div>
        <div class="btn-grp">
            <button class="btn" style="opacity:1" onclick="toggleMute()" id="mute-btn">ğŸ”Š<span>On</span></button>
            <button class="btn" style="opacity:1" onclick="toggleModal('m-info')">â“<span>Help</span></button>
            <button class="btn" style="opacity:1" onclick="toggleFull()">â›¶<span>Full</span></button>
            <button class="btn" style="opacity:1" onclick="toggleStore()">ğŸ›’<span>Shop</span></button>
        </div>
    </div>
</div>

<div class="modal" id="m-store"><div class="card">
    <div style="padding:20px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #eee">
        <b>Shop (ğŸ’°<span id="shop-wallet">0</span>)</b><span onclick="toggleStore()" style="cursor:pointer;font-size:30px">âœ•</span>
    </div>
    <div class="shop-scroll" id="shop-cont"></div>
</div></div>

<div class="modal" id="m-info"><div class="card"><div style="padding:20px;border-bottom:1px solid #eee"><b>Detailed Instructions</b></div><div class="shop-scroll" style="background:#fff">
    <h4 style="color:var(--acc)">Movement</h4><p>Drag anywhere. A dashed line shows where fruit will fall. Release to drop.</p>
    <h4 style="color:var(--err)">Death Line</h4><p>The Red Dotted Line is the limit. 2 seconds above it resets the game.</p>
    <h4 style="color:var(--gold)">Power-Ups</h4><p>Drag from the icon to a target. Affected areas will pulse Gold.</p>
    <button class="btn" style="background:var(--acc);color:#fff;padding:15px;border-radius:15px;opacity:1;width:100%" onclick="toggleModal('m-info')">Got it!</button>
</div></div></div>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, Ev=M.Events;
const SKINS={'Fruit':['ğŸ’','ğŸ“','ğŸ‡','ğŸŠ','ğŸ','ğŸ','ğŸ‘','ğŸ','ğŸˆ','ğŸ‰','ğŸ¥¥','ğŸ¥'],'Space':['ğŸŒ‘','â˜„ï¸','ğŸ›°ï¸','ğŸš€','ğŸ›¸','ğŸ‘¾','ğŸ”­','ğŸŒŒ','ğŸª','â˜€ï¸','ğŸŒ€','ğŸ‘½'],'Animals':['ğŸ','ğŸ¸','ğŸ¢','ğŸ¦†','ğŸ’','ğŸ¦‰','ğŸ§','ğŸº','ğŸ¦“','ğŸ¦','ğŸ˜','ğŸ‹'],'Weather':['ğŸ’§','â„ï¸','ğŸŒªï¸','ğŸŒˆ','â˜€ï¸','â˜ï¸','â›ˆï¸','ğŸŒ©ï¸','ğŸŒ«ï¸','ğŸŒ¤ï¸','ğŸŒ¬ï¸','â˜‚ï¸'],'Dessert':['ğŸ¬','ğŸª','ğŸ©','ğŸ«','ğŸ®','ğŸ¦','ğŸ§','ğŸ°','ğŸ¥§','ğŸ¥','ğŸ§‡','ğŸ‚'],'Shapes':['ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','ğŸŸ¤','âš«','â¬œ','ğŸŸ¦','ğŸŸ§','ğŸŸ¥'],'Music':['ğŸµ','ğŸ¶','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ·','ğŸ¥','ğŸ¤','ğŸ§','ğŸ“»','ğŸ¼'],'Plants':['ğŸŒ±','ğŸŒ¿','â˜˜ï¸','ğŸ€','ğŸŒµ','ğŸŒ´','ğŸŒ³','ğŸŒ²','ğŸ‚','ğŸ','ğŸ„','ğŸŒ¹']};
const THEMES={'Mellow':'#FDF6E3','Matcha':'#E8F5E9','Midnight':'#1a1b26','Lavender':'#F3E5F5','Sky':'#E1F5FE','Sunset':'#FFF3E0','Slate':'#263238','Rose':'#FCE4EC','Mint':'#D0F0C0','Ocean':'#E0F7FA','Lemon':'#FFFDE7','Plum':'#F3E5F5','Coffee':'#EFEBE9','Storm':'#ECEFF1','Forest':'#F1F8E9','Blush':'#FFF5F8'};
const BORDERS={'Slate':'#657B83','Gold':'#DAA520','Red':'#DC143C','Neon':'#B026FF','Black':'#000000','White':'#FFFFFF','Grey':'#95A5A6','Blue':'#2980B9','Green':'#27AE60','Teal':'#16A085','Orange':'#E67E22','Pink':'#E91E63','Purple':'#8E44AD','Brown':'#795548','Mint':'#1ABC9C','Navy':'#2C3E50'};
const OUTLINES={'Default':'def','Rainbow':'rainbow','White':'white','Black':'black'};
const COLORS=['#F00','#F70','#FF0','#0F0','#00F','#4B0','#940','#F14','#0CE','#FD7','#F45','#32C'];

let st={s:0, w:parseInt(localStorage.getItem('f16_w')||0), h:parseInt(localStorage.getItem('f16_h')||0), 
    eq:JSON.parse(localStorage.getItem('f16_e')||'{"sk":"Fruit","ot":"def","th":"Mellow","bd":"Slate"}'), 
    inv:JSON.parse(localStorage.getItem('f16_i')||'["sk_Fruit","ot_def","th_Mellow","bd_Slate"]'),
    next:0, drag:0, x:0, y:0, drop:1, tool:null, toolCost:0, max:-1, mute:false};

const cv=document.getElementById('c'), cx=cv.getContext('2d'), eng=E.create();
let W, H, DL, FY, audioCtx;

function rsz(){
    W=window.innerWidth; H=window.innerHeight; 
    cv.width=W*devicePixelRatio; cv.height=H*devicePixelRatio;
    cx.scale(devicePixelRatio,devicePixelRatio);
    DL=H*0.18; FY=H-100; // Floor exactly at UI
    C.clear(eng.world, false);
    C.add(eng.world,[
        B.rectangle(W/2, FY+250, W, 500, {isStatic:1, friction:0.5, label:'floor'}), // MASSIVE floor to prevent fall-through
        B.rectangle(-25, H/2, 50, H*2, {isStatic:1, label:'wall'}),
        B.rectangle(W+25, H/2, 50, H*2, {isStatic:1, label:'wall'})
    ]);
}
window.onresize=rsz; rsz();

function playPop(){
    if(!audioCtx || st.mute) return;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.frequency.setValueAtTime(400, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime+0.1);
    g.gain.setValueAtTime(0.2, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.1);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1);
}

function playThud(v){
    if(!audioCtx || st.mute || v<2) return;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(60 + Object.keys(SKINS).indexOf(st.eq.sk)*15, audioCtx.currentTime);
    g.gain.setValueAtTime(Math.min(0.2, v/30), audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.2);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.2);
}

Ev.on(eng,'collisionStart',e=>{
    e.pairs.forEach(p=>{
        const a=p.bodyA, b=p.bodyB;
        if(a.tier!==undefined && b.tier!==undefined && a.tier===b.tier && a.tier<11){
            const n=a.tier+1, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
            C.remove(eng.world,[a,b]);
            const nb=B.circle(pos.x,pos.y,12+(n*4.5),{restitution:0.3, friction:0.1}); nb.tier=n; C.add(eng.world,nb);
            st.s+=(n+1)*10; st.w+=Math.floor(((n+1)*10)/10); if(n>st.max){st.max=n; renderPrg();} 
            playPop(); save(); updUI();
        } else if(a.label==='floor' || b.label==='floor'){
            playThud((a.tier?a:b).speed);
        }
    });
});

function loop(){
    E.update(eng,16); cx.clearRect(0,0,W,H);
    document.body.style.background=THEMES[st.eq.th];
    cx.fillStyle=BORDERS[st.eq.bd]; cx.fillRect(0,0,15,H); cx.fillRect(W-15,0,15,H);
    cx.beginPath(); cx.moveTo(15,DL); cx.lineTo(W-15,DL); cx.strokeStyle='#F44'; cx.setLineDash([8,8]); cx.lineWidth=2; cx.stroke(); cx.setLineDash([]);

    const now = Date.now();
    C.allBodies(eng.world).forEach(b=>{
        if(b.isStatic || b.tier===undefined) return;
        if(b.position.y-b.circleRadius < DL && b.speed<0.5){ if(!b.tm) b.tm=now; if(now-b.tm>2000) resetGame(); } else b.tm=null;
        
        const r=b.circleRadius; cx.translate(b.position.x,b.position.y); cx.rotate(b.angle);
        let glow = false;
        if(st.tool){
            const d = M.Vector.magnitude(M.Vector.sub(b.position, {x:st.x, y:st.y}));
            if((st.tool==='bomb'&&d<45) || ((st.tool==='broom'||st.tool==='wand')&&d<r+30)) glow=true;
        }
        cx.shadowColor=COLORS[b.tier]; cx.shadowBlur=glow?25:8; cx.fillStyle='#fff';
        cx.beginPath(); cx.arc(0,0,r,0,6.28); cx.fill(); cx.shadowBlur=0;
        if(glow){ cx.strokeStyle=st.tool==='bomb'?'#F44':'#D4AF37'; cx.lineWidth=5; cx.stroke(); }
        const ot = st.eq.ot==='rainbow' ? `hsl(${now/5%360},100%,50%)` : (st.eq.ot==='white'?'#fff':(st.eq.ot==='black'?'#000':'#0002'));
        cx.strokeStyle=ot; cx.lineWidth=2; cx.stroke();
        cx.font=`${r*1.2}px serif`; cx.textAlign='center'; cx.textBaseline='middle'; cx.fillText(SKINS[st.eq.sk][b.tier],0,2);
        cx.rotate(-b.angle); cx.translate(-b.position.x,-b.position.y);
    });

    if(st.drag && st.drop){
        let gx=Math.max(45,Math.min(W-45,st.x));
        cx.beginPath(); cx.moveTo(gx,DL); cx.lineTo(gx,FY); cx.strokeStyle='#888'; cx.setLineDash([5,5]); cx.globalAlpha=0.4; cx.stroke(); cx.setLineDash([]); cx.globalAlpha=1;
    }
    if(st.tool){ // VISUAL RADIUS FOR POWERUPS
        cx.beginPath(); cx.arc(st.x, st.y, st.tool==='bomb'?45:35, 0, 6.28);
        cx.strokeStyle='rgba(212,175,55,0.5)'; cx.setLineDash([5,5]); cx.stroke(); cx.setLineDash([]);
    }
    chkAff(); requestAnimationFrame(loop);
}

function startTool(t, c){ if(st.w<c){ showToast(); return; } st.tool=t; st.toolCost=c; }
function showToast(){ const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }

function useTool(){
    let bs=C.allBodies(eng.world), used=false;
    if(st.tool==='bomb'){
        C.remove(eng.world, bs.filter(b=>!b.isStatic && b.tier!==undefined && M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y}))<45)); used=true;
    } else {
        let t=bs.find(b=>b.tier!==undefined && M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y})) < b.circleRadius+30);
        if(t){
            if(st.tool==='broom') C.remove(eng.world, bs.filter(b=>b.tier===t.tier));
            if(st.tool==='wand' && t.tier<11){
                let tier=t.tier, p=t.position; C.remove(eng.world,t);
                let nb=B.circle(p.x,p.y,12+((tier+1)*4.5),{restitution:0.3}); nb.tier=tier+1; C.add(eng.world,nb);
            }
            used=true;
        }
    }
    if(used){ st.w-=st.toolCost; save(); updUI(); playPop(); }
    st.tool=null;
}

window.addEventListener('pointerdown', e=>{
    if(e.target.closest('button, .shop-scroll, .modal')) return;
    const r=cv.getBoundingClientRect(); st.x=(e.clientX-r.left)*(W/r.width); st.y=(e.clientY-r.top)*(H/r.height);
    st.drag=1; if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
});
window.addEventListener('pointermove', e=>{
    const r=cv.getBoundingClientRect(); st.x=(e.clientX-r.left)*(W/r.width); st.y=(e.clientY-r.top)*(H/r.height);
});
window.addEventListener('pointerup', ()=>{
    if(st.tool) useTool(); else if(st.drag && st.drop && st.y > 110 && st.y < FY) drop();
    st.drag=0;
});

function drop(){
    const b=B.circle(Math.max(45,Math.min(W-45,st.x)),DL,12+(st.next*4.5),{restitution:0.3, friction:0.1});
    b.tier=st.next; C.add(eng.world,b);
    st.next=Math.floor(Math.random()*5); st.drop=0; setTimeout(()=>st.drop=1,500); updUI();
}

function resetGame(){
    if(st.s > st.h) st.h=st.s; st.s=0; st.max=-1; save();
    C.allBodies(eng.world).forEach(b=> { if(!b.isStatic) C.remove(eng.world,b); });
    renderPrg(); updUI();
}

function chkAff(){
    ['bomb','broom','wand'].forEach((t,i)=>document.getElementById('b-'+t).classList.toggle('can-afford', st.w>=[50,100,150][i]));
}

function updUI(){
    document.getElementById('cur-score').innerText=st.s; document.getElementById('best-score').innerText=st.h;
    document.getElementById('wallet-val').innerText=st.w; document.getElementById('next-box').innerText=SKINS[st.eq.sk][st.next];
}

function renderPrg(){
    const b=document.getElementById('prog-bar'); b.innerHTML='';
    for(let i=0;i<12;i++){ const u=i<=st.max; b.innerHTML+=`<div class="dot ${u?'on':''}" style="border:1px solid ${u?COLORS[i]:'#0001'}">${u?SKINS[st.eq.sk][i]:''}</div>`; }
}

function toggleStore(){ document.getElementById('m-store').classList.toggle('open'); if(document.getElementById('m-store').classList.contains('open')) renderShop(); }
function renderShop(){
    const sg=document.getElementById('shop-cont'); sg.innerHTML='<div class="shop-grid" id="sgrid"></div>'; const grid=document.getElementById('sgrid');
    document.getElementById('shop-wallet').innerText=st.w;
    const cats=[{n:'Skins',k:'sk',m:SKINS,p:500},{n:'Outlines',k:'ot',m:OUTLINES,p:2000},{n:'Themes',k:'th',m:THEMES,p:300},{n:'Borders',k:'bd',m:BORDERS,p:200}];
    cats.forEach(c=>{
        grid.innerHTML+=`<div class="cat-label">${c.n}</div>`;
        Object.keys(c.m).sort().forEach(key=>{
            const id=c.k+'_'+key, own=st.inv.includes(id), val=(c.k==='ot'?OUTLINES[key]:key), eq=st.eq[c.k]===val;
            const d=document.createElement('div'); d.className=`item-box ${eq?'equipped':''}`;
            d.innerHTML=`<div style="font-size:24px;margin-bottom:8px">${c.n==='Skins'?SKINS[key][0]:'â—'}</div><b>${key}</b><br><small>${eq?'Equipped':(own?'Owned':'$'+c.p)}</small>`;
            d.onclick=()=>{
                if(own) st.eq[c.k]=val; else if(st.w>=c.p){ st.w-=c.p; st.inv.push(id); st.eq[c.k]=val; } else showToast();
                save(); renderShop(); updUI(); renderPrg();
            };
            grid.appendChild(d);
        });
    });
}
function toggleMute(){ st.mute=!st.mute; document.getElementById('mute-btn').innerHTML=st.mute?'ğŸ”‡<span>Off</span>':'ğŸ”Š<span>On</span>'; }
function save(){ localStorage.setItem('f16_w',st.w); localStorage.setItem('f16_h',st.h); localStorage.setItem('f16_i',JSON.stringify(st.inv)); localStorage.setItem('f16_e',JSON.stringify(st.eq)); }
function toggleFull(){ const de=document.documentElement; if(!document.fullscreenElement && !document.webkitFullscreenElement){ (de.requestFullscreen||de.webkitRequestFullscreen).call(de); } else { (document.exitFullscreen||document.webkitExitFullscreen).call(document); } }
function toggleModal(id){ document.getElementById(id).classList.toggle('open'); }
updUI(); renderPrg(); loop();
</script></body></html>
