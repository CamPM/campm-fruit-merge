<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fruit Merge v1.34</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --accent: #3498db; --bg: #FDF6E3; --font: -apple-system, system-ui, sans-serif; --panel: rgba(255,255,255,0.95); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { overflow: hidden; background: var(--bg); font-family: var(--font); height: 100vh; width: 100vw; position: fixed; touch-action: none; -webkit-user-select: none; }
        canvas { display: block; width: 100% !important; height: 100% !important; touch-action: none; }

        /* UI PANELS */
        .ui-panel { position: absolute; width: 100%; z-index: 1000; pointer-events: none; }
        .top-bar { top: 0; height: 145px; background: var(--panel); border-bottom: 3px solid #333; pointer-events: auto; padding: 10px 20px; padding-top: env(safe-area-inset-top); }
        .bot-bar { bottom: 0; height: 100px; background: var(--panel); border-top: 3px solid #333; pointer-events: auto; display: flex; align-items: center; justify-content: space-evenly; padding-bottom: env(safe-area-inset-bottom); }
        
        .score-box { text-align: center; min-width: 65px; }
        #next-preview { width: 55px; height: 55px; border: 3px solid #333; border-radius: 50%; display: grid; place-items: center; font-size: 32px; background: #fff; box-shadow: 0 4px 0 #333; }
        
        /* POWER UPS */
        .pwr-btn { width: 48px; height: 48px; border-radius: 12px; border: 2px solid #333; color: white; font-size: 22px; cursor: grab; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; pointer-events: auto; }
        .pwr-btn.locked { filter: grayscale(1); opacity: 0.4; pointer-events: none; }
        .pwr-btn.dragging { transform: scale(1.2) translateY(-10px); z-index: 10001; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        #p-bomb { background: #e67e22; } #p-wipe { background: #9b59b6; } #p-evo { background: #f1c40f; }
        
        /* MULTIPLIER POPUP */
        #multiplier-tag { position: absolute; top: 160px; left: 50%; transform: translateX(-50%); font-weight: 900; font-style: italic; font-size: 28px; color: #e74c3c; text-shadow: 2px 2px 0 #fff; pointer-events: none; opacity: 0; z-index: 2000; transition: 0.2s; }

        /* MODALS */
        .modal { display: none; position: absolute; inset: 20px; background: white; z-index: 5000; border-radius: 25px; border: 5px solid var(--accent); flex-direction: column; overflow: hidden; pointer-events: auto; }
        .modal.open { display: flex; }
        .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding-bottom: 30px; }
        .card { background: #f9f9f9; padding: 12px; border-radius: 15px; text-align: center; border: 3px solid #eee; cursor: pointer; }
        .card.equipped { border-color: #2ecc71; background: #f0fff4; }
        
        .preview-swatch { width: 50px; height: 50px; border-radius: 50%; margin: 5px auto; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 24px; background: white; overflow: hidden; }
        @keyframes rb-cycle { 0% { border-color: red; } 33% { border-color: lime; } 66% { border-color: blue; } 100% { border-color: red; } }
        .rainbow-active { animation: rb-cycle 2s linear infinite; border-width: 4px !important; }

        #game-over { position: absolute; inset: 0; background: rgba(0,0,0,0.92); z-index: 9000; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        #toast { position: absolute; top: 155px; left: 50%; transform: translateX(-50%); background: #ff4757; color: white; padding: 10px 25px; border-radius: 25px; font-weight: bold; display: none; z-index: 10000; }
    </style>
</head>
<body>

<div id="multiplier-tag">JUICY X2!</div>
<div id="toast">LOCKED</div>

<div id="game-over">
    <h1 style="font-size: 3rem;">GAME OVER</h1>
    <p style="font-size: 1.5rem; margin: 20px 0;">Score: <span id="final-score">0</span></p>
    <button id="retry-btn" style="padding:15px 40px; background:#2ecc71; color:white; border:none; border-radius:10px; font-weight:bold;">PLAY AGAIN</button>
</div>

<div class="ui-panel top-bar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="score-box"><b>SCORE</b><div id="cur-score" style="font-size:24px">0</div></div>
        <div id="next-preview"></div>
        <div class="score-box"><b>WALLET</b><div id="wallet-ui" style="font-size:24px; color:#2ecc71">0</div></div>
    </div>
    <div id="prog-bar" style="display:flex; justify-content:space-around; margin-top:12px; background: rgba(0,0,0,0.07); border-radius: 12px; padding: 6px;"></div>
    <div style="text-align:center; font-size: 11px; margin-top: 6px; font-weight: bold; color: #7f8c8d;">BEST: <span id="high-score-ui">0</span></div>
</div>

<div class="ui-panel bot-bar">
    <div id="p-bomb" class="pwr-btn" data-p="bomb">ðŸ’£</div>
    <div id="p-wipe" class="pwr-btn" data-p="wipe">ðŸ§¹</div>
    <div id="p-evo" class="pwr-btn" data-p="evo">ðŸª„</div>
    <div style="width:2px; height:40px; background:#ccc;"></div>
    <div class="pwr-btn" style="background:#95a5a6; width:45px" onclick="toggleModal('help-modal')">?</div>
    <div id="fs-btn" class="pwr-btn" style="background:#2c3e50; width:45px" onclick="toggleFull()">â›¶</div>
    <div class="pwr-btn" style="background:#3498db; width:65px" onclick="toggleModal('shop-modal')">SHOP</div>
</div>

<div id="shop-modal" class="modal">
    <div class="modal-header">
        <div><h2 style="margin:0">Market</h2><div id="shop-wallet" style="color:#2ecc71; font-weight:bold;">$0</div></div>
        <b onclick="toggleModal('shop-modal')" style="font-size:28px; cursor:pointer; padding: 10px;">âœ•</b>
    </div>
    <div class="modal-content" id="store-container"></div>
</div>

<div id="help-modal" class="modal">
    <div class="modal-header"><h2>How to Play</h2><b onclick="toggleModal('help-modal')" style="font-size:28px; cursor:pointer; padding: 10px;">âœ•</b></div>
    <div class="modal-content">
        <p><b>Multiplier System:</b> Merge fruit within 1.5s of each other to build a multiplier up to <b>5x</b>! The multiplier text changes based on your skin.</p><br>
        <p><b>Power-Ups:</b> Press and <b>drag</b> the icon from the bottom bar onto the game field to use them. Bomb clears area, Wipe deletes a tier, Evolve upgrades a tier.</p><br>
        <p><b>iOS Tip:</b> Safari iPhone doesn't support the Fullscreen button. Use <b>"Add to Home Screen"</b> for the best experience.</p>
    </div>
</div>

<canvas id="c"></canvas>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, Ev=M.Events;

const SKINS = { 
    Fruit: ["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"],
    Animals: ["ðŸž","ðŸ¸","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","ðŸ˜","ðŸ‹"],
    Music: ["ðŸª•","ðŸª—","ðŸŽ¸","ðŸŽ¹","ðŸŽº","ðŸŽ»","ðŸ¥","ðŸŽ·","ðŸŽ™ï¸","ðŸ“»","ðŸŽ§","ðŸŽµ"],
    Weather: ["â˜ï¸","ðŸŒ¦ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒªï¸","ðŸŒ«ï¸","ðŸŒˆ","â˜€ï¸"],
    Shapes: ["ðŸ”º","ðŸŸ¡","ðŸŸ©","ðŸ”·","â­","ðŸ›‘","ðŸ’Ž","ðŸŒ™","ðŸŒ€","ðŸ’ ","â¬›","âšª"],
    Nature: ["ðŸŒ±","ðŸŒ¿","â˜˜ï¸","ðŸ€","ðŸƒ","ðŸ‚","ðŸ","ðŸ„","ðŸŒµ","ðŸŒ´","ðŸŒ²","ðŸŒ³"],
    Dessert: ["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"],
    Space: ["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"]
};

const WORDS = {
    Fruit: ["JUICY", "SWEET", "RIPE", "FRESH", "ZESTY"],
    Animals: ["WILD", "FIERCE", "BEASTLY", "SAVAGE", "ALPHA"],
    Music: ["RHYTHMIC", "TUNEFUL", "GROOVY", "LOUD", "PITCHED"],
    Weather: ["STORMY", "BLAZING", "CHILLY", "BREEZY", "ELECTRIC"],
    Shapes: ["SHARP", "ANGULAR", "PERFECT", "SOLID", "SYMMETRIC"],
    Nature: ["EARTHY", "BLOOMING", "LUSH", "ROOTED", "ORGANIC"],
    Dessert: ["SUGARY", "CREAMY", "DELIGHTFUL", "TASTY", "GLAZED"],
    Space: ["COSMIC", "GALACTIC", "STELLAR", "INFINITE", "ASTRAL"]
};

const THEMES = { Mellow: "#FDF6E3", Matcha: "#E8F5E9", Midnight: "#1a1b26", Lavender: "#F3E5F5", Sky: "#E1F5FE", Rose: "#FFF1F0", Sunset: "#FFF5E6", Forest: "#1B5E20", DeepSea: "#01579B", Charcoal: "#212121", Sand: "#F4A460", Mint: "#F0FFF0", Plum: "#4B0082", Peach: "#FFDAB9", Slate: "#708090", Ghost: "#E8ECEF" };
const BORDERS = { Slate: "#657B83", Gold: "#DAA520", Neon: "#B026FF", Red: "#DC143C", Black: "#000000", Silver: "#C0C0C0", Bronze: "#CD7F32", Electric: "#00FFFF", Lime: "#32CD32", Pink: "#FF69B4", Wine: "#800000", Navy: "#000080", Olive: "#808000", Teal: "#008080", Orange: "#FF8C00", White: "#FFFFFF" };
const SIZES = [18, 24, 30, 38, 46, 55, 65, 76, 88, 102, 118, 135];

let st = { score: 0, best: 0, wallet: 0, eq: { sk: 'Fruit', th: 'Mellow', bd: 'Slate', ot: 'def' }, owned: ['sk_Fruit', 'th_Mellow', 'bd_Slate', 'ot_Default'], found: [0] };
let engine, canvas, ctx, W, H, DL=165, FY, floor, lastX, nextIdx=1, curIdx=0, canDrop=true, isDead=false;
let audioCtx, activeDrag=null, dragPos={x:0, y:0};
let combo=1, lastMergeTime=0;

function init() {
    load();
    canvas = document.getElementById('c'); ctx = canvas.getContext('2d');
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) document.getElementById('fs-btn').style.display = 'none';

    window.addEventListener('resize', resize);
    resize();
    
    document.getElementById('retry-btn').onclick = restartGame;
    engine = E.create({ gravity: { y: 1.2 } });
    
    Ev.on(engine, 'collisionStart', e => {
        e.pairs.forEach(p => {
            const a = p.bodyA, b = p.bodyB;
            if((a.label === 'floor' || b.label === 'floor') && a.plugin?.t !== undefined) playSound('thud'); 
            if(a.plugin?.t !== undefined && b.plugin?.t !== undefined && a.plugin.t === b.plugin.t && a.plugin.t < 11) {
                handleMerge(a, b);
            }
        });
    });

    setupDragListeners();
    loop();
    updUI();
}

function handleMerge(a, b) {
    const t = a.plugin.t;
    const pos = { x: (a.position.x+b.position.x)/2, y: (a.position.y+b.position.y)/2 };
    C.remove(engine.world, [a, b]);
    spawnFruit(pos.x, pos.y, t + 1, false);

    const now = Date.now();
    if(now - lastMergeTime < 1500) combo = Math.min(5, combo + 1);
    else combo = 1;
    lastMergeTime = now;

    const points = (t+1)*10 * combo;
    st.score += points; st.wallet += (t+1);
    if(st.score > st.best) st.best = st.score;
    if(!st.found.includes(t+1)) st.found.push(t+1);
    
    if(combo > 1) triggerMultiplierUI();
    playSound('pop'); updUI(); save();
}

function triggerMultiplierUI() {
    const tag = document.getElementById('multiplier-tag');
    const wordList = WORDS[st.eq.sk] || WORDS.Fruit;
    const word = wordList[Math.floor(Math.random()*wordList.length)];
    tag.innerText = `${word} X${combo}!`;
    tag.style.opacity = 1;
    setTimeout(() => tag.style.opacity = 0, 800);
}

function resize() {
    W = window.innerWidth; H = window.innerHeight;
    canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio;
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    FY = H - 100;
    updatePhysicsBounds();
}

function updatePhysicsBounds() {
    if(!engine) return;
    if(floor) C.remove(engine.world, [floor, wallL, wallR]);
    // Extra thick floor to prevent tunnelings on iOS
    floor = B.rectangle(W/2, FY + 400, W*2, 800, { isStatic: true, label: 'floor', friction: 0.5 });
    wallL = B.rectangle(-50, H/2, 130, H*4, { isStatic: true });
    wallR = B.rectangle(W+50, H/2, 130, H*4, { isStatic: true });
    C.add(engine.world, [floor, wallL, wallR]);
}

function spawnFruit(x, y, t, isDrop) {
    if(isDead) return;
    const b = B.circle(x, y, SIZES[t], { restitution: 0.3, friction: 0.1, slop: 0.05, plugin: { t: t } });
    C.add(engine.world, b);
    if(isDrop) {
        curIdx = nextIdx; nextIdx = Math.floor(Math.random()*5);
        canDrop = false; setTimeout(() => canDrop = true, 500);
        updUI();
    }
}

function loop() {
    E.update(engine, 16);
    ctx.clearRect(0, 0, W, H);
    document.body.style.background = THEMES[st.eq.th];
    
    ctx.fillStyle = BORDERS[st.eq.bd];
    ctx.fillRect(0, 0, 15, H); ctx.fillRect(W-15, 0, 15, H);
    
    ctx.setLineDash([8,8]); ctx.strokeStyle="rgba(255,0,0,0.5)"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(15, DL); ctx.lineTo(W-15, DL); ctx.stroke(); ctx.setLineDash([]);

    const now = Date.now();
    C.allBodies(engine.world).forEach(b => {
        if(b.isStatic || !b.plugin) return;
        if(b.position.y - b.circleRadius < DL && b.speed < 0.4) {
            if(!b.tm) b.tm = now;
            if(now - b.tm > 2000 && !isDead) triggerGameOver();
        } else b.tm = null;
        
        const r = b.circleRadius, t = b.plugin.t;
        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
        
        if(st.eq.ot === 'rainbow') ctx.strokeStyle = `hsl(${now/5%360},100%,50%)`;
        else if(st.eq.ot === 'white') ctx.strokeStyle = "#fff";
        else if(st.eq.ot === 'black') ctx.strokeStyle = "#000";
        else ctx.strokeStyle = "#0002";
        
        ctx.lineWidth = 4; ctx.stroke();
        ctx.font = `${r*1.3}px serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk][t], 0, r*0.05);
        ctx.restore();
    });

    if(canDrop && !activeDrag && !isDead) {
        ctx.strokeStyle="rgba(0,0,0,0.1)"; ctx.beginPath(); ctx.moveTo(lastX || W/2, DL); ctx.lineTo(lastX || W/2, FY); ctx.stroke();
        ctx.font="40px serif"; ctx.globalAlpha=0.4; ctx.textAlign="center";
        ctx.fillText(SKINS[st.eq.sk][curIdx], lastX || W/2, DL-20); ctx.globalAlpha=1;
    }

    if(activeDrag) {
        ctx.save();
        if(activeDrag === 'bomb') {
            ctx.beginPath(); ctx.arc(dragPos.x, dragPos.y, 80, 0, Math.PI*2);
            ctx.fillStyle = "rgba(230,126,34,0.2)"; ctx.fill();
            ctx.setLineDash([5,5]); ctx.strokeStyle="#e67e22"; ctx.stroke();
        } else {
            ctx.strokeStyle = activeDrag==='wipe'?"#9b59b6":"#f1c40f";
            ctx.beginPath(); ctx.moveTo(dragPos.x-30, dragPos.y); ctx.lineTo(dragPos.x+30, dragPos.y);
            ctx.moveTo(dragPos.x, dragPos.y-30); ctx.lineTo(dragPos.x, dragPos.y+30); ctx.stroke();
        }
        ctx.restore();
    }
    
    requestAnimationFrame(loop);
}

function setupDragListeners() {
    const start = (e, type) => {
        if(isDead || st.wallet < (type==='bomb'?500:type==='wipe'?1000:1500)) return;
        activeDrag = type;
        const p = e.touches ? e.touches[0] : e;
        dragPos = { x: p.clientX, y: p.clientY };
        e.target.classList.add('dragging');
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    };

    document.querySelectorAll('.pwr-btn[data-p]').forEach(btn => {
        btn.addEventListener('touchstart', (e) => start(e, btn.dataset.p), {passive:false});
        btn.addEventListener('mousedown', (e) => start(e, btn.dataset.p));
    });

    window.addEventListener('touchmove', e => {
        if(activeDrag) { e.preventDefault(); dragPos = { x: e.touches[0].clientX, y: e.touches[0].clientY }; }
        else if(!e.target.closest('.modal')) { e.preventDefault(); lastX = e.touches[0].clientX; }
    }, { passive: false });

    window.addEventListener('touchend', e => {
        if(activeDrag) finalizePower(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        else if(!e.target.closest('.modal') && !e.target.closest('.ui-panel') && canDrop && !isDead) {
            spawnFruit(lastX || W/2, DL, curIdx, true);
        }
    });

    window.addEventListener('mousemove', e => {
        if(activeDrag) dragPos = { x: e.clientX, y: e.clientY };
        else lastX = e.clientX;
    });

    window.addEventListener('mouseup', e => {
        if(activeDrag) finalizePower(e.clientX, e.clientY);
        else if(!e.target.closest('.modal') && !e.target.closest('.ui-panel') && canDrop && !isDead) {
            spawnFruit(lastX || W/2, DL, curIdx, true);
        }
    });
}

function finalizePower(x, y) {
    const type = activeDrag; activeDrag = null;
    document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('dragging'));
    const bodies = C.allBodies(engine.world).filter(b => b.plugin);
    let success = false;

    if(type === 'bomb') {
        bodies.forEach(b => { if(M.Vector.magnitude(M.Vector.sub(b.position, {x,y})) < 80) C.remove(engine.world, b); });
        success = true;
    } else {
        const target = bodies.find(b => M.Bounds.contains(b.bounds, {x,y}));
        if(target) {
            const t = target.plugin.t;
            if(type === 'wipe') bodies.forEach(b => { if(b.plugin.t === t) C.remove(engine.world, b); });
            if(type === 'evo' && t < 11) bodies.forEach(b => { 
                if(b.plugin.t === t) { const p = b.position; C.remove(engine.world, b); spawnFruit(p.x, p.y, t+1, false); }
            });
            success = true;
        }
    }
    if(success) { st.wallet -= (type==='bomb'?500:type==='wipe'?1000:1500); playSound('pop'); updUI(); save(); }
}

function renderStore() {
function renderStore() {
    const cont = document.getElementById('store-container'); cont.innerHTML = '';
    document.getElementById('shop-wallet').innerText = '$' + st.wallet;
    
    const cats = [
        {t: 'Skins', k: 'sk', d: SKINS, c: 1500},
        {t: 'Backgrounds', k: 'th', d: THEMES, c: 500},
        {t: 'Borders', k: 'bd', d: BORDERS, c: 500},
        {t: 'Outlines', k: 'ot', d: {Default:'def', Rainbow:'rainbow', White:'white', Black:'black'}, c: 1000}
    ];

    cats.forEach(cat => {
        cont.innerHTML += `<h3 style="margin:15px 0 10px">${cat.t}</h3><div class="grid" id="grid-${cat.k}"></div>`;
        const grid = document.getElementById(`grid-${cat.k}`);
        Object.keys(cat.d).forEach(item => {
            const id = `${cat.k}_${item}`;
            const isOwned = st.owned.includes(id);
            const val = cat.d[item];
            const isEq = st.eq[cat.k] === val;

            const card = document.createElement('div');
            card.className = `card ${isEq ? 'equipped' : ''}`;
            
            let pre = '';
            if(cat.k === 'sk') pre = `<div class="preview-swatch">${cat.d[item][0]}</div>`;
            else if(cat.k === 'th') pre = `<div class="preview-swatch" style="background:${cat.d[item]}"></div>`;
            else if(cat.k === 'bd') pre = `<div class="preview-swatch" style="border:4px solid ${cat.d[item]}"></div>`;
            else pre = `<div class="preview-swatch ${item==='Rainbow'?'rainbow-active':''}" style="background:${val==='white'?'#fff':val==='black'?'#000':'transparent'}"></div>`;

            card.innerHTML = `${pre}<b>${item}</b><div style="font-size:10px; color:${isOwned?'#2ecc71':'#e67e22'}">${isEq?'EQUIPPED':isOwned?'OWNED':'$'+cat.c}</div>`;
            card.onclick = () => {
                if(isOwned) { st.eq[cat.k] = val; }
                else if(st.wallet >= cat.c) { st.wallet -= cat.c; st.owned.push(id); st.eq[cat.k] = val; }
                else { showToast("NEED FUNDS!"); return; }
                save(); renderStore(); updUI();
            };
            grid.appendChild(card);
        });
    });
}

function playSound(type) {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    if(type === 'pop') { o.frequency.setValueAtTime(600, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); }
    else { o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.setValueAtTime(0.05, audioCtx.currentTime); }
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.1);
}

function toggleFull() {
    const el = document.documentElement;
    if (!(document.fullscreenElement || document.webkitFullscreenElement)) (el.requestFullscreen || el.webkitRequestFullscreen).call(el);
    else (document.exitFullscreen || document.webkitExitFullscreen).call(document);
}

function triggerGameOver() { isDead = true; document.getElementById('final-score').innerText = st.score; document.getElementById('game-over').style.display = 'flex'; }
function restartGame() { isDead = false; st.score = 0; st.found = [0]; document.getElementById('game-over').style.display = 'none'; C.clear(engine.world, false); updatePhysicsBounds(); updUI(); }
function updUI() {
    document.getElementById('cur-score').innerText = st.score;
    document.getElementById('wallet-ui').innerText = st.wallet;
    document.getElementById('high-score-ui').innerText = st.best;
    document.getElementById('next-preview').innerText = SKINS[st.eq.sk][nextIdx];
    const pb = document.getElementById('prog-bar'); pb.innerHTML = '';
    for(let i=0; i<12; i++) pb.innerHTML += `<div style="opacity:${st.found.includes(i)?1:0.1}; font-size:14px">${SKINS[st.eq.sk][i]}</div>`;
    document.querySelectorAll('.pwr-btn[data-p]').forEach(b => {
        const cost = b.dataset.p==='bomb'?500:b.dataset.p==='wipe'?1000:1500;
        b.classList.toggle('locked', st.wallet < cost);
    });
}
function save() { localStorage.setItem('fm_v134', JSON.stringify(st)); }
function load() { const d = localStorage.getItem('fm_v134'); if(d) Object.assign(st, JSON.parse(d)); }
function toggleModal(id) { 
    const m = document.getElementById(id); 
    const isOpen = m.classList.contains('open'); 
    document.querySelectorAll('.modal').forEach(mod => mod.classList.remove('open')); 
    if(!isOpen) { m.classList.add('open'); if(id === 'shop-modal') renderStore(); } 
}
function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }

window.onload = init;
</script>
</body>
</html>
