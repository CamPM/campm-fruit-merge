<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fruit Merge v95</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg: #fdfbf7; --border-color: #e8e6e1; --text: #5c554a;
            --outline: none; --border-width: 12px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* UI Framework */
        #top-ui { height: 175px; position: absolute; top: 0; width: 100%; border-bottom: var(--border-width) solid var(--border-color); z-index: 100; background: inherit; padding: 15px; }
        #bottom-ui { height: 100px; position: absolute; bottom: 0; width: 100%; border-top: var(--border-width) solid var(--border-color); display: flex; justify-content: space-around; align-items: center; z-index: 100; background: inherit; }
        #game-container { position: absolute; top: 175px; bottom: 100px; width: 100%; overflow: hidden; background: #fff; }

        /* Progress Bar */
        #progress-container { width: 100%; margin-top: 15px; position: relative; height: 30px; }
        #progress-icons { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
        .p-icon { font-size: 1.1rem; opacity: 0.15; filter: grayscale(1); transition: 0.4s; }
        .p-icon.unlocked { opacity: 1; filter: grayscale(0); transform: scale(1.1); }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 2000; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; touch-action: pan-y; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { border: 1px solid #eee; border-radius: 12px; padding: 12px; text-align: center; }
        .card.owned { border-color: #88d498; background: #f0faf2; }

        /* Game Elements */
        .btn { padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: #fff; font-weight: 600; cursor: pointer; }
        .danger-line { position: absolute; top: 195px; width: 100%; border-top: 2px dashed #ff7675; pointer-events: none; z-index: 10; opacity: 0.6; }
        #drag-icon { position: absolute; font-size: 2.5rem; pointer-events: none; transform: translate(-50%, -50%); z-index: 500; display: none; }
        #drop-preview { position: absolute; top: 10px; font-size: 2rem; pointer-events: none; opacity: 0.5; transform: translateX(-50%); }
    </style>
</head>
<body>

<div id="top-ui">
    <div style="display:flex; justify-content: space-between; align-items: flex-start;">
        <div><b>Score:</b> <span id="score">0</span><br><small>Best: <span id="best">0</span></small></div>
        <div style="text-align: center;">Next<br><span id="next-preview" style="font-size: 1.5rem;"></span></div>
        <div style="display:flex; gap: 5px;">
            <button class="btn" onclick="toggleFS()">‚õ∂</button>
            <button class="btn" onclick="openModal('help')">?</button>
        </div>
    </div>
    <div id="progress-container"><div id="progress-icons"></div></div>
    <div style="text-align:center; font-weight:bold; margin-top:5px;">Wallet: $<span id="wallet">0</span></div>
</div>

<div class="danger-line"></div>
<div id="game-container">
    <div id="drop-preview"></div>
    <div id="drag-icon"></div>
</div>

<div id="bottom-ui">
    <button class="btn power-btn" data-type="bomb">üí£</button>
    <button class="btn power-btn" data-type="broom">üßπ</button>
    <button class="btn power-btn" data-type="wand">ü™Ñ</button>
    <button class="btn" onclick="openModal('store')">üè™ Store</button>
</div>

<div id="help-modal" class="modal">
    <div class="modal-header"><h2>How to Play</h2><button class="btn" onclick="closeModals()">‚úï</button></div>
    <div class="modal-content">
        <p><b>Objective:</b> Merge items to reach Tier 12. Don't let them stack above the red line for 2 seconds!</p>
        <h3>Power-ups (Drag to use)</h3>
        <ul>
            <li><b>Bomb:</b> Destroys items in a radius.</li>
            <li><b>Broom:</b> Clears all items of a single type.</li>
            <li><b>Wand:</b> Upgrades an item to the next tier.</li>
        </ul>
        <p>Wallet and High Score persist between games.</p>
    </div>
</div>

<div id="store-modal" class="modal">
    <div class="modal-header"><h2>Store (44 Items)</h2><button class="btn" onclick="closeModals()">‚úï</button></div>
    <div class="modal-content" id="store-list"></div>
</div>

<script>
/** * CONFIGURATION & DATA (44 Items)
 */
const DATA = {
    skins: {
        Fruit: ['üçí','üçì','üçá','üçä','üçé','üçê','üçë',' Pineapple ','üçà','üçâ','ü••','üéÉ'],
        Plants: ['üå±','üåµ','ü™¥','üå≤','üå≥','üå¥','üéã','üåø','üçÄ','üçÑ','üåª','üåπ'],
        Weather: ['‚òÅÔ∏è','üå§Ô∏è','‚ö°','‚òÄÔ∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','‚õàÔ∏è','‚ùÑÔ∏è','üå¨Ô∏è','üåà','üå™Ô∏è'],
        Animals: ['üê≠','üê∞','ü¶ä','üêª','üêº','ü¶Å','üêØ','üê∑','üê∏','üêô','üê≥','ü¶Ñ'],
        Shapes: ['‚ñ≤','‚ñ†','‚¨ì','‚¨¢','‚¨¶','‚¨ó','‚òÖ','‚óÜ','‚úö','‚¨ô','‚¨£','‚¨§'],
        Music: ['üéµ','üé∂','üé∑','üé∏','üéπ','üéª','ü•Å','üìª','üé§','üéß','ü™ï','üìª'],
        Space: ['‚òÑÔ∏è','üõ∞Ô∏è','ü™ê','üåô','‚òÄÔ∏è','üî≠','üöÄ','üëΩ','üõ∏','üåå','üå†','üë©‚ÄçüöÄ'],
        Dessert: ['üç™','üç©','üßÅ','üç¶','üç∞','ü•ß','üç´','üç¨','üç≠','üçÆ','üçØ','üéÇ']
    },
    themes: ["Mellow", "Midnight", "Forest", "Ocean", "Rose", "Matcha", "Slate", "Sand", "Lilac", "Olive", "Peach", "Storm", "Zest", "Mint", "Coal", "Cloud"],
    borders: ["Steel", "Gold", "Neon", "Crimson", "Mint", "Lavender", "Coal", "Ivory", "Emerald", "Sky", "Amber", "Plum", "Clay", "Silver", "Coffee", "Coral"],
    outlines: ["None", "White", "Black", "Neon"]
};

let state = {
    score: 0, wallet: parseInt(localStorage.getItem('wallet')) || 500,
    highScore: parseInt(localStorage.getItem('highScore')) || 0,
    skin: 'Fruit', owned: ['Fruit', 'Mellow', 'Steel', 'None'],
    unlocked: new Set([0]), next: 0,
    activePower: null, gameOverTime: null
};

/** * SOUND ENGINE
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type = 'sine', decay = 0.5) {
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + decay);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + decay);
}

/** * PHYSICS ENGINE
 */
const { Engine, Render, Runner, Bodies, Composite, Events, Vector, Query } = Matter;
const container = document.getElementById('game-container');
const engine = Engine.create({ gravity: { y: 1.5 } });
const render = Render.create({
    element: container, engine: engine,
    options: { width: window.innerWidth, height: container.clientHeight, wireframes: false, background: 'transparent' }
});

const ground = Bodies.rectangle(window.innerWidth/2, container.clientHeight + 10, window.innerWidth, 25, { isStatic: true });
const leftW = Bodies.rectangle(-10, container.clientHeight/2, 20, container.clientHeight, { isStatic: true });
const rightW = Bodies.rectangle(window.innerWidth + 10, container.clientHeight/2, 20, container.clientHeight, { isStatic: true });
Composite.add(engine.world, [ground, leftW, rightW]);

function spawn(x, y, tier) {
    const r = 15 + (tier * 7.5);
    const b = Bodies.circle(x, y, r, { restitution: 0.3, plugin: { tier } });
    Composite.add(engine.world, b);
    return b;
}

/** * INTERACTION & POWER-UPS
 */
const dragIcon = document.getElementById('drag-icon');
const preview = document.getElementById('drop-preview');

// Handle Power-up Buttons (Start Drag)
document.querySelectorAll('.power-btn').forEach(btn => {
    btn.addEventListener('touchstart', (e) => {
        state.activePower = btn.dataset.type;
        dragIcon.innerText = btn.innerText;
        dragIcon.style.display = 'block';
    });
});

window.addEventListener('touchmove', (e) => {
    const touch = e.touches[0];
    const rect = container.getBoundingClientRect();
    const x = touch.clientX;
    const y = touch.clientY;

    if (state.activePower) {
        dragIcon.style.left = x + 'px';
        dragIcon.style.top = y + 'px';
    } else if (y > 175 && y < window.innerHeight - 100) {
        preview.style.left = x + 'px';
        preview.innerText = DATA.skins[state.skin][state.next];
    }
});

window.addEventListener('touchend', (e) => {
    const touch = e.changedTouches[0];
    const rect = container.getBoundingClientRect();
    const x = touch.clientX;
    const y = touch.clientY - rect.top;

    if (state.activePower) {
        const body = Query.point(Composite.allBodies(engine.world), { x, y: touch.clientY - rect.top })[0];
        usePower(state.activePower, body, x, y);
        state.activePower = null;
        dragIcon.style.display = 'none';
    } else if (touch.clientY > 175 && touch.clientY < window.innerHeight - 100) {
        spawn(x, 40, state.next);
        state.next = Math.floor(Math.random() * 4);
        playSound(200);
        updateUI();
    }
});

function usePower(type, target, x, y) {
    if (type === 'bomb') {
        const bodies = Composite.allBodies(engine.world).filter(b => Vector.magnitude(Vector.sub(b.position, {x, y})) < 80);
        Composite.remove(engine.world, bodies);
        playSound(100, 'square');
    } else if (target && target.plugin.tier !== undefined) {
        if (type === 'broom') {
            const same = Composite.allBodies(engine.world).filter(b => b.plugin.tier === target.plugin.tier);
            Composite.remove(engine.world, same);
            playSound(150, 'triangle');
        } else if (type === 'wand' && target.plugin.tier < 11) {
            const next = target.plugin.tier + 1;
            const pos = { ...target.position };
            Composite.remove(engine.world, target);
            spawn(pos.x, pos.y, next);
            playSound(440);
        }
    }
}

/** * CORE LOOPS
 */
Events.on(engine, 'collisionStart', (e) => {
    e.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        if (bodyA.plugin?.tier === bodyB.plugin?.tier && bodyA.plugin.tier < 11) {
            const pos = Vector.div(Vector.add(bodyA.position, bodyB.position), 2);
            const tier = bodyA.plugin.tier + 1;
            Composite.remove(engine.world, [bodyA, bodyB]);
            spawn(pos.x, pos.y, tier);
            state.score += tier * 10;
            state.wallet += tier;
            state.unlocked.add(tier);
            playSound(300 + (tier * 30));
            updateUI();
        }
    });
});

Events.on(render, 'afterRender', () => {
    const ctx = render.context;
    let violation = false;

    Composite.allBodies(engine.world).forEach(body => {
        if (body.plugin.tier !== undefined) {
            const tier = body.plugin.tier;
            const emoji = DATA.skins[state.skin][tier];
            const r = 15 + (tier * 7.5);

            ctx.save();
            ctx.translate(body.position.x, body.position.y);
            ctx.rotate(body.angle);
            
            // Outlines
            if (state.owned.includes("White")) { ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.strokeText(emoji, 0, 0); }
            if (state.owned.includes("Black")) { ctx.strokeStyle = "black"; ctx.lineWidth = 4; ctx.strokeText(emoji, 0, 0); }

            ctx.font = `${r * 1.8}px Arial`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(emoji, 0, 0);
            ctx.restore();

            if (body.position.y < 20) violation = true;
        }
    });

    if (violation) {
        if (!state.gameOverTime) state.gameOverTime = Date.now();
        else if (Date.now() - state.gameOverTime > 2000) {
            Composite.clear(engine.world, true);
            state.score = 0; state.gameOverTime = null;
            updateUI();
        }
    } else state.gameOverTime = null;
});

/** * STORE & UI
 */
function updateUI() {
    document.getElementById('score').innerText = state.score;
    document.getElementById('wallet').innerText = state.wallet;
    document.getElementById('best').innerText = state.highScore;
    document.getElementById('next-preview').innerText = DATA.skins[state.skin][state.next];
    
    const p = document.getElementById('progress-icons');
    p.innerHTML = '';
    DATA.skins[state.skin].forEach((s, i) => {
        const div = document.createElement('div');
        div.className = `p-icon ${state.unlocked.has(i) ? 'unlocked' : ''}`;
        div.innerText = (s === ' Pineapple ') ? 'üçç' : s; // Fix pineapple bug
        p.appendChild(div);
    });
    localStorage.setItem('wallet', state.wallet);
    if(state.score > state.highScore) {
        state.highScore = state.score;
        localStorage.setItem('highScore', state.highScore);
    }
}

function openModal(id) {
    if (id === 'store') renderStore();
    document.getElementById(id + '-modal').style.display = 'flex';
}

function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

function renderStore() {
    const container = document.getElementById('store-list');
    container.innerHTML = '';
    
    const sections = [
        { name: 'Skins', data: Object.keys(DATA.skins), price: 500 },
        { name: 'Themes', data: DATA.themes, price: 300 },
        { name: 'Borders', data: DATA.borders, price: 200 },
        { name: 'Outlines', data: DATA.outlines, price: 2000 }
    ];

    sections.forEach(sec => {
        container.innerHTML += `<h3>${sec.name}</h3>`;
        const grid = document.createElement('div');
        grid.className = 'grid';
        sec.data.sort().forEach(item => {
            const owned = state.owned.includes(item);
            const card = document.createElement('div');
            card.className = `card ${owned ? 'owned' : ''}`;
            card.innerHTML = `<div>${item}</div><div>${owned ? 'Owned' : '$'+sec.price}</div>`;
            card.onclick = () => {
                if (!owned && state.wallet >= sec.price) {
                    state.wallet -= sec.price;
                    state.owned.push(item);
                    updateUI(); renderStore();
                } else if (owned) {
                    if (sec.name === 'Skins') state.skin = item;
                    if (sec.name === 'Themes') document.documentElement.style.setProperty('--bg', '#f0f0f0');
                    updateUI();
                }
            };
            grid.appendChild(card);
        });
        container.appendChild(grid);
    });
}

function toggleFS() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
}

// Start
updateUI();
Render.run(render);
Runner.run(Runner.create(), engine);
</script>
</body>
</html>
