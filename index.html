<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Fruit Merge v1.40</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --p: rgba(255,255,255,0.95); --acc: #2ecc71; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin:0; padding:0; }
        body { overflow: hidden; font-family: 'Arial Black', sans-serif; height: 100vh; width: 100vw; position: fixed; touch-action: none; background: #111; }
        canvas { display: block; }
        .ui { position: absolute; z-index: 1000; pointer-events: none; width: 100%; }
        .top-bar { top: 0; background: var(--p); border-bottom: 3px solid #333; pointer-events: auto; padding: 10px 20px; padding-top: env(safe-area-inset-top); display: flex; justify-content: space-between; align-items: center; }
        .wallet-bar { position: absolute; top: 110px; left: 50%; transform: translateX(-50%); background: #333; color: var(--acc); padding: 5px 15px; border-radius: 20px; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .bot-bar { bottom: 0; height: 90px; background: var(--p); border-top: 3px solid #333; pointer-events: auto; display: flex; align-items: center; justify-content: space-evenly; padding-bottom: env(safe-area-inset-bottom); }
        .pwr { width: 45px; height: 45px; border-radius: 12px; border: 2px solid #333; font-size: 20px; cursor: pointer; background: #fff; display: flex; align-items: center; justify-content: center; position: relative; }
        .pwr.locked { filter: grayscale(1); opacity: 0.4; }
        .pwr::after { content: attr(data-c); position: absolute; top: -10px; font-size: 9px; background: #333; color: #fff; border-radius: 5px; padding: 1px 4px; }
        .modal { display: none; position: absolute; inset: 15px; background: #fff; z-index: 5000; border: 4px solid #333; border-radius: 20px; flex-direction: column; overflow: hidden; pointer-events: auto; }
        .modal.open { display: flex; }
        .modal-body { flex:1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; }
        .card { border: 2px solid #eee; border-radius: 12px; padding: 8px; text-align: center; animation: float 3s infinite; }
        .card.eq { border-color: var(--acc); background: #f0fff0; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        .swatch { width: 40px; height: 40px; margin: 0 auto 5px; border: 2px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #fff; animation: float 2s infinite; }
        .pop-txt { position: absolute; pointer-events: none; font-size: 24px; color: #ff4757; text-shadow: 2px 2px #fff; z-index: 1500; font-family: Impact; }
    </style>
</head>
<body>
<div id="game-over" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:9000; color:#fff; flex-direction:column; align-items:center; justify-content:center;">
    <h1 style="color:var(--acc)">GAME OVER</h1>
    <div style="margin:20px 0; text-align:center">SCORE: <span id="f-s"></span><br>BEST: <span id="f-b"></span></div>
    <button onclick="restart()" style="padding:15px 40px; background:var(--acc); border:none; color:#fff; border-radius:10px;">RETRY</button>
</div>

<div class="ui top-bar">
    <div>SCORE<div id="cur-s">0</div></div>
    <div id="next" style="width:50px; height:50px; border:3px solid #333; border-radius:50%; display:grid; place-items:center; font-size:28px; background:#fff;"></div>
    <div style="text-align:right">BEST<div id="best-s">0</div></div>
</div>
<div class="ui wallet-bar">CASH: $<span id="wall">0</span></div>

<div class="ui bot-bar">
    <div id="pb" class="pwr" data-t="bomb" data-c="$50" style="background:#e67e22">ðŸ’£</div>
    <div id="pw" class="pwr" data-t="wipe" data-c="$75" style="background:#9b59b6">ðŸ§¹</div>
    <div id="pe" class="pwr" data-t="evo" data-c="$150" style="background:#f1c40f">ðŸª„</div>
    <div class="pwr" onclick="toggleM('h-m')">?</div>
    <div class="pwr" style="width:70px" onclick="toggleM('s-m')">SHOP</div>
</div>

<div id="s-m" class="modal">
    <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between"><b>SHOP</b><b onclick="toggleM('s-m')">âœ•</b></div>
    <div class="modal-body" id="s-b"></div>
</div>
<div id="h-m" class="modal">
    <div style="padding:10px; border-bottom:1px solid #eee"><b>HELP</b><b onclick="toggleM('h-m')" style="float:right">âœ•</b></div>
    <div style="padding:15px; line-height:1.4">
        Merge matching items! Power-ups: Drag to use. Vibe-Logic: Physics change with skins.<br><br>
        <small style="opacity:0.4">v1.40 Obsidian Edition</small>
    </div>
</div>

<canvas id="c"></canvas>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite;
const SKINS = { 
    Space: {e:["ðŸŒ‘","â˜„ï¸","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ‘¾","ðŸ”­","ðŸŒŒ","ðŸª","â˜€ï¸","ðŸŒ€","ðŸ‘½"], p:[0.2, 0.1], w:["SUPERNOVA!","GALACTIC!","ORBIT!","VACUUM!","VOID!"]},
    Nature: {e:["ðŸŒ±","ðŸŒ¿","â˜˜ï¸","ðŸ€","ðŸƒ","ðŸ‚","ðŸ","ðŸ„","ðŸŒµ","ðŸŒ´","ðŸŒ²","ðŸŒ³"], p:[0.3, 0.1], w:["EARTHY!","ROOTED!","BLOOM!","WILD!","FLORAL!"]},
    Shapes: {e:["ðŸ”º","ðŸŸ¡","ðŸŸ©","ðŸ”·","â­","ðŸ›‘","ðŸ’Ž","ðŸŒ™","ðŸŒ€","ðŸ’ ","â¬›","âšª"], p:[0.4, 0.05], w:["PERFECT!","SHARP!","GEOMETRIC!","VORTEX!","ANGLE!"]},
    Fruit: {e:["ðŸ’","ðŸ“","ðŸ‡","ðŸŠ","ðŸŽ","ðŸ","ðŸ‘","ðŸ","ðŸˆ","ðŸ‰","ðŸ¥¥","ðŸ¥"], p:[0.5, 0.05], w:["JUICY!","FRESH!","SWEET!","ZESTY!","RIPE!"]},
    Music: {e:["ðŸª•","ðŸª—","ðŸŽ¸","ðŸŽ¹","ðŸŽº","ðŸŽ»","ðŸ¥","ðŸŽ·","ðŸŽ™ï¸","ðŸ“»","ðŸŽ§","ðŸŽµ"], p:[0.5, 0.02], w:["GROOVY!","BEAT!","RHYTHM!","CHORD!","SOLO!"]},
    Weather: {e:["â˜ï¸","ðŸŒ¦ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â„ï¸","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒªï¸","ðŸŒ«ï¸","ðŸŒˆ","â˜€ï¸"], p:[0.6, 0.05], w:["ELECTRIC!","THUNDER!","STORM!","BOLT!","GALE!"]},
    Animals: {e:["ðŸž","ðŸ¸","ðŸ¢","ðŸ¦†","ðŸ’","ðŸ¦‰","ðŸ§","ðŸº","ðŸ¦“","ðŸ¦","elephant","Whale"], p:[0.8, 0.02], w:["WILD!","BEAST!","ROAR!","FEROCAL!","PRIMAL!"]},
    Dessert: {e:["ðŸ¬","ðŸª","ðŸ©","ðŸ«","ðŸ®","ðŸ¦","ðŸ§","ðŸ°","ðŸ¥§","ðŸ¥ž","ðŸ§‡","ðŸŽ‚"], p:[0.8, 0.01], w:["SUGAR!","SWEET!","CREAMY!","TASTY!","GLAZED!"]}
};
const THEMES={Mellow:"#FDF6E3",Midnight:"#1a1b26",Forest:"#1B5E20",Slate:"#2c3e50"};
const BORDERS={Slate:"#657B83",Gold:"#DAA520",Neon:"#B026FF",Black:"#000"};
const OUTLINES={Default:"def",Rainbow:"rbw",White:"white",Black:"black"};
const SIZES=[18,24,30,38,46,55,65,76,88,102,118,135];

let st={s:0, b:0, w:100, isP:false, eq:{sk:'Fruit', th:'Mellow', bd:'Slate', ot:'def'}, owned:['sk_Fruit','th_Mellow','bd_Slate','ot_Default']};
let engine, canvas, ctx, W, H, nextI=1, curI=0, canD=true, lastX=150, dead=false, drag=null, dPos={x:0,y:0}, sc=0;

function init() {
    load(); canvas=document.getElementById('c'); ctx=canvas.getContext('2d');
    engine=E.create({gravity:{y:1.2}}); resize();
    M.Events.on(engine, 'collisionStart', e => {
        e.pairs.forEach(p => {
            const a=p.bodyA, b=p.bodyB;
            if(a.plugin?.t!==undefined && a.plugin.t===b.plugin.t && a.plugin.t<11) {
                const t=a.plugin.t, x=(a.position.x+b.position.x)/2, y=(a.position.y+b.position.y)/2;
                C.remove(engine.world, [a,b]); const nf=spawn(x,y,t+1,false);
                nf.render.sprite={xS:1.5, yS:1.5}; spawnPop(x,y);
                st.s+=(t+1)*10; st.w+=(t+1)*10; upd(); save();
            }
        });
    });
    setupIn(); loop();
}

function resize() {
    W=window.innerWidth; H=window.innerHeight; canvas.width=W*devicePixelRatio; canvas.height=H*devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    C.clear(engine.world, false);
    C.add(engine.world, [
        B.rectangle(W/2, H+400, W, 1000, {isStatic:true}),
        B.rectangle(-10, H/2, 20, H, {isStatic:true}),
        B.rectangle(W+10, H/2, 20, H, {isStatic:true})
    ]);
}

function spawn(x,y,t,isD) {
    const v=SKINS[st.eq.sk].p;
    const b=B.circle(x,y,SIZES[t],{restitution:v[0], friction:v[1], plugin:{t:t}}); C.add(engine.world, b);
    if(isD){ curI=nextI; nextI=Math.floor(Math.random()*5); canD=false; setTimeout(()=>canD=true, 500); upd(); }
    return b;
}

function setupIn() {
    const gX=e=>(e.touches?e.touches[0].clientX:e.clientX);
    const gY=e=>(e.touches?e.touches[0].clientY:e.clientY);
    window.addEventListener('touchstart', e=>{ if(e.target.dataset.t && !st.isP){ drag=e.target.dataset.t; dPos={x:gX(e),y:gY(e)}; } }, {passive:false});
    window.addEventListener('touchmove', e=>{ if(st.isP) return; if(drag) dPos={x:gX(e),y:gY(e)}; else lastX=Math.max(30, Math.min(W-30, gX(e))); e.preventDefault(); }, {passive:false});
    window.addEventListener('touchend', e=>{ if(st.isP) return; if(drag) release(dPos.x, dPos.y); else if(canD && !dead && !e.target.closest('.ui')) spawn(lastX, 165, curI, true); });
}

function release(x,y) {
    const type=drag; drag=null; const cost=type==='bomb'?50:type==='wipe'?75:150;
    if(st.w<cost) return;
    const bodies=C.allBodies(engine.world).filter(b=>b.plugin); let ok=false;
    if(type==='bomb'){ bodies.forEach(b=>{ if(M.Vector.magnitude(M.Vector.sub(b.position,{x,y}))<80) C.remove(engine.world, b); }); ok=true; }
    else { const target=bodies.find(b=>M.Bounds.contains(b.bounds,{x,y})); if(target){
        const t=target.plugin.t;
        if(type==='wipe') bodies.forEach(b=>{ if(b.plugin.t===t) C.remove(engine.world, b); });
        if(type==='evo' && t<11) bodies.forEach(b=>{ if(b.plugin.t===t){ const p=b.position; C.remove(engine.world, b); spawn(p.x, p.y, t+1, false); } });
        ok=true;
    }}
    if(ok){ st.w-=cost; upd(); save(); }
}

function loop() {
    if(!st.isP) E.update(engine, 16);
    ctx.clearRect(0,0,W,H); document.body.style.background=THEMES[st.eq.th];
    ctx.fillStyle=BORDERS[st.eq.bd]; ctx.fillRect(0,0,10,H); ctx.fillRect(W-10,0,10,H);
    ctx.setLineDash([5,5]); ctx.strokeStyle="red"; ctx.beginPath(); ctx.moveTo(0,165); ctx.lineTo(W,165); ctx.stroke(); ctx.setLineDash([]);
    const now=Date.now();
    C.allBodies(engine.world).forEach(b => {
        if(!b.plugin) return;
        if(b.position.y-b.circleRadius<165 && b.speed<0.2){ if(!b.tm) b.tm=now; if(now-b.tm>2000) dead=true; } else b.tm=null;
        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
        if(b.render.sprite?.xS > 1) b.render.sprite.xS -= 0.05;
        const s = b.render.sprite?.xS || 1; ctx.scale(s,s);
        ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(0,0,b.circleRadius,0,Math.PI*2); ctx.fill();
        ctx.lineWidth=4; ctx.strokeStyle=(st.eq.ot==='rbw')?`hsl(${now/10%360},80%,50%)`:st.eq.ot==='white'?'#fff':st.eq.ot==='black'?'#000':'#0001';
        if(drag) {
            const dist = M.Vector.magnitude(M.Vector.sub(b.position, dPos));
            if((drag==='bomb' && dist<80) || (drag!=='bomb' && M.Bounds.contains(b.bounds, dPos))) { ctx.strokeStyle=var(--acc); ctx.lineWidth=8; }
        }
        ctx.stroke(); ctx.font=`${b.circleRadius*1.1}px serif`; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(SKINS[st.eq.sk].e[b.plugin.t], 0, 0); ctx.restore();
    });
    if(canD && !drag && !dead && !st.isP){ ctx.globalAlpha=0.4; ctx.font="40px serif"; ctx.textAlign="center"; ctx.fillText(SKINS[st.eq.sk].e[curI], lastX, 145); ctx.globalAlpha=1; }
    if(dead){ document.getElementById('game-over').style.display='flex'; document.getElementById('f-s').textContent=st.s; document.getElementById('f-b').textContent=st.b; }
    requestAnimationFrame(loop);
}

function renderS() {
    const b=document.getElementById('s-b'); b.innerHTML='';
    const cats=[{n:'Skins',k:'sk',d:SKINS,c:1500},{n:'Outlines',k:'ot',d:OUTLINES,c:1000},{n:'Themes',k:'th',d:THEMES,c:500},{n:'Borders',k:'bd',d:BORDERS,c:500}];
    cats.forEach(c=>{
        Object.keys(c.d).forEach(k=>{
            const id=c.k+'_'+k, own=st.owned.includes(id), eq=st.eq[c.k]===(c.k==='ot'?c.d[k]:k);
            const div=document.createElement('div'); div.className=`card ${eq?'eq':''}`;
            const pre=c.k==='sk'?c.d[k].e[0]:(k==='Rainbow'?'ðŸŒˆ':'');
            div.innerHTML=`<div class="swatch" style="background:${c.k==='th'?c.d[k]:'#fff'}; border-color:${c.k==='bd'?c.d[k]:'#333'}">${pre}</div><small>${k}</small><br><small>$${own?'Owned':c.c}</small>`;
            div.onclick=()=>{ if(own){st.eq[c.k]=(c.k==='ot'?c.d[k]:k);} else if(st.w>=c.c){st.w-=c.c; st.owned.push(id); st.eq[c.k]=(c.k==='ot'?c.d[k]:k);} upd(); renderS(); save(); };
            b.appendChild(div);
        });
    });
}

function spawnPop(x,y) {
    const d=document.createElement('div'); d.className='pop-txt';
    const w=SKINS[st.eq.sk].w; d.textContent=w[Math.floor(Math.random()*w.length)];
    d.style.left=x+'px'; d.style.top=y+'px'; document.body.appendChild(d);
    setTimeout(()=>d.remove(), 800);
}

function upd() {
    document.getElementById('cur-s').textContent=st.s; document.getElementById('best-s').textContent=st.b;
    document.getElementById('wall').textContent=st.w; document.getElementById('next').textContent=SKINS[st.eq.sk].e[nextI];
}
function toggleM(id){ const m=document.getElementById(id); m.classList.toggle('open'); st.isP=m.classList.contains('open'); if(id==='s-m') renderS(); }
function restart(){ st.s=0; dead=false; document.getElementById('game-over').style.display='none'; C.clear(engine.world, false); resize(); upd(); }
function save(){ localStorage.setItem('fm_v140', JSON.stringify(st)); }
function load(){ const d=localStorage.getItem('fm_v140'); if(d) Object.assign(st, JSON.parse(d)); if(st.s>st.b) st.b=st.s; }
window.onload=init;
</script>
</body>
</html>
