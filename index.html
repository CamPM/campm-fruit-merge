<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Merge v50 - Cameron's Build</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <style>
        :root { --primary: #3498db; --bg: #E6E6FA; }
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, sans-serif; touch-action: none; -webkit-user-select: none; user-select: none; }
        
        #game-container { position: relative; width: 100vw; height: 100vh; background: var(--bg); transition: background 0.3s; }
        
        /* Header Stats */
        #header { position: absolute; top: 0; left: 0; width: 100%; height: 100px; background: rgba(255,255,255,0.9); border-bottom: 3px solid #333; z-index: 1000; display: flex; flex-direction: column; padding: 5px 15px; box-sizing: border-box; }
        .stat-line { display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; color: #333; margin-top: 2px; }
        #next-disp { font-size: 28px; text-align: center; margin: 2px 0; }

        /* Evolution Progress Bar */
        #evo-bar { position: absolute; bottom: 70px; left: 10px; right: 10px; height: 35px; background: rgba(0,0,0,0.1); border-radius: 10px; display: flex; align-items: center; justify-content: space-around; z-index: 100; padding: 0 5px; border: 1px solid rgba(0,0,0,0.2); }
        .evo-item { font-size: 14px; opacity: 0.4; transition: 0.3s; }
        .evo-item.reached { opacity: 1; transform: scale(1.2); }

        /* Buttons */
        #ui-controls { position: absolute; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 1000; padding: 0 10px; box-sizing: border-box; }
        .btn { border: 2px solid #333; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 0 #222; transition: 0.1s; }
        .btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #222; }
        
        .pwr { width: 45px; height: 45px; font-size: 20px; }
        .pwr.active { background: white !important; color: black; border-color: white; animation: pulse 1s infinite; }
        #shop-btn { background: #3498db; padding: 0 15px; height: 45px; flex-grow: 1; }
        #help-btn { background: #95a5a6; width: 45px; height: 45px; }

        /* Modals */
        .modal { display: none; position: absolute; inset: 15px; background: white; z-index: 2000; border-radius: 20px; border: 4px solid var(--primary); padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .card { border: 2px solid #eee; padding: 8px; border-radius: 12px; text-align: center; font-size: 11px; cursor: pointer; }
        .card.active { border-color: #2ecc71; background: #f0fff4; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="header">
        <div class="stat-line">
            <span>SCORE: <span id="s-cur">0</span></span>
            <span>BEST: <span id="s-hi">0</span></span>
        </div>
        <div id="next-disp">NEXT: üçì</div>
        <div class="stat-line">
            <span>BUNDLES: $<span id="s-pts">0</span></span>
            <span id="status" style="color:var(--primary)">READY</span>
        </div>
    </div>

    <div id="evo-bar"></div>

    <div id="ui-controls">
        <button id="p-bomb" class="btn pwr" style="background:#e67e22" onclick="setPwr('bomb')">üí£</button>
        <button id="p-wipe" class="btn pwr" style="background:#9b59b6" onclick="setPwr('wipe')">üßπ</button>
        <button id="p-evo" class="btn pwr" style="background:#f1c40f" onclick="setPwr('evo')">‚ú®</button>
        <button id="shop-btn" class="btn" onclick="openMod('shop')">MARKET</button>
        <button id="help-btn" class="btn" onclick="openMod('help')">?</button>
    </div>

    <div id="shop" class="modal">
        <div style="display:flex; justify-content:space-between"><h2>Store</h2><button onclick="closeMod()">X</button></div>
        <p>Your Bundles: $<span id="m-pts">0</span></p>
        <h4>Skins ($500)</h4><div id="g-skins" class="grid"></div>
        <h4>Themes ($300)</h4><div id="g-themes" class="grid"></div>
    </div>

    <div id="help" class="modal">
        <h2>How to Play</h2>
        <p>‚Ä¢ Drop items to merge identical ones.<br>‚Ä¢ Reach the 12th fruit to win!<br>‚Ä¢ Don't stay above the red line for 3 seconds.<br>‚Ä¢ Use Bundles to buy cool skins!</p>
        <button class="btn" style="background:var(--primary); width:100%; height:45px;" onclick="closeMod()">LET'S GO</button>
    </div>

    <canvas id="canvas"></canvas>
</div>

<script>
const SKINS = {
    Fruit: ["üçí","üçì","üçá","üçä","üçé","üçê","üçë","üçç","üçà","üçâ","ü••","üéÉ"],
    Animals: ["üê≠","üê∞","ü¶ä","üêª","üêº","ü¶Å","üêØ","üê∑","üê∏","üêô","üê≥","ü¶Ñ"],
    Retro: ["‚ñ≤","‚ñ†","‚¨¢","‚óÜ","‚òÖ","‚úö","‚úñ","‚¨§","‚¨ü","‚ñº","‚¨ì","‚å¨"],
    Space: ["‚òÑÔ∏è","üõ∞Ô∏è","ü™ê","üåô","‚òÄÔ∏è","üî≠","üöÄ","üëΩ","üõ∏","üåå","üå†","üë®‚ÄçüöÄ"],
    Desserts: ["üç™","üç©","üßÅ","üç¶","üç∞","ü•ß","üç´","üç¨","üç≠","üçÆ","üçØ","üéÇ"],
    Cars: ["üèéÔ∏è","üöó","üöï","üöô","üöå","üöê","üöõ","üöú","üöì","üöë","üöí","üöÄ"],
    Plants: ["üåø","üåµ","ü™¥","üå≤","üå≥","üå¥","üéã","üåø","üçÄ","üçÑ","üåª","üåπ"]
};
const THEMES = { Lilac: "#E6E6FA", Sunset: "#ff7675", Forest: "#55efc4", Midnight: "#2d3436", Gold: "#fdcb6e", Slate: "#718093", Ocean: "#0984e3", Cherry: "#d63031", Mint: "#00b894", Grape: "#6c5ce7", Pumpkin: "#e67e22", Coffee: "#634832", Rose: "#fd79a8", Sky: "#81ecec", Grass: "#26de81", Charcoal: "#2f3640" };
const SIZES = [22, 30, 38, 48, 60, 72, 85, 100, 118, 135, 155, 180];
const COLORS = ["#ff7979", "#ffbe76", "#f6e58d", "#badc58", "#7ed6df", "#686de0", "#4834d4", "#f0932b", "#eb4d4b", "#6ab04c", "#130f40", "#222f3e"];

let state = { score: 0, high: 0, pts: 0, skin: 'Fruit', theme: 'Lilac', owned: ['Fruit', 'Lilac'], pwr: null };
let engine, render, currentIdx = 0, nextIdx = 1, lastX = 200, canDrop = true;

function save() { localStorage.setItem('fm_v50', JSON.stringify(state)); }
function load() {
    const d = localStorage.getItem('fm_v50');
    if(d) Object.assign(state, JSON.parse(d));
    document.getElementById('s-hi').innerText = state.high;
    document.getElementById('s-pts').innerText = state.pts;
    document.getElementById('game-container').style.background = THEMES[state.theme];
}

function init() {
    load();
    const canvas = document.getElementById('canvas');
    engine = Matter.Engine.create();
    render = Matter.Render.create({
        canvas: canvas,
        engine: engine,
        options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: 'transparent' }
    });

    const ground = Matter.Bodies.rectangle(window.innerWidth/2, window.innerHeight+15, window.innerWidth, 50, { isStatic: true });
    const wallL = Matter.Bodies.rectangle(-15, window.innerHeight/2, 40, window.innerHeight, { isStatic: true });
    const wallR = Matter.Bodies.rectangle(window.innerWidth+15, window.innerHeight/2, 40, window.innerHeight, { isStatic: true });
    Matter.Composite.add(engine.world, [ground, wallL, wallR]);

    Matter.Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        // Crosshair & Aim
        if(canDrop && !state.pwr) {
            ctx.strokeStyle = "rgba(0,0,0,0.15)"; ctx.lineWidth = 2; ctx.setLineDash([5,5]);
            ctx.beginPath(); ctx.moveTo(lastX, 100); ctx.lineTo(lastX, window.innerHeight); ctx.stroke();
            ctx.setLineDash([]);
            ctx.font = "40px Arial"; ctx.textAlign = "center";
            ctx.fillText(SKINS[state.skin][currentIdx], lastX, 90);
        }

        Matter.Composite.allBodies(engine.world).forEach(b => {
            if(b.plugin && b.plugin.t !== undefined) {
                ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
                ctx.fillStyle = COLORS[b.plugin.t]; ctx.beginPath(); ctx.arc(0,0,b.circleRadius,0,Math.PI*2); ctx.fill();
                ctx.font = (b.circleRadius * 1.4) + "px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(SKINS[state.skin][b.plugin.t], 0, 0); ctx.restore();

                if(!b.isStatic && b.position.y < 100) {
                    if(!b.plugin.dt) b.plugin.dt = Date.now();
                    if(Date.now() - b.plugin.dt > 3000) { alert("Game Over!"); location.reload(); }
                } else { b.plugin.dt = null; }
            }
        });
    });

    Matter.Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            const a = p.bodyA, b = p.bodyB;
            if(a.plugin && b.plugin && a.plugin.t === b.plugin.t && a.plugin.t < 11) {
                const t = a.plugin.t; Matter.Composite.remove(engine.world, [a, b]);
                const news = Matter.Bodies.circle((a.position.x+b.position.x)/2, (a.position.y+b.position.y)/2, SIZES[t+1], { plugin: {t: t+1} });
                Matter.Composite.add(engine.world, news);
                state.score += (t+1)*10; state.pts += (t+1);
                document.getElementById('s-cur').innerText = state.score;
                document.getElementById('s-pts').innerText = state.pts;
                if(state.score > state.high) { state.high = state.score; document.getElementById('s-hi').innerText = state.high; save(); }
                updateEvoBar(t+1);
            }
        });
    });

    Matter.Render.run(render);
    Matter.Runner.run(Matter.Runner.create(), engine);
    
