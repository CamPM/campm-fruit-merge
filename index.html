<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Fruit Merge Pro v1.01</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root{--bg:#f8f9fa;--bd:#343a40;--txt:#212529;--acc:#ff4757;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
*{box-sizing:border-box;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
body{margin:0;overflow:hidden;background:var(--bg);font-family:var(--font);color:var(--txt);display:flex;justify-content:center}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;display:flex;flex-direction:column;justify-content:space-between}
.top{height:140px;padding:15px;background:rgba(255,255,255,0.85);backdrop-filter:blur(8px);pointer-events:auto;border-bottom:3px solid var(--bd)}
.row{display:flex;justify-content:space-between;align-items:center}
.score{font-size:22px;font-weight:900} .lbl{font-size:10px;font-weight:700;opacity:.6;text-transform:uppercase}
.bar{display:flex;justify-content:space-between;background:rgba(0,0,0,.08);padding:6px;border-radius:20px;margin-top:10px}
.dot{width:18px;height:18px;border-radius:50%;background:#ccc;display:grid;place-items:center;font-size:10px;transition:0.3s}
.dot.on{transform:scale(1.25);box-shadow:0 0 8px currentColor}
.bot{height:100px;background:rgba(255,255,255,0.95);border-top:3px solid var(--bd);display:flex;justify-content:space-around;align-items:center;pointer-events:auto}
.btn{background:white;border:2px solid #eee;width:55px;height:55px;border-radius:15px;font-size:24px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 0 #eee}
.btn.pwr-active{background:var(--acc);color:white;border-color:var(--acc);transform:translateY(2px);box-shadow:none}
.modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:99;display:none;align-items:center;justify-content:center;pointer-events:auto}
.modal.open{display:flex}
.card{background:#fff;width:92%;max-width:450px;height:75%;border-radius:24px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,0.3)}
.shop-body{flex:1;overflow-y:auto;padding:15px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.item{border:2px solid #f0f0f0;border-radius:14px;padding:12px;text-align:center;background:#fff;transition:0.2s}
.item.eq{border-color:var(--acc);background:#fff5f5}
.cat-title{font-size:13px;font-weight:900;padding:20px 5px 10px;text-transform:uppercase;color:#888;border-bottom:1px solid #eee;grid-column:span 2}
#crosshair{position:absolute;width:60px;height:60px;border:2px dashed var(--acc);border-radius:50%;pointer-events:none;display:none;z-index:5}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="crosshair"></div>
<div id="ui">
    <div class="top">
        <div class="row">
            <div><div class="lbl">Score</div><div class="score" id="sCurrent">0</div></div>
            <div style="text-align:center"><div class="lbl">Wallet</div><div class="score" id="sWallet">ðŸ’° 0</div></div>
            <div style="text-align:right"><div class="lbl">Best</div><div class="score" id="sBest">0</div></div>
        </div>
        <div class="bar" id="prog"></div>
        <div style="text-align:center; margin-top:5px; font-weight:800; font-size:14px">Next: <span id="next"></span></div>
    </div>
    <div class="bot">
        <button class="btn" onclick="toggleStore()">ðŸ›’</button>
        <button class="btn pwr" id="btn-bomb" data-tool="bomb">ðŸ’£</button>
        <button class="btn pwr" id="btn-broom" data-tool="broom">ðŸ§¹</button>
        <button class="btn pwr" id="btn-wand" data-tool="wand">ðŸª„</button>
        <button class="btn" onclick="toggleFull()">â›¶</button>
    </div>
</div>

<div class="modal" id="m-store"><div class="card"><div style="padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><b>Premium Store</b><span onclick="toggleStore()" style="cursor:pointer;font-size:24px">Ã—</span></div><div class="shop-body" id="shop-container"></div></div></div>
<div class="modal" id="m-over"><div style="text-align:center;color:#fff"><h1>GAME OVER</h1><p>The fruit overflowed!</p><button onclick="reset()" style="padding:15px 40px;border-radius:30px;border:0;font-weight:800;cursor:pointer">RETRY</button></div></div>

<script>
const M=Matter, E=M.Engine, B=M.Bodies, C=M.Composite, Ev=M.Events, Q=M.Query, R=M.Runner;
const SKINS={'Fruit':['ðŸ’','ðŸ“','ðŸ‡','ðŸŠ','ðŸ…','ðŸŽ','ðŸ','ðŸ‘','ðŸ','ðŸˆ','ðŸ‰','ðŸ‘‘'],'Space':['ðŸŒ‘','â˜„ï¸','ðŸ›°ï¸','ðŸš€','ðŸ›¸','ðŸ‘¾','ðŸ”­','ðŸŒŒ','ðŸª','â˜€ï¸','ðŸŒ€','ðŸ‘½'],'Animals':['ðŸž','ðŸ¸','ðŸ¢','ðŸ¦†','ðŸ’','ðŸ¦‰','ðŸ§','ðŸº','ðŸ¦“','ðŸ¦','ðŸ˜','ðŸ‹'],'Weather':['ðŸ’§','â„ï¸','ðŸŒªï¸','ðŸŒˆ','â˜€ï¸','â˜ï¸','â›ˆï¸','ðŸŒ©ï¸','ðŸŒ«ï¸','ðŸŒ¤ï¸','ðŸŒ¬ï¸','â˜‚ï¸'],'Dessert':['ðŸ¬','ðŸª','ðŸ©','ðŸ«','ðŸ®','ðŸ¦','ðŸ§','ðŸ°','ðŸ¥§','ðŸ¥ž','ðŸ§‡','ðŸŽ‚'],'Shapes':['ðŸ”´','ðŸŸ ','ðŸŸ¡','ðŸŸ¢','ðŸ”µ','ðŸŸ£','ðŸŸ¤','âš«','â¬œ','ðŸŸ¦','ðŸŸ§','ðŸŸ¥'],'Music':['ðŸŽµ','ðŸŽ¶','ðŸŽ¸','ðŸŽ¹','ðŸŽº','ðŸŽ»','ðŸŽ·','ðŸ¥','ðŸŽ¤','ðŸŽ§','ðŸ“»','ðŸŽ¼'],'Plants':['ðŸŒ±','ðŸŒ¿','â˜˜ï¸','ðŸ€','ðŸŒµ','ðŸŒ´','ðŸŒ³','ðŸŒ²','ðŸ‚','ðŸ','ðŸ„','ðŸŒ¹']};
const THEMES={'Matcha':'#E8F5E9','Midnight':'#1A1B26','Lavender':'#F3E5F5','Sky':'#E1F5FE','Sunset':'#FFF3E0','Slate':'#263238','Rose':'#FCE4EC','Default':'#FDF6E3','Deep':'#0F172A','Mint':'#F0FFF4','Cream':'#FFFDD0','Gold':'#FFF9E6','Cyber':'#0D0D0D','Forest':'#1B2E1D','Ocean':'#001F3F','Plum':'#2D1B2D'};
const BORDERS={'Slate':'#657B83','Gold':'#DAA520','Red':'#DC143C','Neon':'#B026FF','Black':'#000','White':'#FFF','Cyan':'#00FFFF','Pink':'#FF69B4','Blue':'#0000FF','Green':'#00FF00','Yellow':'#FFFF00','Grey':'#888888','Orange':'#FF8C00','Silver':'#C0C0C0','Brown':'#8B4513','Transparent':'rgba(0,0,0,0.1)'};
const COLORS=['#FF4D4D','#FF85A2','#A18CD1','#FFB347','#FF5E62','#FF0844','#CEDF13','#FBD3E9','#F7971E','#56AB2F','#00B09B','#FFD700'];

let st={s:0, w:parseInt(localStorage.getItem('fm_w')||0), h:parseInt(localStorage.getItem('fm_h')||0), inv:JSON.parse(localStorage.getItem('fm_i')||'["sk_Fruit","ot_def","th_Default","bd_Slate"]'), 
    eq:JSON.parse(localStorage.getItem('fm_e')||'{"sk":"Fruit","ot":"def","th":"Default","bd":"Slate"}'), next:0, drag:0, x:0, y:0, drop:1, over:0, tool:null, max:-1, aud:null, hov:null};

const cv=document.getElementById('c'), cx=cv.getContext('2d'), eng=E.create({positionIterations:10});
let W, H, boxW, boxH, offsetX, offsetY, runner;

function rsz(){
    W=window.innerWidth; H=window.innerHeight;
    cv.width=W*devicePixelRatio; cv.height=H*devicePixelRatio;
    cx.scale(devicePixelRatio,devicePixelRatio);
    boxW = Math.min(W - 20, 500);
    boxH = H - 240; 
    offsetX = (W - boxW)/2;
    offsetY = 140;
    C.clear(eng.world,0,1);
    const t=100;
    const g=B.rectangle(W/2, offsetY+boxH+t/2, W, t, {isStatic:1, friction:0.5, label:'floor'});
    const lw=B.rectangle(offsetX-t/2, H/2, t, H*2, {isStatic:1});
    const rw=B.rectangle(offsetX+boxW+t/2, H/2, t, H*2, {isStatic:1});
    C.add(eng.world,[g,lw,rw]);
}
window.onresize=rsz; rsz();
runner = R.run(eng);

function tone(f,t,d){ 
    if(!st.aud) st.aud=new(window.AudioContext||window.webkitAudioContext)(); 
    if(st.aud.state==='suspended') st.aud.resume();
    const o=st.aud.createOscillator(), g=st.aud.createGain(); 
    o.type=t; o.frequency.setValueAtTime(f,st.aud.currentTime); 
    g.gain.setValueAtTime(0.1,st.aud.currentTime); 
    g.gain.exponentialRampToValueAtTime(0.01,st.aud.currentTime+d); 
    o.connect(g); g.connect(st.aud.destination); o.start(); o.stop(st.aud.currentTime+d); 
}

Ev.on(eng,'collisionStart',e=>{
    e.pairs.forEach(p=>{
        const a=p.bodyA, b=p.bodyB;
        if(a.tier!==undefined && b.tier!==undefined && a.tier===b.tier && a.tier<11){
            const n=a.tier+1, pos={x:(a.position.x+b.position.x)/2, y:(a.position.y+b.position.y)/2};
            C.remove(eng.world,[a,b]);
            const nb=B.circle(pos.x,pos.y,10+(n*6),{restitution:0.4, friction:0.1}); nb.tier=n; C.add(eng.world,nb);
            tone(200+n*40,'sine',0.3); updSc((n+1)*15); updPrg(n);
        }
    });
});

function loop(){
    cx.clearRect(0,0,W,H);
    // Draw Play Area
    cx.fillStyle = THEMES[st.eq.th]; cx.fillRect(offsetX, offsetY, boxW, boxH);
    cx.strokeStyle = BORDERS[st.eq.bd]; cx.lineWidth = 10; cx.strokeRect(offsetX, offsetY, boxW, boxH);
    
    const dl = offsetY + (boxH * 0.2); // 20% Death Line
    cx.beginPath(); cx.moveTo(offsetX, dl); cx.lineTo(offsetX+boxW, dl); cx.setLineDash([8,8]); cx.strokeStyle='#ff4757'; cx.lineWidth=2; cx.stroke(); cx.setLineDash([]);

    const bodies = C.allBodies(eng.world);
    let violator = false;

    bodies.forEach(b=>{
        if(b.isStatic || b.tier===undefined) return;
        const r=b.circleRadius;
        
        // Game Over Logic
        if(b.position.y - r < dl && Math.abs(b.velocity.y) < 0.2){
            if(!b.tm) b.tm=Date.now();
            if(Date.now()-b.tm > 2000) violator = true;
        } else b.tm = null;

        cx.translate(b.position.x, b.position.y); cx.rotate(b.angle);
        
        // Tier Glow
        cx.beginPath();
        let g = cx.createRadialGradient(0,0,0,0,0,r*1.2);
        g.addColorStop(0, COLORS[b.tier]+'66'); g.addColorStop(1, 'transparent');
        cx.fillStyle = g; cx.arc(0,0,r*1.2,0,Math.PI*2); cx.fill();

        // Body
        cx.fillStyle='#fff'; cx.beginPath(); cx.arc(0,0,r,0,Math.PI*2); cx.fill();
        
        // Outline Logic
        cx.lineWidth = 2;
        if(st.eq.ot==='rainbow'){
            cx.strokeStyle = `hsl(${Date.now()/10 % 360}, 70%, 50%)`;
        } else {
            cx.strokeStyle = st.eq.ot==='def'?'#0002':(st.eq.ot==='wht'?'#fff':'#000');
        }
        cx.stroke();

        // Emoji
        cx.font=`${r*1.3}px serif`; cx.textAlign='center'; cx.textBaseline='middle';
        cx.fillText(SKINS[st.eq.sk][b.tier],0,0);
        
        // Highlight if targeted by powerup
        if(st.hov === b){
            cx.strokeStyle = 'gold'; cx.lineWidth = 4; cx.stroke();
        }

        cx.rotate(-b.angle); cx.translate(-b.position.x, -b.position.y);
    });

    if(st.drag && st.drop && !st.tool){
        let gx=Math.max(offsetX+20, Math.min(offsetX+boxW-20, st.x));
        cx.font="30px serif"; cx.globalAlpha=0.4; cx.fillText(SKINS[st.eq.sk][st.next], gx, offsetY - 30); cx.globalAlpha=1;
        cx.beginPath(); cx.strokeStyle="#ccc"; cx.setLineDash([5,5]); cx.moveTo(gx, offsetY-10); cx.lineTo(gx, offsetY+boxH); cx.stroke(); cx.setLineDash([]);
    }

    if(st.tool && st.drag){
        const ch = document.getElementById('crosshair');
        ch.style.display = 'block'; ch.style.left = (st.x - 30)+'px'; ch.style.top = (st.y - 30)+'px';
    } else { document.getElementById('crosshair').style.display = 'none'; }

    if(violator && !st.over) over();
    if(!st.over) requestAnimationFrame(loop);
}

// Input Controllers
window.addEventListener('pointerdown', e => {
    if(e.target.closest('.bot') || e.target.closest('.modal')) return;
    st.drag = 1; st.x = e.clientX; st.y = e.clientY;
    if(!st.aud) tone(0,'sine',0); // Unlock audio
});

window.addEventListener('pointermove', e => {
    st.x = e.clientX; st.y = e.clientY;
    if(st.tool){
        let hits = Q.point(C.allBodies(eng.world), {x:st.x, y:st.y});
        st.hov = hits.find(b => b.tier !== undefined);
    }
});

window.addEventListener('pointerup', e => {
    if(st.tool && st.drag){
        let bs = C.allBodies(eng.world).filter(b=>!b.isStatic);
        if(st.tool==='bomb'){
            tone(100,'triangle',0.5);
            C.remove(eng.world, bs.filter(b => M.Vector.magnitude(M.Vector.sub(b.position,{x:st.x,y:st.y})) < 90));
        } else if(st.hov){
            if(st.tool==='broom'){
                tone(400,'sawtooth',0.3);
                C.remove(eng.world, bs.filter(b=>b.tier===st.hov.tier));
            } else if(st.tool==='wand' && st.hov.tier < 11){
                tone(600,'sine',0.4);
                let t=st.hov.tier, p=st.hov.position; C.remove(eng.world, st.hov);
                let nb=B.circle(p.x, p.y, 10+((t+1)*6), {restitution:0.4}); nb.tier=t+1; C.add(eng.world, nb);
            }
        }
        st.tool = null; st.hov = null;
        document.querySelectorAll('.pwr').forEach(b=>b.classList.remove('pwr-active'));
    } else if(st.drag && st.drop){
        const r = 10 + (st.next*6);
        const bx = Math.max(offsetX+r, Math.min(offsetX+boxW-r, st.x));
        const b = B.circle(bx, offsetY + 20, r, {restitution:0.4, friction:0.1});
        b.tier = st.next; C.add(eng.world, b);
        st.next = Math.floor(Math.random()*4); updPre();
        st.drop=0; setTimeout(()=>st.drop=1, 500);
    }
    st.drag = 0;
});

document.querySelectorAll('.pwr').forEach(btn => {
    btn.addEventListener('pointerdown', e => {
        st.tool = btn.dataset.tool;
        btn.classList.add('pwr-active');
        st.drag = 1;
        e.stopPropagation();
    });
});

function updSc(n){ st.s+=n; st.w+=Math.floor(n/2); document.getElementById('sCurrent').innerText=st.s; document.getElementById('sWallet').innerText='ðŸ’° '+st.w; if(st.s>st.h){st.h=st.s; document.getElementById('sBest').innerText=st.h;} save(); }
function updPre(){ document.getElementById('next').innerText = SKINS[st.eq.sk][st.next]; }
function updPrg(t){ if(t>st.max){st.max=t; renderPrg();}}
function renderPrg(){ const d=document.getElementById('prog'); d.innerHTML=''; for(let i=0;i<12;i++) d.innerHTML+=`<div class="dot ${i<=st.max?'on':''}" style="color:${COLORS[i]}">${i<=st.max?SKINS[st.eq.sk][i]:''}</div>`; }
function save(){ localStorage.setItem('fm_i',JSON.stringify(st.inv)); localStorage.setItem('fm_e',JSON.stringify(st.eq)); localStorage.setItem('fm_h',st.h); localStorage.setItem('fm_w',st.w); }
function toggleStore(){ document.getElementById('m-store').classList.toggle('open'); if(document.getElementById('m-store').classList.contains('open')) renderShop(); }
function over(){ st.over=1; tone(50,'sawtooth',1); document.getElementById('m-over').classList.add('open'); }
function reset(){ location.reload(); }
function toggleFull(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

function renderShop(){
    const container = document.getElementById('shop-container'); 
    container.innerHTML='<div class="grid" id="sg"></div>'; 
    const g=document.getElementById('sg');
    const categories = [
        {name:'Skins', data:Object.keys(SKINS), p:500, k:'sk'},
        {name:'Outlines', data:[{n:'Soft',v:'def',p:0},{n:'White',v:'wht',p:2000},{n:'Black',v:'blk',p:2000},{n:'Rainbow',v:'rainbow',p:2000}], k:'ot'},
        {name:'Themes', data:Object.keys(THEMES), p:300, k:'th'},
        {name:'Borders', data:Object.keys(BORDERS), p:200, k:'bd'}
    ];
    
    categories.forEach(cat => {
        g.innerHTML += `<div class="cat-title">${cat.name}</div>`;
        cat.data.forEach(entry => {
            const val = entry.v || entry;
            const name = entry.n || entry;
            const price = entry.p !== undefined ? entry.p : cat.p;
            const id = cat.k + '_' + val;
            const own = st.inv.includes(id);
            const eq = st.eq[cat.k] === val;
            
            const div = document.createElement('div');
            div.className = `item ${eq?'eq':''}`;
            div.innerHTML = `<b>${name}</b><br><small>${own?'OWNED':'$'+price}</small>`;
            div.onclick = () => {
                if(own){ st.eq[cat.k] = val; }
                else if(st.w >= price){ st.w -= price; st.inv.push(id); st.eq[cat.k] = val; }
                save(); renderShop(); updPre(); renderPrg(); document.getElementById('sWallet').innerText='ðŸ’° '+st.w;
            };
            g.appendChild(div);
        });
    });
}

// Start
document.getElementById('sBest').innerText = st.h;
updPre(); renderPrg(); loop();
</script>
</body>
</html>
